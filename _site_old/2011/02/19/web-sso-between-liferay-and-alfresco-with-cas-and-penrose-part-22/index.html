<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Web-SSO between Liferay and Alfresco with CAS and Penrose (part 2/2) | Holistic Security</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Web-SSO between Liferay and Alfresco with CAS and Penrose (part 2/2)" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="The aims are to do authentication and web-sso between liferay and alfresco using CAS. In this blog post we will explain how to configure Alfresco to enable LDAP authentication and users syncronization, also we will explain how to configure CAS Authentication Filter to do Web-SSO with automatic/transparent login. Firstly, we will follow this technical design for authentication and sso. [caption id=”” align=”alignnone” width=”461” caption=”Authentication and SSO architectura”] [/caption] Requirements Virtual Directory Server (Penrose server 2.0) and CAS-server (tested with version 3.3.5)I will use existing CentOS VirtualBox VM with CAS and Penrose Server pre-configured (Virtual Directory/LDAP) named “directorysrv1” of last blog post (Web-SSO between Liferay and Alfresco with CAS and Penrose (part 1/2)) but with a few changes: [sourcecode language=”text” gutter=”true” wraplines=”false”] A sample DN: uid=480838,ou=Employees,dc=intix,dc=info cn=aamodwroclawski [/sourcecode] You can download this new Penrose partition here. [caption id=”” align=”alignnone” width=”483” caption=”LDAP tree”][/caption] Alfresco 3.4c CE:We are using a new WinXP VirtualBox VM with Alfresco and MySQL installed named “alfr01”. Liferay 6.0.5 with LDAP and CAS enabled:We are using a WinXP VirtualBox VM with Liferay 6.0.5 CE installed named “lfry01”. See before post here. [caption id=”” align=”alignnone” width=”400” caption=”LDAP and CAS configuration in Liferay”] | —|— | [/caption] CAS-client (3.1.10) I. Enable LDAP Authentication and LDAP users import in Alfresco To do Web-SSO is not necessary this step, but i recommend to do it because you can do users management from Alfresco Admin Console (Browser/Explorer or Share) (edit, delete, to do groups and give permissions). 1. Create the following folders in “\subsystems\Authentication\ldap\ldap1” in ﻿${ALF_HOME}\tomcat\shared\classes\alfresco\extension 2. Copy the file ﻿${ALF_HOME}\tomcat\webapps\alfresco\WEB-INF\classes\alfresco\subsystems\Authentication\ldap\﻿ldap-authentication.properties in the folder before created. 3. Modify ldap-authentication.properties enabling LDAP authN and sync. For example, you can use my file (This only works for my LDAP tree with UID as RDN and authN with CN. See my LDAP tree): [sourcecode language=”text” gutter=”true” wraplines=”false”] ﻿# This flag enables use of this LDAP subsystem for authentication. It may be that this subsytem should only be used for synchronization, in which case this flag should be set to false. ldap.authentication.active=true # This properties file brings together the common options for LDAP authentication rather than editing the bean definitions # ldap.authentication.allowGuestLogin=true How to map the user id entered by the user to that passed through to LDAP - simple - this must be a DN and would be something like uid=%s,ou=People,dc=company,dc=com - digest - usually pass through what is entered %s If not set, an LDAP query involving ldap.synchronization.personQuery and ldap.synchronization.userIdAttributeName will be performed to resolve the DN dynamically. This allows directories to be structured and doesn’t require the user ID to appear in the DN. intix: always search DN by RDN attribute, in my case uid (see ldap tree) ldap.authentication.userNameFormat=cn=%s,ou=Employees,dc=intix,dc=info intix: this config is better than above, because i want to searh by CN. It is necessary set ldap.synchronization.personQuery=inetOrgPerson and ldap.synchronization.userIdAttributeName=cn ldap.authentication.userNameFormat= The LDAP context factory to use ldap.authentication.java.naming.factory.initial=com.sun.jndi.ldap.LdapCtxFactory The URL to connect to the LDAP server ldap.authentication.java.naming.provider.url=ldap://directorysrv1:10389 The authentication mechanism to use for password validation ldap.authentication.java.naming.security.authentication=simple Escape commas entered by the user at bind time Useful when using simple authentication and the CN is part of the DN and contains commas ldap.authentication.escapeCommasInBind=false Escape commas entered by the user when setting the authenticated user Useful when using simple authentication and the CN is part of the DN and contains commas, and the escaped \, is pulled in as part of an LDAP sync If this option is set to true it will break the default home folder provider as space names can not contain \ ldap.authentication.escapeCommasInUid=false Comma separated list of user names who should be considered administrators by default intix: administration user (CN) when ldap authN is enabled. The “admin” user is valid when alfrescoNtlm authN is enabled. ldap.authentication.defaultAdministratorUserNames=aamodwroclawski This flag enables use of this LDAP subsystem for user and group synchronization. It may be that this subsytem should only be used for authentication, in which case this flag should be set to false. ldap.synchronization.active=true The authentication mechanism to use for synchronization ldap.synchronization.java.naming.security.authentication=simple The default principal to use (only used for LDAP sync) ldap.synchronization.java.naming.security.principal=uid=admin,ou=system The password for the default principal (only used for LDAP sync) ldap.synchronization.java.naming.security.credentials=secret If positive, this property indicates that RFC 2696 paged results should be used to split query results into batches of the specified size. This overcomes any size limits imposed by the LDAP server. ldap.synchronization.queryBatchSize=0 If positive, this property indicates that range retrieval should be used to fetch multi-valued attributes (such as member) in batches of the specified size. Overcomes any size limits imposed by Active Directory. ldap.synchronization.attributeBatchSize=0 The query to select all objects that represent the groups to import. ldap.synchronization.groupQuery=(objectclass=groupOfNames) ldap.synchronization.groupQuery=(objectclass=groupOfUniqueNames) The query to select objects that represent the groups to import that have changed since a certain time. ldap.synchronization.groupDifferentialQuery=(&amp;(objectclass=groupOfNames)(!(modifyTimestamp&lt;={0}))) ldap.synchronization.groupDifferentialQuery=(&amp;(objectclass=groupOfUniqueNames)(!(modifyTimestamp&lt;={0}))) The query to select all objects that represent the users to import. ldap.synchronization.personQuery=(objectclass=inetOrgPerson) The query to select objects that represent the users to import that have changed since a certain time. ldap.synchronization.personDifferentialQuery=(&amp;(objectclass=inetOrgPerson)(!(modifyTimestamp&lt;={0}))) The group search base restricts the LDAP group query to a sub section of tree on the LDAP server. ldap.synchronization.groupSearchBase=ou=Groups,dc=intix,dc=info The user search base restricts the LDAP user query to a sub section of tree on the LDAP server. ldap.synchronization.userSearchBase=ou=Employees,dc=intix,dc=info The name of the operational attribute recording the last update time for a group or user. ldap.synchronization.modifyTimestampAttributeName=modifyTimestamp The timestamp format. Unfortunately, this varies between directory servers. ldap.synchronization.timestampFormat=yyyyMMddHHmmss’Z’ The attribute name on people objects found in LDAP to use as the uid in Alfresco ldap.synchronization.userIdAttributeName=uid intix: CN is necessary to authN by this attribute when searching LDAP ldap.synchronization.userIdAttributeName=cn The attribute on person objects in LDAP to map to the first name property in Alfresco ldap.synchronization.userFirstNameAttributeName=givenName The attribute on person objects in LDAP to map to the last name property in Alfresco ldap.synchronization.userLastNameAttributeName=sn The attribute on person objects in LDAP to map to the email property in Alfresco ldap.synchronization.userEmailAttributeName=mail The attribute on person objects in LDAP to map to the organizational id property in Alfresco ldap.synchronization.userOrganizationalIdAttributeName=o The default home folder provider to use for people created via LDAP import ldap.synchronization.defaultHomeFolderProvider=userHomesHomeFolderProvider The attribute on LDAP group objects to map to the authority name property in Alfresco ldap.synchronization.groupIdAttributeName=cn The attribute on LDAP group objects to map to the authority display name property in Alfresco ldap.synchronization.groupDisplayNameAttributeName=description The group type in LDAP ldap.synchronization.groupType=groupOfNames ldap.synchronization.groupType=groupOfUniqueNames The person type in LDAP ldap.synchronization.personType=inetOrgPerson The attribute in LDAP on group objects that defines the DN for its members ldap.synchronization.groupMemberAttributeName=member ldap.synchronization.groupMemberAttributeName=uniqueMember If true progress estimation is enabled. When enabled, the user query has to be run twice in order to count entries. ldap.synchronization.enableProgressEstimation=true [/sourcecode] 4. Re-start Alfresco. 5. Check LDAP authN and import of users in Alfresco. [caption id=”” align=”alignnone” width=”517” caption=”Imported users from LDAP tree in Alfresco”][/caption] II. Configure CAS in Alfresco We are setting up Alfresco so that when someone log into Alfresco it is redirected to CAS for authentication. Through the CAS filter, Alfresco catchs any request to access and these are redirected to CAS-login. When you has successfully authenticated with CAS, after you will be redirected to the My Alfresco Dashboard, then Alfresco will need to retrieve the values of session which is placed there by the CAS Filter. If you want to do SSO and automatic redirection when login to Alfresco Explorer after authentication in CAS, you should create a CAS Authentication Filter as Aksels Architecture Blog show us here and test with version 3.4c. To do this you have to create/modify the Java code (CasAuthenticationFilter.java) that is executed when enter to Alfresco page. 1. Edit the alfresco web.xml to modify Authentication Filter and to add the CAS filters. [sourcecode language=”text” gutter=”true” wraplines=”false”] ﻿c:&gt;notepad++ C:\1bpms-demo\alfr34c_1\tomcat\webapps\alfresco\WEB-INF\web.xml [/sourcecode] … modify web.xml [sourcecode language=”xml” gutter=”true” wraplines=”false”] […] ﻿ rootPath /app:company_home &lt;/context-param&gt; &lt;!–filter&gt; Authentication Filter Authentication filter mapped only to faces URLs. Other URLs generally use proprietary means to talk to the AuthenticationComponent org.alfresco.repo.web.filter.beans.BeanProxyFilter beanName AuthenticationFilter &lt;/filter--&gt; Authentication Filter INTIX - Authentication Filter org.jasig.cas.client.authentication.AuthenticationFilter casServerLoginUrl https://directorysrv1:8443/cas-server-webapp-3.3.5/login serverName http://alfr01:8080 Global Authentication Filter Authentication filter mapped to all authenticated URLs. Mainly for SSO support org.alfresco.repo.web.filter.beans.BeanProxyFilter beanName GlobalAuthenticationFilter […] ﻿ ﻿ CAS Validation Filter org.jasig.cas.client.validation.Cas20ProxyReceivingTicketValidationFilter casServerUrlPrefix https://directorysrv1:8443/cas-server-webapp-3.3.5 serverName http://alfr01:8080 Alfresco CAS Authentication Filter info.intix.alfresco.CasAuthenticationFilter Authentication Filter /faces/* CAS Validation Filter /faces/* Alfresco CAS Authentication Filter /faces/* Authentication Filter /navigate/* CAS Validation Filter /navigate/* Alfresco CAS Authentication Filter /navigate/* Authentication Filter /command/* CAS Validation Filter /command/* Alfresco CAS Authentication Filter /command/* Authentication Filter /download/* CAS Validation Filter /download/* Alfresco CAS Authentication Filter /download/* Authentication Filter /template/* CAS Validation Filter /template/* Alfresco CAS Authentication Filter /template/* Authentication Filter /n/* CAS Validation Filter /n/* Alfresco CAS Authentication Filter /n/* Authentication Filter /c/* CAS Validation Filter /c/* Alfresco CAS Authentication Filter /c/* Authentication Filter /t/* CAS Validation Filter /t/* Alfresco CAS Authentication Filter /t/* Authentication Filter /d/* CAS Validation Filter /d/* Alfresco CAS Authentication Filter /d/* Global Localization Filter /* […] ﻿ Global Authentication Filter /faces/* &lt;/filter-mapping&gt; &lt;!–filter-mapping&gt; Authentication Filter /faces/* &lt;/filter-mapping--&gt; WebDAV Authentication Filter /webdav/* […] [/sourcecode] 2. Copy the CAS client jar file into the alfresco webapp lib folder. [sourcecode language=”text” gutter=”true” wraplines=”false”] ﻿c:&gt; c:&gt;copy C:\0share1\cas-client-core-3.1.10.jar C:\1bpms-demo\alfr34c_1\tomcat\webapps\alfresco\WEB-INF\lib\cas-client-core-3.1.10.jar 1 archivos copiados. c:&gt; [/sourcecode] 3. Modify and compile CasAuthenticationFilter.java (http://akselsarchitecture.googlegroups.com/web/CasAuthenticationFilter-Alfresco.java) and copy .jar into the alfresco webapp lib folder. [sourcecode language=”text” gutter=”true” wraplines=”false”] ﻿c:&gt; c:&gt;copy C:\0share1\www.intix.info-casauthnfilter-0.1.jar c:\1bpms-demo\alfr34c_1\tomcat\webapps\alfresco\WEB-INF\lib\www.intix.info-casauthnfilter-0.1.jar 1 archivos copiados. c:&gt; [/sourcecode] You can download my www.intix.info-casauthnfilter-0.1.jar file from here. 4. Re-start Alfresco. 5. Test CAS configuration. Try opening an Alfresco’s page, for example: http://alfr01:8080/alfresco in a browser. You should be redirected to the CAS login page, and when you log in (for example with aamodwroclawski/test) you should be redirected back to the My Alfresco Dashboard. 6. If you have get this error (see figure below) is because you have not installed the CAS root SSL Cert as a trusted certificate in Alfresco (JRE’s cacert store). Alfresco 3.4c CE has JRE’s cacert store in ${ALF_HOME}/java/jre/lib/sec, then install the certificate there. [caption id=”” align=”alignnone” width=”468” caption=”CAS server SSL certificate no installed in Alfresco”][/caption] To solve it, you should import CAS server SSL public certificate in the JRE’s cacerts where Alfresco is running, in my case I have Alfresco running in WinXP box called “alfr01″. [sourcecode language=”text” gutter=”true” wraplines=”false”] c:&gt;keytool -import -alias tomcat -file c:\0share1\directorysrv1_730days.crt -keystore C:\1bpms-demo\alf34c_1\java\jre\lib\sec y\cacerts Enter keystore password: Owner: CN=directorysrv1, OU=”INTIX I+D”, O=INTIX.info, L=BARCELONA, ST=CATALUNYA, C=ES Issuer: CN=directorysrv1, OU=”INTIX I+D”, O=INTIX.info, L=BARCELONA, ST=CATALUNYA, C=ES Serial number: 4d1df9bc Valid from: Fri Dec 31 16:41:48 GMT+01:00 2010 until: Sun Dec 30 16:41:48 GMT+01:00 2012 Certificate fingerprints: MD5: 11:4D:72:BB:80:42:EE:F7:4A:CA:E9:EA:F6:4F:86:8D SHA1: 7F:6B:12:64:31:8B:47:4E:11:33:D7:FE:EF:C6:D4:65:12:59:8D:2E Signature algorithm name: SHA1withRSA Version: 3 Trust this certificate? [no]: yes Certificate was added to keystore [/sourcecode] III. Tuning Authentication in Alfresco Right now, we have configured Alfresco and CAS, where the user management can be done syncronizing or importing users stored in LDAP tree. We can do user, groups and roles management via Alfresco LDAP subsystem and Authentication-SSO via EXTERNAL subsystem. To do this, we must modify the file alfresco-global.properties. [sourcecode language=”text” gutter=”true” wraplines=”false”] […] ﻿### authentication.chain=alfrescoNtlm1:alfrescoNtlm,ldap1:ldap ﻿authentication.chain=external1:external,ldap1:ldap [/sourcecode] IV. Test Web Single Sign On between Liferay 6.0.5 CE and Alfresco 3.4.c CE Open a browser with http://alfr01:8080/alfresco, you get redirected to CAS-login page. Enter aamodwroclawski/test, then you should be redirected to Alfresco My Dashboard page (authenticated). In this time you should see Logout (aamodwroclawski) in the top right of the Alfresco page indicating that you have sucessfully logged in. [caption id=”” align=”alignnone” width=”476” caption=”User properly authenticated in Alfresco”][/caption] Then, open other browser with http://lfry01:8080/intixportal/user/aamodwroclawski, you get redirected to Liferay private and authenticated page for the user “aamodwroclawski”. [caption id=”” align=”alignnone” width=”442” caption=”The same user authenticated and with SSO in Liferay”][/caption] In other direction (Liferay to Alfresco) it does work too. V. Conclusions 1. Authentication and users sync in Alfresco 3.4c does work with authentication subsystem LDAP. 2. SSO with CAS in Alfresco 3.4c does work by enabling authentication subsystem EXTERNAL. 3. There is an issue when importing users from LDAP tree in Liferay. The passwords are created with random value and no with “test”. END References: 1. CAS in Alfresco http://wiki.alfresco.com/wiki/Central_Authentication_Service_Configuration 2. CAS SSO for Alfresco 3.3 and Share http://akselsarchitecture.blogspot.com/2010/09/cas-sso-for-alfresco-33-and-share.html" />
<meta property="og:description" content="The aims are to do authentication and web-sso between liferay and alfresco using CAS. In this blog post we will explain how to configure Alfresco to enable LDAP authentication and users syncronization, also we will explain how to configure CAS Authentication Filter to do Web-SSO with automatic/transparent login. Firstly, we will follow this technical design for authentication and sso. [caption id=”” align=”alignnone” width=”461” caption=”Authentication and SSO architectura”] [/caption] Requirements Virtual Directory Server (Penrose server 2.0) and CAS-server (tested with version 3.3.5)I will use existing CentOS VirtualBox VM with CAS and Penrose Server pre-configured (Virtual Directory/LDAP) named “directorysrv1” of last blog post (Web-SSO between Liferay and Alfresco with CAS and Penrose (part 1/2)) but with a few changes: [sourcecode language=”text” gutter=”true” wraplines=”false”] A sample DN: uid=480838,ou=Employees,dc=intix,dc=info cn=aamodwroclawski [/sourcecode] You can download this new Penrose partition here. [caption id=”” align=”alignnone” width=”483” caption=”LDAP tree”][/caption] Alfresco 3.4c CE:We are using a new WinXP VirtualBox VM with Alfresco and MySQL installed named “alfr01”. Liferay 6.0.5 with LDAP and CAS enabled:We are using a WinXP VirtualBox VM with Liferay 6.0.5 CE installed named “lfry01”. See before post here. [caption id=”” align=”alignnone” width=”400” caption=”LDAP and CAS configuration in Liferay”] | —|— | [/caption] CAS-client (3.1.10) I. Enable LDAP Authentication and LDAP users import in Alfresco To do Web-SSO is not necessary this step, but i recommend to do it because you can do users management from Alfresco Admin Console (Browser/Explorer or Share) (edit, delete, to do groups and give permissions). 1. Create the following folders in “\subsystems\Authentication\ldap\ldap1” in ﻿${ALF_HOME}\tomcat\shared\classes\alfresco\extension 2. Copy the file ﻿${ALF_HOME}\tomcat\webapps\alfresco\WEB-INF\classes\alfresco\subsystems\Authentication\ldap\﻿ldap-authentication.properties in the folder before created. 3. Modify ldap-authentication.properties enabling LDAP authN and sync. For example, you can use my file (This only works for my LDAP tree with UID as RDN and authN with CN. See my LDAP tree): [sourcecode language=”text” gutter=”true” wraplines=”false”] ﻿# This flag enables use of this LDAP subsystem for authentication. It may be that this subsytem should only be used for synchronization, in which case this flag should be set to false. ldap.authentication.active=true # This properties file brings together the common options for LDAP authentication rather than editing the bean definitions # ldap.authentication.allowGuestLogin=true How to map the user id entered by the user to that passed through to LDAP - simple - this must be a DN and would be something like uid=%s,ou=People,dc=company,dc=com - digest - usually pass through what is entered %s If not set, an LDAP query involving ldap.synchronization.personQuery and ldap.synchronization.userIdAttributeName will be performed to resolve the DN dynamically. This allows directories to be structured and doesn’t require the user ID to appear in the DN. intix: always search DN by RDN attribute, in my case uid (see ldap tree) ldap.authentication.userNameFormat=cn=%s,ou=Employees,dc=intix,dc=info intix: this config is better than above, because i want to searh by CN. It is necessary set ldap.synchronization.personQuery=inetOrgPerson and ldap.synchronization.userIdAttributeName=cn ldap.authentication.userNameFormat= The LDAP context factory to use ldap.authentication.java.naming.factory.initial=com.sun.jndi.ldap.LdapCtxFactory The URL to connect to the LDAP server ldap.authentication.java.naming.provider.url=ldap://directorysrv1:10389 The authentication mechanism to use for password validation ldap.authentication.java.naming.security.authentication=simple Escape commas entered by the user at bind time Useful when using simple authentication and the CN is part of the DN and contains commas ldap.authentication.escapeCommasInBind=false Escape commas entered by the user when setting the authenticated user Useful when using simple authentication and the CN is part of the DN and contains commas, and the escaped \, is pulled in as part of an LDAP sync If this option is set to true it will break the default home folder provider as space names can not contain \ ldap.authentication.escapeCommasInUid=false Comma separated list of user names who should be considered administrators by default intix: administration user (CN) when ldap authN is enabled. The “admin” user is valid when alfrescoNtlm authN is enabled. ldap.authentication.defaultAdministratorUserNames=aamodwroclawski This flag enables use of this LDAP subsystem for user and group synchronization. It may be that this subsytem should only be used for authentication, in which case this flag should be set to false. ldap.synchronization.active=true The authentication mechanism to use for synchronization ldap.synchronization.java.naming.security.authentication=simple The default principal to use (only used for LDAP sync) ldap.synchronization.java.naming.security.principal=uid=admin,ou=system The password for the default principal (only used for LDAP sync) ldap.synchronization.java.naming.security.credentials=secret If positive, this property indicates that RFC 2696 paged results should be used to split query results into batches of the specified size. This overcomes any size limits imposed by the LDAP server. ldap.synchronization.queryBatchSize=0 If positive, this property indicates that range retrieval should be used to fetch multi-valued attributes (such as member) in batches of the specified size. Overcomes any size limits imposed by Active Directory. ldap.synchronization.attributeBatchSize=0 The query to select all objects that represent the groups to import. ldap.synchronization.groupQuery=(objectclass=groupOfNames) ldap.synchronization.groupQuery=(objectclass=groupOfUniqueNames) The query to select objects that represent the groups to import that have changed since a certain time. ldap.synchronization.groupDifferentialQuery=(&amp;(objectclass=groupOfNames)(!(modifyTimestamp&lt;={0}))) ldap.synchronization.groupDifferentialQuery=(&amp;(objectclass=groupOfUniqueNames)(!(modifyTimestamp&lt;={0}))) The query to select all objects that represent the users to import. ldap.synchronization.personQuery=(objectclass=inetOrgPerson) The query to select objects that represent the users to import that have changed since a certain time. ldap.synchronization.personDifferentialQuery=(&amp;(objectclass=inetOrgPerson)(!(modifyTimestamp&lt;={0}))) The group search base restricts the LDAP group query to a sub section of tree on the LDAP server. ldap.synchronization.groupSearchBase=ou=Groups,dc=intix,dc=info The user search base restricts the LDAP user query to a sub section of tree on the LDAP server. ldap.synchronization.userSearchBase=ou=Employees,dc=intix,dc=info The name of the operational attribute recording the last update time for a group or user. ldap.synchronization.modifyTimestampAttributeName=modifyTimestamp The timestamp format. Unfortunately, this varies between directory servers. ldap.synchronization.timestampFormat=yyyyMMddHHmmss’Z’ The attribute name on people objects found in LDAP to use as the uid in Alfresco ldap.synchronization.userIdAttributeName=uid intix: CN is necessary to authN by this attribute when searching LDAP ldap.synchronization.userIdAttributeName=cn The attribute on person objects in LDAP to map to the first name property in Alfresco ldap.synchronization.userFirstNameAttributeName=givenName The attribute on person objects in LDAP to map to the last name property in Alfresco ldap.synchronization.userLastNameAttributeName=sn The attribute on person objects in LDAP to map to the email property in Alfresco ldap.synchronization.userEmailAttributeName=mail The attribute on person objects in LDAP to map to the organizational id property in Alfresco ldap.synchronization.userOrganizationalIdAttributeName=o The default home folder provider to use for people created via LDAP import ldap.synchronization.defaultHomeFolderProvider=userHomesHomeFolderProvider The attribute on LDAP group objects to map to the authority name property in Alfresco ldap.synchronization.groupIdAttributeName=cn The attribute on LDAP group objects to map to the authority display name property in Alfresco ldap.synchronization.groupDisplayNameAttributeName=description The group type in LDAP ldap.synchronization.groupType=groupOfNames ldap.synchronization.groupType=groupOfUniqueNames The person type in LDAP ldap.synchronization.personType=inetOrgPerson The attribute in LDAP on group objects that defines the DN for its members ldap.synchronization.groupMemberAttributeName=member ldap.synchronization.groupMemberAttributeName=uniqueMember If true progress estimation is enabled. When enabled, the user query has to be run twice in order to count entries. ldap.synchronization.enableProgressEstimation=true [/sourcecode] 4. Re-start Alfresco. 5. Check LDAP authN and import of users in Alfresco. [caption id=”” align=”alignnone” width=”517” caption=”Imported users from LDAP tree in Alfresco”][/caption] II. Configure CAS in Alfresco We are setting up Alfresco so that when someone log into Alfresco it is redirected to CAS for authentication. Through the CAS filter, Alfresco catchs any request to access and these are redirected to CAS-login. When you has successfully authenticated with CAS, after you will be redirected to the My Alfresco Dashboard, then Alfresco will need to retrieve the values of session which is placed there by the CAS Filter. If you want to do SSO and automatic redirection when login to Alfresco Explorer after authentication in CAS, you should create a CAS Authentication Filter as Aksels Architecture Blog show us here and test with version 3.4c. To do this you have to create/modify the Java code (CasAuthenticationFilter.java) that is executed when enter to Alfresco page. 1. Edit the alfresco web.xml to modify Authentication Filter and to add the CAS filters. [sourcecode language=”text” gutter=”true” wraplines=”false”] ﻿c:&gt;notepad++ C:\1bpms-demo\alfr34c_1\tomcat\webapps\alfresco\WEB-INF\web.xml [/sourcecode] … modify web.xml [sourcecode language=”xml” gutter=”true” wraplines=”false”] […] ﻿ rootPath /app:company_home &lt;/context-param&gt; &lt;!–filter&gt; Authentication Filter Authentication filter mapped only to faces URLs. Other URLs generally use proprietary means to talk to the AuthenticationComponent org.alfresco.repo.web.filter.beans.BeanProxyFilter beanName AuthenticationFilter &lt;/filter--&gt; Authentication Filter INTIX - Authentication Filter org.jasig.cas.client.authentication.AuthenticationFilter casServerLoginUrl https://directorysrv1:8443/cas-server-webapp-3.3.5/login serverName http://alfr01:8080 Global Authentication Filter Authentication filter mapped to all authenticated URLs. Mainly for SSO support org.alfresco.repo.web.filter.beans.BeanProxyFilter beanName GlobalAuthenticationFilter […] ﻿ ﻿ CAS Validation Filter org.jasig.cas.client.validation.Cas20ProxyReceivingTicketValidationFilter casServerUrlPrefix https://directorysrv1:8443/cas-server-webapp-3.3.5 serverName http://alfr01:8080 Alfresco CAS Authentication Filter info.intix.alfresco.CasAuthenticationFilter Authentication Filter /faces/* CAS Validation Filter /faces/* Alfresco CAS Authentication Filter /faces/* Authentication Filter /navigate/* CAS Validation Filter /navigate/* Alfresco CAS Authentication Filter /navigate/* Authentication Filter /command/* CAS Validation Filter /command/* Alfresco CAS Authentication Filter /command/* Authentication Filter /download/* CAS Validation Filter /download/* Alfresco CAS Authentication Filter /download/* Authentication Filter /template/* CAS Validation Filter /template/* Alfresco CAS Authentication Filter /template/* Authentication Filter /n/* CAS Validation Filter /n/* Alfresco CAS Authentication Filter /n/* Authentication Filter /c/* CAS Validation Filter /c/* Alfresco CAS Authentication Filter /c/* Authentication Filter /t/* CAS Validation Filter /t/* Alfresco CAS Authentication Filter /t/* Authentication Filter /d/* CAS Validation Filter /d/* Alfresco CAS Authentication Filter /d/* Global Localization Filter /* […] ﻿ Global Authentication Filter /faces/* &lt;/filter-mapping&gt; &lt;!–filter-mapping&gt; Authentication Filter /faces/* &lt;/filter-mapping--&gt; WebDAV Authentication Filter /webdav/* […] [/sourcecode] 2. Copy the CAS client jar file into the alfresco webapp lib folder. [sourcecode language=”text” gutter=”true” wraplines=”false”] ﻿c:&gt; c:&gt;copy C:\0share1\cas-client-core-3.1.10.jar C:\1bpms-demo\alfr34c_1\tomcat\webapps\alfresco\WEB-INF\lib\cas-client-core-3.1.10.jar 1 archivos copiados. c:&gt; [/sourcecode] 3. Modify and compile CasAuthenticationFilter.java (http://akselsarchitecture.googlegroups.com/web/CasAuthenticationFilter-Alfresco.java) and copy .jar into the alfresco webapp lib folder. [sourcecode language=”text” gutter=”true” wraplines=”false”] ﻿c:&gt; c:&gt;copy C:\0share1\www.intix.info-casauthnfilter-0.1.jar c:\1bpms-demo\alfr34c_1\tomcat\webapps\alfresco\WEB-INF\lib\www.intix.info-casauthnfilter-0.1.jar 1 archivos copiados. c:&gt; [/sourcecode] You can download my www.intix.info-casauthnfilter-0.1.jar file from here. 4. Re-start Alfresco. 5. Test CAS configuration. Try opening an Alfresco’s page, for example: http://alfr01:8080/alfresco in a browser. You should be redirected to the CAS login page, and when you log in (for example with aamodwroclawski/test) you should be redirected back to the My Alfresco Dashboard. 6. If you have get this error (see figure below) is because you have not installed the CAS root SSL Cert as a trusted certificate in Alfresco (JRE’s cacert store). Alfresco 3.4c CE has JRE’s cacert store in ${ALF_HOME}/java/jre/lib/sec, then install the certificate there. [caption id=”” align=”alignnone” width=”468” caption=”CAS server SSL certificate no installed in Alfresco”][/caption] To solve it, you should import CAS server SSL public certificate in the JRE’s cacerts where Alfresco is running, in my case I have Alfresco running in WinXP box called “alfr01″. [sourcecode language=”text” gutter=”true” wraplines=”false”] c:&gt;keytool -import -alias tomcat -file c:\0share1\directorysrv1_730days.crt -keystore C:\1bpms-demo\alf34c_1\java\jre\lib\sec y\cacerts Enter keystore password: Owner: CN=directorysrv1, OU=”INTIX I+D”, O=INTIX.info, L=BARCELONA, ST=CATALUNYA, C=ES Issuer: CN=directorysrv1, OU=”INTIX I+D”, O=INTIX.info, L=BARCELONA, ST=CATALUNYA, C=ES Serial number: 4d1df9bc Valid from: Fri Dec 31 16:41:48 GMT+01:00 2010 until: Sun Dec 30 16:41:48 GMT+01:00 2012 Certificate fingerprints: MD5: 11:4D:72:BB:80:42:EE:F7:4A:CA:E9:EA:F6:4F:86:8D SHA1: 7F:6B:12:64:31:8B:47:4E:11:33:D7:FE:EF:C6:D4:65:12:59:8D:2E Signature algorithm name: SHA1withRSA Version: 3 Trust this certificate? [no]: yes Certificate was added to keystore [/sourcecode] III. Tuning Authentication in Alfresco Right now, we have configured Alfresco and CAS, where the user management can be done syncronizing or importing users stored in LDAP tree. We can do user, groups and roles management via Alfresco LDAP subsystem and Authentication-SSO via EXTERNAL subsystem. To do this, we must modify the file alfresco-global.properties. [sourcecode language=”text” gutter=”true” wraplines=”false”] […] ﻿### authentication.chain=alfrescoNtlm1:alfrescoNtlm,ldap1:ldap ﻿authentication.chain=external1:external,ldap1:ldap [/sourcecode] IV. Test Web Single Sign On between Liferay 6.0.5 CE and Alfresco 3.4.c CE Open a browser with http://alfr01:8080/alfresco, you get redirected to CAS-login page. Enter aamodwroclawski/test, then you should be redirected to Alfresco My Dashboard page (authenticated). In this time you should see Logout (aamodwroclawski) in the top right of the Alfresco page indicating that you have sucessfully logged in. [caption id=”” align=”alignnone” width=”476” caption=”User properly authenticated in Alfresco”][/caption] Then, open other browser with http://lfry01:8080/intixportal/user/aamodwroclawski, you get redirected to Liferay private and authenticated page for the user “aamodwroclawski”. [caption id=”” align=”alignnone” width=”442” caption=”The same user authenticated and with SSO in Liferay”][/caption] In other direction (Liferay to Alfresco) it does work too. V. Conclusions 1. Authentication and users sync in Alfresco 3.4c does work with authentication subsystem LDAP. 2. SSO with CAS in Alfresco 3.4c does work by enabling authentication subsystem EXTERNAL. 3. There is an issue when importing users from LDAP tree in Liferay. The passwords are created with random value and no with “test”. END References: 1. CAS in Alfresco http://wiki.alfresco.com/wiki/Central_Authentication_Service_Configuration 2. CAS SSO for Alfresco 3.3 and Share http://akselsarchitecture.blogspot.com/2010/09/cas-sso-for-alfresco-33-and-share.html" />
<link rel="canonical" href="https://holisticsecurity.io/2011/02/19/web-sso-between-liferay-and-alfresco-with-cas-and-penrose-part-22/" />
<meta property="og:url" content="https://holisticsecurity.io/2011/02/19/web-sso-between-liferay-and-alfresco-with-cas-and-penrose-part-22/" />
<meta property="og:site_name" content="Holistic Security" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2011-02-19T23:45:14+01:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://holisticsecurity.io/2011/02/19/web-sso-between-liferay-and-alfresco-with-cas-and-penrose-part-22/"},"url":"https://holisticsecurity.io/2011/02/19/web-sso-between-liferay-and-alfresco-with-cas-and-penrose-part-22/","headline":"Web-SSO between Liferay and Alfresco with CAS and Penrose (part 2/2)","dateModified":"2011-02-19T23:45:14+01:00","datePublished":"2011-02-19T23:45:14+01:00","description":"The aims are to do authentication and web-sso between liferay and alfresco using CAS. In this blog post we will explain how to configure Alfresco to enable LDAP authentication and users syncronization, also we will explain how to configure CAS Authentication Filter to do Web-SSO with automatic/transparent login. Firstly, we will follow this technical design for authentication and sso. [caption id=”” align=”alignnone” width=”461” caption=”Authentication and SSO architectura”] [/caption] Requirements Virtual Directory Server (Penrose server 2.0) and CAS-server (tested with version 3.3.5)I will use existing CentOS VirtualBox VM with CAS and Penrose Server pre-configured (Virtual Directory/LDAP) named “directorysrv1” of last blog post (Web-SSO between Liferay and Alfresco with CAS and Penrose (part 1/2)) but with a few changes: [sourcecode language=”text” gutter=”true” wraplines=”false”] A sample DN: uid=480838,ou=Employees,dc=intix,dc=info cn=aamodwroclawski [/sourcecode] You can download this new Penrose partition here. [caption id=”” align=”alignnone” width=”483” caption=”LDAP tree”][/caption] Alfresco 3.4c CE:We are using a new WinXP VirtualBox VM with Alfresco and MySQL installed named “alfr01”. Liferay 6.0.5 with LDAP and CAS enabled:We are using a WinXP VirtualBox VM with Liferay 6.0.5 CE installed named “lfry01”. See before post here. [caption id=”” align=”alignnone” width=”400” caption=”LDAP and CAS configuration in Liferay”] | —|— | [/caption] CAS-client (3.1.10) I. Enable LDAP Authentication and LDAP users import in Alfresco To do Web-SSO is not necessary this step, but i recommend to do it because you can do users management from Alfresco Admin Console (Browser/Explorer or Share) (edit, delete, to do groups and give permissions). 1. Create the following folders in “\\subsystems\\Authentication\\ldap\\ldap1” in ﻿${ALF_HOME}\\tomcat\\shared\\classes\\alfresco\\extension 2. Copy the file ﻿${ALF_HOME}\\tomcat\\webapps\\alfresco\\WEB-INF\\classes\\alfresco\\subsystems\\Authentication\\ldap\\﻿ldap-authentication.properties in the folder before created. 3. Modify ldap-authentication.properties enabling LDAP authN and sync. For example, you can use my file (This only works for my LDAP tree with UID as RDN and authN with CN. See my LDAP tree): [sourcecode language=”text” gutter=”true” wraplines=”false”] ﻿# This flag enables use of this LDAP subsystem for authentication. It may be that this subsytem should only be used for synchronization, in which case this flag should be set to false. ldap.authentication.active=true # This properties file brings together the common options for LDAP authentication rather than editing the bean definitions # ldap.authentication.allowGuestLogin=true How to map the user id entered by the user to that passed through to LDAP - simple - this must be a DN and would be something like uid=%s,ou=People,dc=company,dc=com - digest - usually pass through what is entered %s If not set, an LDAP query involving ldap.synchronization.personQuery and ldap.synchronization.userIdAttributeName will be performed to resolve the DN dynamically. This allows directories to be structured and doesn’t require the user ID to appear in the DN. intix: always search DN by RDN attribute, in my case uid (see ldap tree) ldap.authentication.userNameFormat=cn=%s,ou=Employees,dc=intix,dc=info intix: this config is better than above, because i want to searh by CN. It is necessary set ldap.synchronization.personQuery=inetOrgPerson and ldap.synchronization.userIdAttributeName=cn ldap.authentication.userNameFormat= The LDAP context factory to use ldap.authentication.java.naming.factory.initial=com.sun.jndi.ldap.LdapCtxFactory The URL to connect to the LDAP server ldap.authentication.java.naming.provider.url=ldap://directorysrv1:10389 The authentication mechanism to use for password validation ldap.authentication.java.naming.security.authentication=simple Escape commas entered by the user at bind time Useful when using simple authentication and the CN is part of the DN and contains commas ldap.authentication.escapeCommasInBind=false Escape commas entered by the user when setting the authenticated user Useful when using simple authentication and the CN is part of the DN and contains commas, and the escaped \\, is pulled in as part of an LDAP sync If this option is set to true it will break the default home folder provider as space names can not contain \\ ldap.authentication.escapeCommasInUid=false Comma separated list of user names who should be considered administrators by default intix: administration user (CN) when ldap authN is enabled. The “admin” user is valid when alfrescoNtlm authN is enabled. ldap.authentication.defaultAdministratorUserNames=aamodwroclawski This flag enables use of this LDAP subsystem for user and group synchronization. It may be that this subsytem should only be used for authentication, in which case this flag should be set to false. ldap.synchronization.active=true The authentication mechanism to use for synchronization ldap.synchronization.java.naming.security.authentication=simple The default principal to use (only used for LDAP sync) ldap.synchronization.java.naming.security.principal=uid=admin,ou=system The password for the default principal (only used for LDAP sync) ldap.synchronization.java.naming.security.credentials=secret If positive, this property indicates that RFC 2696 paged results should be used to split query results into batches of the specified size. This overcomes any size limits imposed by the LDAP server. ldap.synchronization.queryBatchSize=0 If positive, this property indicates that range retrieval should be used to fetch multi-valued attributes (such as member) in batches of the specified size. Overcomes any size limits imposed by Active Directory. ldap.synchronization.attributeBatchSize=0 The query to select all objects that represent the groups to import. ldap.synchronization.groupQuery=(objectclass=groupOfNames) ldap.synchronization.groupQuery=(objectclass=groupOfUniqueNames) The query to select objects that represent the groups to import that have changed since a certain time. ldap.synchronization.groupDifferentialQuery=(&amp;(objectclass=groupOfNames)(!(modifyTimestamp&lt;={0}))) ldap.synchronization.groupDifferentialQuery=(&amp;(objectclass=groupOfUniqueNames)(!(modifyTimestamp&lt;={0}))) The query to select all objects that represent the users to import. ldap.synchronization.personQuery=(objectclass=inetOrgPerson) The query to select objects that represent the users to import that have changed since a certain time. ldap.synchronization.personDifferentialQuery=(&amp;(objectclass=inetOrgPerson)(!(modifyTimestamp&lt;={0}))) The group search base restricts the LDAP group query to a sub section of tree on the LDAP server. ldap.synchronization.groupSearchBase=ou=Groups,dc=intix,dc=info The user search base restricts the LDAP user query to a sub section of tree on the LDAP server. ldap.synchronization.userSearchBase=ou=Employees,dc=intix,dc=info The name of the operational attribute recording the last update time for a group or user. ldap.synchronization.modifyTimestampAttributeName=modifyTimestamp The timestamp format. Unfortunately, this varies between directory servers. ldap.synchronization.timestampFormat=yyyyMMddHHmmss’Z’ The attribute name on people objects found in LDAP to use as the uid in Alfresco ldap.synchronization.userIdAttributeName=uid intix: CN is necessary to authN by this attribute when searching LDAP ldap.synchronization.userIdAttributeName=cn The attribute on person objects in LDAP to map to the first name property in Alfresco ldap.synchronization.userFirstNameAttributeName=givenName The attribute on person objects in LDAP to map to the last name property in Alfresco ldap.synchronization.userLastNameAttributeName=sn The attribute on person objects in LDAP to map to the email property in Alfresco ldap.synchronization.userEmailAttributeName=mail The attribute on person objects in LDAP to map to the organizational id property in Alfresco ldap.synchronization.userOrganizationalIdAttributeName=o The default home folder provider to use for people created via LDAP import ldap.synchronization.defaultHomeFolderProvider=userHomesHomeFolderProvider The attribute on LDAP group objects to map to the authority name property in Alfresco ldap.synchronization.groupIdAttributeName=cn The attribute on LDAP group objects to map to the authority display name property in Alfresco ldap.synchronization.groupDisplayNameAttributeName=description The group type in LDAP ldap.synchronization.groupType=groupOfNames ldap.synchronization.groupType=groupOfUniqueNames The person type in LDAP ldap.synchronization.personType=inetOrgPerson The attribute in LDAP on group objects that defines the DN for its members ldap.synchronization.groupMemberAttributeName=member ldap.synchronization.groupMemberAttributeName=uniqueMember If true progress estimation is enabled. When enabled, the user query has to be run twice in order to count entries. ldap.synchronization.enableProgressEstimation=true [/sourcecode] 4. Re-start Alfresco. 5. Check LDAP authN and import of users in Alfresco. [caption id=”” align=”alignnone” width=”517” caption=”Imported users from LDAP tree in Alfresco”][/caption] II. Configure CAS in Alfresco We are setting up Alfresco so that when someone log into Alfresco it is redirected to CAS for authentication. Through the CAS filter, Alfresco catchs any request to access and these are redirected to CAS-login. When you has successfully authenticated with CAS, after you will be redirected to the My Alfresco Dashboard, then Alfresco will need to retrieve the values of session which is placed there by the CAS Filter. If you want to do SSO and automatic redirection when login to Alfresco Explorer after authentication in CAS, you should create a CAS Authentication Filter as Aksels Architecture Blog show us here and test with version 3.4c. To do this you have to create/modify the Java code (CasAuthenticationFilter.java) that is executed when enter to Alfresco page. 1. Edit the alfresco web.xml to modify Authentication Filter and to add the CAS filters. [sourcecode language=”text” gutter=”true” wraplines=”false”] ﻿c:&gt;notepad++ C:\\1bpms-demo\\alfr34c_1\\tomcat\\webapps\\alfresco\\WEB-INF\\web.xml [/sourcecode] … modify web.xml [sourcecode language=”xml” gutter=”true” wraplines=”false”] […] ﻿ rootPath /app:company_home &lt;/context-param&gt; &lt;!–filter&gt; Authentication Filter Authentication filter mapped only to faces URLs. Other URLs generally use proprietary means to talk to the AuthenticationComponent org.alfresco.repo.web.filter.beans.BeanProxyFilter beanName AuthenticationFilter &lt;/filter--&gt; Authentication Filter INTIX - Authentication Filter org.jasig.cas.client.authentication.AuthenticationFilter casServerLoginUrl https://directorysrv1:8443/cas-server-webapp-3.3.5/login serverName http://alfr01:8080 Global Authentication Filter Authentication filter mapped to all authenticated URLs. Mainly for SSO support org.alfresco.repo.web.filter.beans.BeanProxyFilter beanName GlobalAuthenticationFilter […] ﻿ ﻿ CAS Validation Filter org.jasig.cas.client.validation.Cas20ProxyReceivingTicketValidationFilter casServerUrlPrefix https://directorysrv1:8443/cas-server-webapp-3.3.5 serverName http://alfr01:8080 Alfresco CAS Authentication Filter info.intix.alfresco.CasAuthenticationFilter Authentication Filter /faces/* CAS Validation Filter /faces/* Alfresco CAS Authentication Filter /faces/* Authentication Filter /navigate/* CAS Validation Filter /navigate/* Alfresco CAS Authentication Filter /navigate/* Authentication Filter /command/* CAS Validation Filter /command/* Alfresco CAS Authentication Filter /command/* Authentication Filter /download/* CAS Validation Filter /download/* Alfresco CAS Authentication Filter /download/* Authentication Filter /template/* CAS Validation Filter /template/* Alfresco CAS Authentication Filter /template/* Authentication Filter /n/* CAS Validation Filter /n/* Alfresco CAS Authentication Filter /n/* Authentication Filter /c/* CAS Validation Filter /c/* Alfresco CAS Authentication Filter /c/* Authentication Filter /t/* CAS Validation Filter /t/* Alfresco CAS Authentication Filter /t/* Authentication Filter /d/* CAS Validation Filter /d/* Alfresco CAS Authentication Filter /d/* Global Localization Filter /* […] ﻿ Global Authentication Filter /faces/* &lt;/filter-mapping&gt; &lt;!–filter-mapping&gt; Authentication Filter /faces/* &lt;/filter-mapping--&gt; WebDAV Authentication Filter /webdav/* […] [/sourcecode] 2. Copy the CAS client jar file into the alfresco webapp lib folder. [sourcecode language=”text” gutter=”true” wraplines=”false”] ﻿c:&gt; c:&gt;copy C:\\0share1\\cas-client-core-3.1.10.jar C:\\1bpms-demo\\alfr34c_1\\tomcat\\webapps\\alfresco\\WEB-INF\\lib\\cas-client-core-3.1.10.jar 1 archivos copiados. c:&gt; [/sourcecode] 3. Modify and compile CasAuthenticationFilter.java (http://akselsarchitecture.googlegroups.com/web/CasAuthenticationFilter-Alfresco.java) and copy .jar into the alfresco webapp lib folder. [sourcecode language=”text” gutter=”true” wraplines=”false”] ﻿c:&gt; c:&gt;copy C:\\0share1\\www.intix.info-casauthnfilter-0.1.jar c:\\1bpms-demo\\alfr34c_1\\tomcat\\webapps\\alfresco\\WEB-INF\\lib\\www.intix.info-casauthnfilter-0.1.jar 1 archivos copiados. c:&gt; [/sourcecode] You can download my www.intix.info-casauthnfilter-0.1.jar file from here. 4. Re-start Alfresco. 5. Test CAS configuration. Try opening an Alfresco’s page, for example: http://alfr01:8080/alfresco in a browser. You should be redirected to the CAS login page, and when you log in (for example with aamodwroclawski/test) you should be redirected back to the My Alfresco Dashboard. 6. If you have get this error (see figure below) is because you have not installed the CAS root SSL Cert as a trusted certificate in Alfresco (JRE’s cacert store). Alfresco 3.4c CE has JRE’s cacert store in ${ALF_HOME}/java/jre/lib/sec, then install the certificate there. [caption id=”” align=”alignnone” width=”468” caption=”CAS server SSL certificate no installed in Alfresco”][/caption] To solve it, you should import CAS server SSL public certificate in the JRE’s cacerts where Alfresco is running, in my case I have Alfresco running in WinXP box called “alfr01″. [sourcecode language=”text” gutter=”true” wraplines=”false”] c:&gt;keytool -import -alias tomcat -file c:\\0share1\\directorysrv1_730days.crt -keystore C:\\1bpms-demo\\alf34c_1\\java\\jre\\lib\\sec y\\cacerts Enter keystore password: Owner: CN=directorysrv1, OU=”INTIX I+D”, O=INTIX.info, L=BARCELONA, ST=CATALUNYA, C=ES Issuer: CN=directorysrv1, OU=”INTIX I+D”, O=INTIX.info, L=BARCELONA, ST=CATALUNYA, C=ES Serial number: 4d1df9bc Valid from: Fri Dec 31 16:41:48 GMT+01:00 2010 until: Sun Dec 30 16:41:48 GMT+01:00 2012 Certificate fingerprints: MD5: 11:4D:72:BB:80:42:EE:F7:4A:CA:E9:EA:F6:4F:86:8D SHA1: 7F:6B:12:64:31:8B:47:4E:11:33:D7:FE:EF:C6:D4:65:12:59:8D:2E Signature algorithm name: SHA1withRSA Version: 3 Trust this certificate? [no]: yes Certificate was added to keystore [/sourcecode] III. Tuning Authentication in Alfresco Right now, we have configured Alfresco and CAS, where the user management can be done syncronizing or importing users stored in LDAP tree. We can do user, groups and roles management via Alfresco LDAP subsystem and Authentication-SSO via EXTERNAL subsystem. To do this, we must modify the file alfresco-global.properties. [sourcecode language=”text” gutter=”true” wraplines=”false”] […] ﻿### authentication.chain=alfrescoNtlm1:alfrescoNtlm,ldap1:ldap ﻿authentication.chain=external1:external,ldap1:ldap [/sourcecode] IV. Test Web Single Sign On between Liferay 6.0.5 CE and Alfresco 3.4.c CE Open a browser with http://alfr01:8080/alfresco, you get redirected to CAS-login page. Enter aamodwroclawski/test, then you should be redirected to Alfresco My Dashboard page (authenticated). In this time you should see Logout (aamodwroclawski) in the top right of the Alfresco page indicating that you have sucessfully logged in. [caption id=”” align=”alignnone” width=”476” caption=”User properly authenticated in Alfresco”][/caption] Then, open other browser with http://lfry01:8080/intixportal/user/aamodwroclawski, you get redirected to Liferay private and authenticated page for the user “aamodwroclawski”. [caption id=”” align=”alignnone” width=”442” caption=”The same user authenticated and with SSO in Liferay”][/caption] In other direction (Liferay to Alfresco) it does work too. V. Conclusions 1. Authentication and users sync in Alfresco 3.4c does work with authentication subsystem LDAP. 2. SSO with CAS in Alfresco 3.4c does work by enabling authentication subsystem EXTERNAL. 3. There is an issue when importing users from LDAP tree in Liferay. The passwords are created with random value and no with “test”. END References: 1. CAS in Alfresco http://wiki.alfresco.com/wiki/Central_Authentication_Service_Configuration 2. CAS SSO for Alfresco 3.3 and Share http://akselsarchitecture.blogspot.com/2010/09/cas-sso-for-alfresco-33-and-share.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://holisticsecurity.io/feed.xml" title="Holistic Security" /><script>
if(!(window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1")) {
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-156433649-1', 'auto');
  ga('send', 'pageview');
}
</script>
  
</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/"><img src="/assets/img/logo-holosec.png" width="100" /> Holistic Security</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/">Home</a><a class="page-link" href="/blog/">Blog</a><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Web-SSO between Liferay and Alfresco with CAS and Penrose (part 2/2)</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2011-02-19T23:45:14+01:00" itemprop="datePublished">Feb 19, 2011 
      </time>&sim; ECM · PORTAL
      &sim; ALFRESCO · LDAP · LIFERAY · SSO
    </p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>The aims are to do authentication and web-sso between liferay and alfresco using CAS.<br />
In this blog post we will explain how to configure Alfresco to enable LDAP authentication and users syncronization, also we will explain how to configure CAS Authentication Filter to do Web-SSO with automatic/transparent login.
Firstly, we will follow this technical design for authentication and sso.</p>

<p>[caption id=”” align=”alignnone” width=”461” caption=”Authentication and SSO architectura”]<img src="/assets/sso_alfr_lfry-00-architectura.png" alt="Authentication and SSO architectura between Liferay, Alfresco and CAS" /></p>

<p>[/caption]</p>

<h2 id="requirements">Requirements</h2>
<ol>
  <li>Virtual Directory Server (Penrose server 2.0) and CAS-server (tested with version 3.3.5)I will use existing CentOS VirtualBox VM with CAS and Penrose Server pre-configured (Virtual Directory/LDAP) named “directorysrv1” of last blog post (<a href="http://holisticsecurity.wordpress.com/2011/01/15/sso-liferay-alfresco-cas-penrose-part-12">Web-SSO between Liferay and Alfresco with CAS and Penrose (part 1/2)</a>) but with a few changes: [sourcecode language=”text” gutter=”true” wraplines=”false”]<br />
A sample DN:<br />
uid=480838,ou=Employees,dc=intix,dc=info<br />
cn=aamodwroclawski</li>
</ol>

<p>[/sourcecode]
You can download this new Penrose partition <a href="http://dl.dropbox.com/u/2961879/blog20110215_sso_alfresco_liferay_2/intix_info_liferay.zip">here</a>.</p>

<p>[caption id=”” align=”alignnone” width=”483” caption=”LDAP tree”]<img src="/assets/sso_alfr_lfry-00-LDAP-DN.png" alt="LDAP tree" />[/caption]</p>
<ol>
  <li>Alfresco 3.4c CE:We are using a new WinXP VirtualBox VM with Alfresco and MySQL installed named “alfr01”.</li>
  <li>Liferay 6.0.5 with LDAP and CAS enabled:We are using a WinXP VirtualBox VM with Liferay 6.0.5 CE installed named “lfry01”. See before post <a href="http://holisticsecurity.wordpress.com/2011/01/15/sso-liferay-alfresco-cas-penrose-part-12">here</a>.</li>
</ol>

<p>[caption id=”” align=”alignnone” width=”400”<br />
caption=”LDAP and CAS configuration in Liferay”]</p>

<p><img src="/assets/sso_alfr_lfry-00-ldap1.png" alt="1" /><br />
|</p>

<p><img src="/assets/sso_alfr_lfry-00-ldap2.png" alt="2" /><br />
—|—</p>

<p><img src="/assets/sso_alfr_lfry-00-ldap3.png" alt="3" /><br />
|</p>

<p><img src="/assets/sso_alfr_lfry-00-ldap4.png" alt="4" /></p>

<p><img src="/assets/sso_alfr_lfry-00-ldap5cas.png" alt="5" /></p>

<p>[/caption]</p>
<ol>
  <li>CAS-client (3.1.10)</li>
</ol>

<h2 id="i-enable-ldap-authentication-and-ldap-users-import-in-alfresco">I. Enable LDAP Authentication and LDAP users import in Alfresco</h2>

<p>To do Web-SSO is not necessary this step, but i recommend to do it because you can do users management from Alfresco Admin Console (Browser/Explorer or Share) (edit, delete, to do groups and give permissions).
1. Create the following folders in “\subsystems\Authentication\ldap\ldap1” in ﻿${ALF_HOME}\tomcat\shared\classes\alfresco\extension
2. Copy the file ﻿${ALF_HOME}\tomcat\webapps\alfresco\WEB-INF\classes\alfresco\subsystems\Authentication\ldap\﻿ldap-authentication.properties in the folder before created.
3. Modify ldap-authentication.properties enabling LDAP authN and sync. For example, you can use my file (This only works for my LDAP tree with UID as RDN and authN with CN. See my LDAP tree):</p>

<p>[sourcecode language=”text” gutter=”true” wraplines=”false”]<br />
﻿# This flag enables use of this LDAP subsystem for authentication. It may be</p>

<h1 id="that-this-subsytem-should-only-be-used-for-synchronization-in-which-case">that this subsytem should only be used for synchronization, in which case</h1>

<h1 id="this-flag-should-be-set-to-false">this flag should be set to false.</h1>
<p>ldap.authentication.active=true</p>

<p>#</p>

<h1 id="this-properties-file-brings-together-the-common-options-for-ldap-authentication-rather-than-editing-the-bean-definitions">This properties file brings together the common options for LDAP authentication rather than editing the bean definitions</h1>

<p>#</p>

<p>ldap.authentication.allowGuestLogin=true</p>

<h1 id="how-to-map-the-user-id-entered-by-the-user-to-that-passed-through-to-ldap">How to map the user id entered by the user to that passed through to LDAP</h1>

<h1 id="--simple">- simple</h1>

<h1 id="--this-must-be-a-dn-and-would-be-something-like">- this must be a DN and would be something like</h1>

<h1 id="uidsoupeopledccompanydccom">uid=%s,ou=People,dc=company,dc=com</h1>

<h1 id="--digest">- digest</h1>

<h1 id="--usually-pass-through-what-is-entered">- usually pass through what is entered</h1>

<h1 id="s">%s</h1>

<h1 id="if-not-set-an-ldap-query-involving-ldapsynchronizationpersonquery-and-ldapsynchronizationuseridattributename-will">If not set, an LDAP query involving ldap.synchronization.personQuery and ldap.synchronization.userIdAttributeName will</h1>

<h1 id="be-performed-to-resolve-the-dn-dynamically-this-allows-directories-to-be-structured-and-doesnt-require-the-user-id-to">be performed to resolve the DN dynamically. This allows directories to be structured and doesn’t require the user ID to</h1>

<h1 id="appear-in-the-dn">appear in the DN.</h1>

<h3 id="intix-always-search-dn-by-rdn-attribute-in-my-case-uid-see-ldap-tree">intix: always search DN by RDN attribute, in my case uid (see ldap tree)</h3>

<h3 id="ldapauthenticationusernameformatcnsouemployeesdcintixdcinfo">ldap.authentication.userNameFormat=cn=%s,ou=Employees,dc=intix,dc=info</h3>

<h3 id="intix-this-config-is-better-than-above-because-i-want-to-searh-by-cn">intix: this config is better than above, because i want to searh by CN.</h3>

<h3 id="it-is-necessary-set-ldapsynchronizationpersonqueryinetorgperson-and-ldapsynchronizationuseridattributenamecn">It is necessary set ldap.synchronization.personQuery=inetOrgPerson and ldap.synchronization.userIdAttributeName=cn</h3>
<p>ldap.authentication.userNameFormat=</p>

<h1 id="the-ldap-context-factory-to-use">The LDAP context factory to use</h1>

<p>ldap.authentication.java.naming.factory.initial=com.sun.jndi.ldap.LdapCtxFactory</p>

<h1 id="the-url-to-connect-to-the-ldap-server">The URL to connect to the LDAP server</h1>

<p>ldap.authentication.java.naming.provider.url=ldap://directorysrv1:10389</p>

<h1 id="the-authentication-mechanism-to-use-for-password-validation">The authentication mechanism to use for password validation</h1>

<p>ldap.authentication.java.naming.security.authentication=simple</p>

<h1 id="escape-commas-entered-by-the-user-at-bind-time">Escape commas entered by the user at bind time</h1>

<h1 id="useful-when-using-simple-authentication-and-the-cn-is-part-of-the-dn-and-contains-commas">Useful when using simple authentication and the CN is part of the DN and contains commas</h1>
<p>ldap.authentication.escapeCommasInBind=false</p>

<h1 id="escape-commas-entered-by-the-user-when-setting-the-authenticated-user">Escape commas entered by the user when setting the authenticated user</h1>

<h1 id="useful-when-using-simple-authentication-and-the-cn-is-part-of-the-dn-and-contains-commas-and-the-escaped--is">Useful when using simple authentication and the CN is part of the DN and contains commas, and the escaped \, is</h1>

<h1 id="pulled-in-as-part-of-an-ldap-sync">pulled in as part of an LDAP sync</h1>

<h1 id="if-this-option-is-set-to-true-it-will-break-the-default-home-folder-provider-as-space-names-can-not-contain-">If this option is set to true it will break the default home folder provider as space names can not contain \</h1>
<p>ldap.authentication.escapeCommasInUid=false</p>

<h1 id="comma-separated-list-of-user-names-who-should-be-considered-administrators-by-default">Comma separated list of user names who should be considered administrators by default</h1>

<h3 id="intix-administration-user-cn-when-ldap-authn-is-enabled">intix: administration user (CN) when ldap authN is enabled.</h3>

<h3 id="the-admin-user-is-valid-when-alfrescontlm-authn-is-enabled">The “admin” user is valid when alfrescoNtlm authN is enabled.</h3>

<p>ldap.authentication.defaultAdministratorUserNames=aamodwroclawski</p>

<h1 id="this-flag-enables-use-of-this-ldap-subsystem-for-user-and-group">This flag enables use of this LDAP subsystem for user and group</h1>

<h1 id="synchronization-it-may-be-that-this-subsytem-should-only-be-used-for">synchronization. It may be that this subsytem should only be used for</h1>

<h1 id="authentication-in-which-case-this-flag-should-be-set-to-false">authentication, in which case this flag should be set to false.</h1>

<p>ldap.synchronization.active=true</p>

<h1 id="the-authentication-mechanism-to-use-for-synchronization">The authentication mechanism to use for synchronization</h1>

<p>ldap.synchronization.java.naming.security.authentication=simple</p>

<h1 id="the-default-principal-to-use-only-used-for-ldap-sync">The default principal to use (only used for LDAP sync)</h1>

<p>ldap.synchronization.java.naming.security.principal=uid=admin,ou=system</p>

<h1 id="the-password-for-the-default-principal-only-used-for-ldap-sync">The password for the default principal (only used for LDAP sync)</h1>

<p>ldap.synchronization.java.naming.security.credentials=secret</p>

<h1 id="if-positive-this-property-indicates-that-rfc-2696-paged-results-should-be">If positive, this property indicates that RFC 2696 paged results should be</h1>

<h1 id="used-to-split-query-results-into-batches-of-the-specified-size-this">used to split query results into batches of the specified size. This</h1>

<h1 id="overcomes-any-size-limits-imposed-by-the-ldap-server">overcomes any size limits imposed by the LDAP server.</h1>

<p>ldap.synchronization.queryBatchSize=0</p>

<h1 id="if-positive-this-property-indicates-that-range-retrieval-should-be-used-to-fetch">If positive, this property indicates that range retrieval should be used to fetch</h1>

<h1 id="multi-valued-attributes-such-as-member-in-batches-of-the-specified-size">multi-valued attributes (such as member) in batches of the specified size.</h1>

<h1 id="overcomes-any-size-limits-imposed-by-active-directory">Overcomes any size limits imposed by Active Directory.</h1>

<p>ldap.synchronization.attributeBatchSize=0</p>

<h1 id="the-query-to-select-all-objects-that-represent-the-groups-to-import">The query to select all objects that represent the groups to import.</h1>

<h3 id="ldapsynchronizationgroupqueryobjectclassgroupofnames">ldap.synchronization.groupQuery=(objectclass=groupOfNames)</h3>
<p>ldap.synchronization.groupQuery=(objectclass=groupOfUniqueNames)</p>

<h1 id="the-query-to-select-objects-that-represent-the-groups-to-import-that-have-changed-since-a-certain-time">The query to select objects that represent the groups to import that have changed since a certain time.</h1>

<h3 id="ldapsynchronizationgroupdifferentialqueryobjectclassgroupofnamesmodifytimestamp0">ldap.synchronization.groupDifferentialQuery=(&amp;(objectclass=groupOfNames)(!(modifyTimestamp&lt;={0})))</h3>
<p>ldap.synchronization.groupDifferentialQuery=(&amp;(objectclass=groupOfUniqueNames)(!(modifyTimestamp&lt;={0})))</p>

<h1 id="the-query-to-select-all-objects-that-represent-the-users-to-import">The query to select all objects that represent the users to import.</h1>

<p>ldap.synchronization.personQuery=(objectclass=inetOrgPerson)</p>

<h1 id="the-query-to-select-objects-that-represent-the-users-to-import-that-have-changed-since-a-certain-time">The query to select objects that represent the users to import that have changed since a certain time.</h1>

<p>ldap.synchronization.personDifferentialQuery=(&amp;(objectclass=inetOrgPerson)(!(modifyTimestamp&lt;={0})))</p>

<h1 id="the-group-search-base-restricts-the-ldap-group-query-to-a-sub-section-of-tree-on-the-ldap-server">The group search base restricts the LDAP group query to a sub section of tree on the LDAP server.</h1>

<p>ldap.synchronization.groupSearchBase=ou=Groups,dc=intix,dc=info</p>

<h1 id="the-user-search-base-restricts-the-ldap-user-query-to-a-sub-section-of-tree-on-the-ldap-server">The user search base restricts the LDAP user query to a sub section of tree on the LDAP server.</h1>

<p>ldap.synchronization.userSearchBase=ou=Employees,dc=intix,dc=info</p>

<h1 id="the-name-of-the-operational-attribute-recording-the-last-update-time-for-a-group-or-user">The name of the operational attribute recording the last update time for a group or user.</h1>

<p>ldap.synchronization.modifyTimestampAttributeName=modifyTimestamp</p>

<h1 id="the-timestamp-format-unfortunately-this-varies-between-directory-servers">The timestamp format. Unfortunately, this varies between directory servers.</h1>

<p>ldap.synchronization.timestampFormat=yyyyMMddHHmmss’Z’</p>

<h1 id="the-attribute-name-on-people-objects-found-in-ldap-to-use-as-the-uid-in-alfresco">The attribute name on people objects found in LDAP to use as the uid in Alfresco</h1>

<h3 id="ldapsynchronizationuseridattributenameuid">ldap.synchronization.userIdAttributeName=uid</h3>

<h3 id="intix-cn-is-necessary-to-authn-by-this-attribute-when-searching-ldap">intix: CN is necessary to authN by this attribute when searching LDAP</h3>

<p>ldap.synchronization.userIdAttributeName=cn</p>

<h1 id="the-attribute-on-person-objects-in-ldap-to-map-to-the-first-name-property-in-alfresco">The attribute on person objects in LDAP to map to the first name property in Alfresco</h1>

<p>ldap.synchronization.userFirstNameAttributeName=givenName</p>

<h1 id="the-attribute-on-person-objects-in-ldap-to-map-to-the-last-name-property-in-alfresco">The attribute on person objects in LDAP to map to the last name property in Alfresco</h1>

<p>ldap.synchronization.userLastNameAttributeName=sn</p>

<h1 id="the-attribute-on-person-objects-in-ldap-to-map-to-the-email-property-in-alfresco">The attribute on person objects in LDAP to map to the email property in Alfresco</h1>

<p>ldap.synchronization.userEmailAttributeName=mail</p>

<h1 id="the-attribute-on-person-objects-in-ldap-to-map-to-the-organizational-id-property-in-alfresco">The attribute on person objects in LDAP to map to the organizational id property in Alfresco</h1>

<p>ldap.synchronization.userOrganizationalIdAttributeName=o</p>

<h1 id="the-default-home-folder-provider-to-use-for-people-created-via-ldap-import">The default home folder provider to use for people created via LDAP import</h1>

<p>ldap.synchronization.defaultHomeFolderProvider=userHomesHomeFolderProvider</p>

<h1 id="the-attribute-on-ldap-group-objects-to-map-to-the-authority-name-property-in-alfresco">The attribute on LDAP group objects to map to the authority name property in Alfresco</h1>

<p>ldap.synchronization.groupIdAttributeName=cn</p>

<h1 id="the-attribute-on-ldap-group-objects-to-map-to-the-authority-display-name-property-in-alfresco">The attribute on LDAP group objects to map to the authority display name property in Alfresco</h1>

<p>ldap.synchronization.groupDisplayNameAttributeName=description</p>

<h1 id="the-group-type-in-ldap">The group type in LDAP</h1>

<h3 id="ldapsynchronizationgrouptypegroupofnames">ldap.synchronization.groupType=groupOfNames</h3>
<p>ldap.synchronization.groupType=groupOfUniqueNames</p>

<h1 id="the-person-type-in-ldap">The person type in LDAP</h1>

<p>ldap.synchronization.personType=inetOrgPerson</p>

<h1 id="the-attribute-in-ldap-on-group-objects-that-defines-the-dn-for-its-members">The attribute in LDAP on group objects that defines the DN for its members</h1>

<h3 id="ldapsynchronizationgroupmemberattributenamemember">ldap.synchronization.groupMemberAttributeName=member</h3>
<p>ldap.synchronization.groupMemberAttributeName=uniqueMember</p>

<h1 id="if-true-progress-estimation-is-enabled-when-enabled-the-user-query-has-to-be-run-twice-in-order-to-count-entries">If true progress estimation is enabled. When enabled, the user query has to be run twice in order to count entries.</h1>

<p>ldap.synchronization.enableProgressEstimation=true</p>

<p>[/sourcecode]
4. Re-start Alfresco.
5. Check LDAP authN and import of users in Alfresco.</p>

<p>[caption id=”” align=”alignnone” width=”517” caption=”Imported users from LDAP tree in Alfresco”]<img src="/assets/sso_alfr_lfry-04-showusers.png" alt="Imported users from LDAP tree in Alfresco" />[/caption]</p>

<h2 id="ii-configure-cas-in-alfresco">II. Configure CAS in Alfresco</h2>

<p>We are setting up Alfresco so that when someone log into Alfresco it is redirected to CAS for authentication.
Through the CAS filter, Alfresco catchs any request to access and these are redirected to CAS-login.
When you has successfully authenticated with CAS, after you will be redirected to the My Alfresco Dashboard, then Alfresco will need to retrieve the values of session which is placed there by the CAS Filter.
If you want to do SSO and automatic redirection when login to Alfresco Explorer after authentication in CAS, you should create a CAS Authentication Filter as Aksels Architecture Blog show us <a href="http://akselsarchitecture.blogspot.com/2010/09/cas-sso-for-alfresco-33-and-share.html">here</a> and test with version 3.4c.
To do this you have to create/modify the Java code (CasAuthenticationFilter.java) that is executed when enter to Alfresco page.
1. Edit the alfresco web.xml to modify Authentication Filter and to add the CAS filters.</p>

<p>[sourcecode language=”text” gutter=”true” wraplines=”false”]<br />
﻿c:&gt;notepad++ C:\1bpms-demo\alfr34c_1\tomcat\webapps\alfresco\WEB-INF\web.xml</p>

<p>[/sourcecode]
… modify web.xml</p>

<p>[sourcecode language=”xml” gutter=”true” wraplines=”false”]</p>

<p>[…]<br />
﻿ <context-param></context-param></p>
<param-name>rootPath</param-name>
<param-value>/app:company_home</param-value>
<p>&lt;/context-param&gt;
&lt;!–filter&gt;</p>
<filter-name>Authentication Filter</filter-name>
<description>Authentication filter mapped only to faces URLs. Other URLs generally use proprietary means to talk to the AuthenticationComponent</description>
<filter-class>org.alfresco.repo.web.filter.beans.BeanProxyFilter</filter-class>
<init-param>  
<param-name>beanName</param-name>  
<param-value>AuthenticationFilter</param-value>  
</init-param>
<p>&lt;/filter--&gt;<br />
<!-- ******* INTIX, Step 1 of 3: Comment above 'Authentication Filter' filter and add a CAS modified filter below --></p>
<filter>  
<filter-name>Authentication Filter</filter-name>  
<description>INTIX - Authentication Filter</description>  
<filter-class>org.jasig.cas.client.authentication.AuthenticationFilter</filter-class>  
<init-param>  
<param-name>casServerLoginUrl</param-name>  
<param-value>https://directorysrv1:8443/cas-server-webapp-3.3.5/login</param-value>  
</init-param>  
<init-param>  
<param-name>serverName</param-name>  
<param-value>http://alfr01:8080</param-value>  
</init-param>  
</filter>
<!-- End new CAS filter -->
<filter>  
<filter-name>Global Authentication Filter</filter-name>  
<description>Authentication filter mapped to all authenticated URLs. Mainly for SSO support</description>  
<filter-class>org.alfresco.repo.web.filter.beans.BeanProxyFilter</filter-class>  
<init-param>  
<param-name>beanName</param-name>  
<param-value>GlobalAuthenticationFilter</param-value>  
</init-param>  
</filter>

<p>[…]<br />
﻿ ﻿<!-- ******* INTIX, Step 2 of 3: Add all CAS urls --></p>
<filter>  
<filter-name>CAS Validation Filter</filter-name>  
<filter-class>org.jasig.cas.client.validation.Cas20ProxyReceivingTicketValidationFilter</filter-class>  
<init-param>  
<param-name>casServerUrlPrefix</param-name>  
<param-value>https://directorysrv1:8443/cas-server-webapp-3.3.5</param-value>  
</init-param>  
<init-param>  
<param-name>serverName</param-name>  
<param-value>http://alfr01:8080</param-value>  
</init-param>  
</filter>
<filter>  
<filter-name>Alfresco CAS Authentication Filter</filter-name>  
<filter-class>info.intix.alfresco.CasAuthenticationFilter</filter-class>  
</filter>
<filter-mapping>  
<filter-name>Authentication Filter</filter-name>  
<url-pattern>/faces/*</url-pattern>  
</filter-mapping>
<filter-mapping>  
<filter-name>CAS Validation Filter</filter-name>  
<url-pattern>/faces/*</url-pattern>  
</filter-mapping>
<filter-mapping>  
<filter-name>Alfresco CAS Authentication Filter</filter-name>  
<url-pattern>/faces/*</url-pattern>  
</filter-mapping>
<filter-mapping>  
<filter-name>Authentication Filter</filter-name>  
<url-pattern>/navigate/*</url-pattern>  
</filter-mapping>
<filter-mapping>  
<filter-name>CAS Validation Filter</filter-name>  
<url-pattern>/navigate/*</url-pattern>  
</filter-mapping>
<filter-mapping>  
<filter-name>Alfresco CAS Authentication Filter</filter-name>  
<url-pattern>/navigate/*</url-pattern>  
</filter-mapping>
<filter-mapping>  
<filter-name>Authentication Filter</filter-name>  
<url-pattern>/command/*</url-pattern>  
</filter-mapping>
<filter-mapping>  
<filter-name>CAS Validation Filter</filter-name>  
<url-pattern>/command/*</url-pattern>  
</filter-mapping>
<filter-mapping>  
<filter-name>Alfresco CAS Authentication Filter</filter-name>  
<url-pattern>/command/*</url-pattern>  
</filter-mapping>
<filter-mapping>  
<filter-name>Authentication Filter</filter-name>  
<url-pattern>/download/*</url-pattern>  
</filter-mapping>
<filter-mapping>  
<filter-name>CAS Validation Filter</filter-name>  
<url-pattern>/download/*</url-pattern>  
</filter-mapping>
<filter-mapping>  
<filter-name>Alfresco CAS Authentication Filter</filter-name>  
<url-pattern>/download/*</url-pattern>  
</filter-mapping>
<filter-mapping>  
<filter-name>Authentication Filter</filter-name>  
<url-pattern>/template/*</url-pattern>  
</filter-mapping>
<filter-mapping>  
<filter-name>CAS Validation Filter</filter-name>  
<url-pattern>/template/*</url-pattern>  
</filter-mapping>
<filter-mapping>  
<filter-name>Alfresco CAS Authentication Filter</filter-name>  
<url-pattern>/template/*</url-pattern>  
</filter-mapping>
<filter-mapping>  
<filter-name>Authentication Filter</filter-name>  
<url-pattern>/n/*</url-pattern>  
</filter-mapping>
<filter-mapping>  
<filter-name>CAS Validation Filter</filter-name>  
<url-pattern>/n/*</url-pattern>  
</filter-mapping>
<filter-mapping>  
<filter-name>Alfresco CAS Authentication Filter</filter-name>  
<url-pattern>/n/*</url-pattern>  
</filter-mapping>
<filter-mapping>  
<filter-name>Authentication Filter</filter-name>  
<url-pattern>/c/*</url-pattern>  
</filter-mapping>
<filter-mapping>  
<filter-name>CAS Validation Filter</filter-name>  
<url-pattern>/c/*</url-pattern>  
</filter-mapping>
<filter-mapping>  
<filter-name>Alfresco CAS Authentication Filter</filter-name>  
<url-pattern>/c/*</url-pattern>  
</filter-mapping>
<filter-mapping>  
<filter-name>Authentication Filter</filter-name>  
<url-pattern>/t/*</url-pattern>  
</filter-mapping>
<filter-mapping>  
<filter-name>CAS Validation Filter</filter-name>  
<url-pattern>/t/*</url-pattern>  
</filter-mapping>
<filter-mapping>  
<filter-name>Alfresco CAS Authentication Filter</filter-name>  
<url-pattern>/t/*</url-pattern>  
</filter-mapping>
<filter-mapping>  
<filter-name>Authentication Filter</filter-name>  
<url-pattern>/d/*</url-pattern>  
</filter-mapping>
<filter-mapping>  
<filter-name>CAS Validation Filter</filter-name>  
<url-pattern>/d/*</url-pattern>  
</filter-mapping>
<filter-mapping>  
<filter-name>Alfresco CAS Authentication Filter</filter-name>  
<url-pattern>/d/*</url-pattern>  
</filter-mapping>
<!-- ******* End of CAS urls -->
<filter-mapping>  
<filter-name>Global Localization Filter</filter-name>  
<url-pattern>/*</url-pattern>  
</filter-mapping>

<p>[…]<br />
﻿ <filter-mapping></filter-mapping></p>
<filter-name>Global Authentication Filter</filter-name>
<url-pattern>/faces/*</url-pattern>
<p>&lt;/filter-mapping&gt;<br />
<!-- ******* INTIX, Step 3 of 3: Comment this, it is a duplicated --><br />
&lt;!–filter-mapping&gt;</p>
<filter-name>Authentication Filter</filter-name>
<url-pattern>/faces/*</url-pattern>
<p>&lt;/filter-mapping--&gt;</p>
<filter-mapping>  
<filter-name>WebDAV Authentication Filter</filter-name>  
<url-pattern>/webdav/*</url-pattern>  
</filter-mapping>

<p>[…]</p>

<p>[/sourcecode]
2. Copy the CAS client jar file into the alfresco webapp lib folder.</p>

<p>[sourcecode language=”text” gutter=”true” wraplines=”false”]<br />
﻿c:&gt;<br />
c:&gt;copy C:\0share1\cas-client-core-3.1.10.jar C:\1bpms-demo\alfr34c_1\tomcat\webapps\alfresco\WEB-INF\lib\cas-client-core-3.1.10.jar<br />
1 archivos copiados.
c:&gt;</p>

<p>[/sourcecode]
3. Modify and compile CasAuthenticationFilter.java (http://akselsarchitecture.googlegroups.com/web/CasAuthenticationFilter-Alfresco.java) and copy .jar into the alfresco webapp lib folder.</p>

<p>[sourcecode language=”text” gutter=”true” wraplines=”false”]<br />
﻿c:&gt;<br />
c:&gt;copy C:\0share1\www.intix.info-casauthnfilter-0.1.jar c:\1bpms-demo\alfr34c_1\tomcat\webapps\alfresco\WEB-INF\lib\www.intix.info-casauthnfilter-0.1.jar<br />
1 archivos copiados.
c:&gt;</p>

<p>[/sourcecode]
You can download my <strong>www.intix.info-casauthnfilter-0.1.jar</strong> file from <a href="http://dl.dropbox.com/u/2961879/blog20110215_sso_alfresco_liferay_2/www.intix.info-casauthnfilter-0.1.jar"><strong>here</strong></a>.<br />
4. Re-start Alfresco.
5. Test CAS configuration.
Try opening an Alfresco’s page, for example: http://alfr01:8080/alfresco in a browser. You should be redirected to the CAS login page, and when you log in (for example with aamodwroclawski/test) you should be redirected back to the My Alfresco Dashboard.
6. If you have get this error (see figure below) is because you have not installed the CAS root SSL Cert as a trusted certificate in Alfresco (JRE’s cacert store). Alfresco 3.4c CE has JRE’s cacert store in ${ALF_HOME}/java/jre/lib/sec, then install the certificate there.</p>

<p>[caption id=”” align=”alignnone” width=”468” caption=”CAS server SSL certificate no installed in Alfresco”]<img src="/assets/sso_alfr_lfry-01-Alfresco-SSL-Cert-validateProxyTicketValidator-error.png" alt="CAS server SSL certificate no installed in Alfresco" />[/caption]
To solve it, you should import CAS server SSL public certificate in the JRE’s cacerts where Alfresco is running, in my case I have Alfresco running in WinXP box called “alfr01″.</p>

<p>[sourcecode language=”text” gutter=”true” wraplines=”false”]<br />
c:&gt;keytool -import -alias tomcat -file c:\0share1\directorysrv1_730days.crt -keystore C:\1bpms-demo\alf34c_1\java\jre\lib\sec<br />
y\cacerts<br />
Enter keystore password:<br />
Owner: CN=directorysrv1, OU=”INTIX I+D”, O=INTIX.info, L=BARCELONA, ST=CATALUNYA, C=ES<br />
Issuer: CN=directorysrv1, OU=”INTIX I+D”, O=INTIX.info, L=BARCELONA, ST=CATALUNYA, C=ES<br />
Serial number: 4d1df9bc<br />
Valid from: Fri Dec 31 16:41:48 GMT+01:00 2010 until: Sun Dec 30 16:41:48 GMT+01:00 2012<br />
Certificate fingerprints:<br />
MD5: 11:4D:72:BB:80:42:EE:F7:4A:CA:E9:EA:F6:4F:86:8D<br />
SHA1: 7F:6B:12:64:31:8B:47:4E:11:33:D7:FE:EF:C6:D4:65:12:59:8D:2E<br />
Signature algorithm name: SHA1withRSA<br />
Version: 3<br />
Trust this certificate? [no]: yes<br />
Certificate was added to keystore</p>

<p>[/sourcecode]</p>

<h2 id="iii-tuning-authentication-in-alfresco">III. Tuning Authentication in Alfresco</h2>

<p>Right now, we have configured Alfresco and CAS, where the user management can be done syncronizing or importing users stored in LDAP tree.
We can do user, groups and roles management via Alfresco LDAP subsystem and Authentication-SSO via EXTERNAL subsystem. To do this, we must modify the file alfresco-global.properties.</p>

<p>[sourcecode language=”text” gutter=”true” wraplines=”false”]</p>

<p>[…]<br />
﻿### authentication.chain=alfrescoNtlm1:alfrescoNtlm,ldap1:ldap<br />
﻿authentication.chain=external1:external,ldap1:ldap</p>

<p>[/sourcecode]</p>

<h2 id="iv-test-web-single-sign-on-between-liferay-605-ce-and-alfresco-34c-ce">IV. Test Web Single Sign On between Liferay 6.0.5 CE and Alfresco 3.4.c CE</h2>

<p>Open a browser with http://alfr01:8080/alfresco, you get redirected to CAS-login page. Enter aamodwroclawski/test, then you should be redirected to Alfresco My Dashboard page (authenticated).
In this time you should see Logout (aamodwroclawski) in the top right of the Alfresco page indicating that you have sucessfully logged in.</p>

<p>[caption id=”” align=”alignnone” width=”476” caption=”User properly authenticated in Alfresco”]<img src="/assets/sso_alfr_lfry-05-userauthenticated2.png" alt="User properly authenticated in Alfresco" />[/caption]
Then, open other browser with http://lfry01:8080/intixportal/user/aamodwroclawski, you get redirected to Liferay private and authenticated page for the user “aamodwroclawski”.</p>

<p>[caption id=”” align=”alignnone” width=”442” caption=”The same user authenticated and with SSO in Liferay”]<img src="/assets/sso_alfr_lfry-05-userauthenticated2lfry.png" alt="The same user authenticated and with SSO in Liferay" />[/caption]
In other direction (Liferay to Alfresco) it does work too.</p>

<h2 id="v-conclusions">V. Conclusions</h2>

<p>1. Authentication and users sync in Alfresco 3.4c does work with authentication subsystem LDAP.
2. SSO with CAS in Alfresco 3.4c does work by enabling authentication subsystem EXTERNAL.
3. There is an issue when importing users from LDAP tree in Liferay. The passwords are created with random value and no with “test”.</p>

<p><strong>END</strong></p>

<p><strong>References:</strong>
1. CAS in Alfresco
http://wiki.alfresco.com/wiki/Central_Authentication_Service_Configuration
2. CAS SSO for Alfresco 3.3 and Share
http://akselsarchitecture.blogspot.com/2010/09/cas-sso-for-alfresco-33-and-share.html</p>

  </div><div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'https://holisticsecurity.io/2011/02/19/web-sso-between-liferay-and-alfresco-with-cas-and-penrose-part-22/';
      this.page.identifier = 'https://holisticsecurity.io/2011/02/19/web-sso-between-liferay-and-alfresco-with-cas-and-penrose-part-22/';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://holosec.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript><a class="u-url" href="/2011/02/19/web-sso-between-liferay-and-alfresco-with-cas-and-penrose-part-22/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading"><img src="/assets/img/logo-holosec.png" width="40" /> Holistic Security</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Holistic Security</li><li><a class="u-email" href="mailto:blog@holisticsecurity.io">blog@holisticsecurity.io</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/Chilcano"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">Chilcano</span></a></li><li><a href="https://www.linkedin.com/in/Chilcano"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">Chilcano</span></a></li><li><a href="https://www.twitter.com/Chilcano"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">Chilcano</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Systems Thinking, Holism, Trust, Security &amp; Usability.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
