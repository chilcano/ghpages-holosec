<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>WSO2 Message Broker vs. Apache Qpid - Messaging Integration Patterns | Holistic Security</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="WSO2 Message Broker vs. Apache Qpid - Messaging Integration Patterns" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="If you want to define an Integration Architecture based on Messaging with WSO2, the only alternative you have is to do with WSO2 Message Broker and possibly also with Apache ActiveMQ. In earlier versions of WSO2 ESB, the WSO2 web had official information on how to integrate WSO2 ESB and Apache ActiveMQ, integrate both always was a common pattern, now it has been left in place of WSO2 Message Broker. Enabling JMS Transport Initially to use WSO2 ESB and Apache ActiveMQ was the de-facto solution to implement the Messaging Integration Architecture, but now all the focus are on WSO2 Message Broker. The product strategy for WSO2 Message Broker is being used in big and critical projects, for example, below some use cases: Guarantee Delivery Large volumes of messages Persistence of several and big messages High availability &amp; scalability" />
<meta property="og:description" content="If you want to define an Integration Architecture based on Messaging with WSO2, the only alternative you have is to do with WSO2 Message Broker and possibly also with Apache ActiveMQ. In earlier versions of WSO2 ESB, the WSO2 web had official information on how to integrate WSO2 ESB and Apache ActiveMQ, integrate both always was a common pattern, now it has been left in place of WSO2 Message Broker. Enabling JMS Transport Initially to use WSO2 ESB and Apache ActiveMQ was the de-facto solution to implement the Messaging Integration Architecture, but now all the focus are on WSO2 Message Broker. The product strategy for WSO2 Message Broker is being used in big and critical projects, for example, below some use cases: Guarantee Delivery Large volumes of messages Persistence of several and big messages High availability &amp; scalability" />
<link rel="canonical" href="https://holisticsecurity.io/2014/12/03/wso2-message-broker-vs-apache-qpid-messaging-eip/" />
<meta property="og:url" content="https://holisticsecurity.io/2014/12/03/wso2-message-broker-vs-apache-qpid-messaging-eip/" />
<meta property="og:site_name" content="Holistic Security" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2014-12-03T00:17:51+01:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://holisticsecurity.io/2014/12/03/wso2-message-broker-vs-apache-qpid-messaging-eip/"},"url":"https://holisticsecurity.io/2014/12/03/wso2-message-broker-vs-apache-qpid-messaging-eip/","headline":"WSO2 Message Broker vs. Apache Qpid - Messaging Integration Patterns","dateModified":"2014-12-03T00:17:51+01:00","datePublished":"2014-12-03T00:17:51+01:00","description":"If you want to define an Integration Architecture based on Messaging with WSO2, the only alternative you have is to do with WSO2 Message Broker and possibly also with Apache ActiveMQ. In earlier versions of WSO2 ESB, the WSO2 web had official information on how to integrate WSO2 ESB and Apache ActiveMQ, integrate both always was a common pattern, now it has been left in place of WSO2 Message Broker. Enabling JMS Transport Initially to use WSO2 ESB and Apache ActiveMQ was the de-facto solution to implement the Messaging Integration Architecture, but now all the focus are on WSO2 Message Broker. The product strategy for WSO2 Message Broker is being used in big and critical projects, for example, below some use cases: Guarantee Delivery Large volumes of messages Persistence of several and big messages High availability &amp; scalability","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://holisticsecurity.io/feed.xml" title="Holistic Security" /><script>
if(!(window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1")) {
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-156433649-1', 'auto');
  ga('send', 'pageview');
}
</script>
  
</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/"><img src="/assets/img/logo-holosec.png" width="100" /> Holistic Security</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/">Home</a><a class="page-link" href="/blog/">Blog</a><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">WSO2 Message Broker vs. Apache Qpid - Messaging Integration Patterns</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2014-12-03T00:17:51+01:00" itemprop="datePublished">Dec 3, 2014 
      </time>&sim; BIG DATA · EIP · MIDDLEWARE · SOA
      &sim; ACTIVEMQ · APACHE QPID · RABBITMQ · WSO2 ESB · WSO2 MESSAGE BROKER
    </p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>If you want to define an Integration Architecture based on Messaging with WSO2, the only alternative you have is to do with WSO2 Message Broker and possibly also with Apache ActiveMQ. In earlier versions of WSO2 ESB, the WSO2 web had official information on how to integrate WSO2 ESB and Apache ActiveMQ, integrate both always was a common pattern, now it has been left in place of WSO2 Message Broker.</p>

<p><img src="/assets/blog20141122-qpid-01-jms-transport-wso2esb.png" alt="Enabling JMS Transport" /><br />
 <em>Enabling JMS Transport</em></p>

<p>Initially to use WSO2 ESB and Apache ActiveMQ was the de-facto solution to implement the Messaging Integration Architecture, but now all the focus are on WSO2 Message Broker. The product strategy for WSO2 Message Broker is being used in big and critical projects, for example, below some use cases:</p>
<ul>
  <li>Guarantee Delivery</li>
  <li>Large volumes of messages</li>
  <li>Persistence of several and big messages</li>
  <li>High availability &amp; scalability</li>
</ul>

<!-- more -->

<p>Well, WSO2 Message Broker is perfect for BigData or IoT Projects, but what if we want implement and solve the same requirements but without losing functionalities. Then, What Message Broker or MOM tool should I use?.
Apache ActiveMQ is a good alternative, JBoss HornetQ, RabbitMQ and other. Some time ago I wrote about of this, <a href="/2014/03/07/message-brokering-y-recoleccion-datos-big-data-wso2">here the blog post</a>.
So what alternatives do we have to WSO2 Message Broker comparable to robustness, scalability, interoperability, lightweight without losing functionalities?. The answer is Apache Qpid. Now we will explain why.</p>

<h2 id="i-why-apache-qpid-is-a-good-comparable-alternative-to-wso2-message-broker">I. Why Apache Qpid is a good comparable alternative to WSO2 Message Broker?</h2>

<ol>
  <li>Earlier releases of WSO2 Message Broker had Apache Qpid embedded.</li>
  <li>Last release of WSO2 Message Broker uses WSO2 Andes, an extended version of Apache Qpid, to connect to Apache Cassandra as message store backend.</li>
  <li>WSO2 ESB solves the most common EIPs for messaging (guarantee delivery, persistence of messages, routing, selective channels, etc.) by developing 2 features as are the MessageStore and MessageProcessor. These features are implement on top of JMS and are technically agnostic. In other words, if the Message Broker implements JMS, then there are many possibilities that the Message Broker can be integrated to WSO2 ESB.</li>
  <li>Apache Qpid is a Message Broker lightweight, powerful, robust and has different message implementation, they are:
    <ul>
      <li>In-memory message store.</li>
      <li>Apache Derby store.</li>
      <li>Message store based on Oracle Berkeley DB, suitable to create high available messaging platforms.</li>
    </ul>
  </li>
  <li>Apache Qpid is compatible with: JMS 1.1, AMQP 1.0, 0-8, 0-9 and 0-9-1.</li>
  <li>If you want to play with WSO2 Message Broker, you should do it on an robust and powerful infraestructura, however, that is not necessary for Apache Qpid. You can run Apache Qpid in constrained infraestructure.</li>
  <li>Other alternatives to WSO2 Message Broker could be:
    <ul>
      <li>Apache ActiveMQ, although is a project mature, it is big compared to Apache Qpid and its architecture is its limit.</li>
      <li>RabbitMQ, it is bigger than Apache Qpid, but its architecture is based on plugins, it is faster but does not implement AMQP 1.0 natively, is necessary install an experimental plugin (https://www.rabbitmq.com/specification.html).
Well, after of this little introduction, I will explain step-by-step how to integrate quickly WSO2 ESB with Apache Qpid, how to enable JMS transport for Synapse Proxies and how to implement the EIP related to messaging.</li>
    </ul>
  </li>
</ol>

<h2 id="ii-installation-of-apache-qpid">II. Installation of Apache Qpid</h2>

<p>1.- Download Apache Qpid. The latest version is 0.30 (qpid-broker-0.30-bin.tar.gz) and you can download from <a href="http://qpid.apache.org/components/java-broker/index.html">here</a>.</p>

<p>2.- Unzip and run it.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>~/0dev-env/2srv/qpid-broker-0.30/bin/qpid-server  
System Properties <span class="nb">set </span>to <span class="nt">-Damqj</span>.logging.level<span class="o">=</span>info <span class="nt">-DQPID_HOME</span><span class="o">=</span>/Users/Chilcano/0dev-env/2srv/qpid-broker-0.30 <span class="nt">-DQPID_WORK</span><span class="o">=</span>/Users/Chilcano/0dev-env/2srv/qpid-work-std  
QPID_OPTS <span class="nb">set </span>to <span class="nt">-Damqj</span>.read_write_pool_size<span class="o">=</span>32 <span class="nt">-DQPID_LOG_APPEND</span><span class="o">=</span>  
Using QPID_CLASSPATH /Users/Chilcano/0dev-env/2srv/qpid-broker-0.30/lib/<span class="k">*</span>:/Users/Chilcano/0dev-env/2srv/qpid-broker-0.30/lib/plugins/<span class="k">*</span>:/Users/Chilcano/0dev-env/2srv/qpid-broker-0.30/lib/opt/<span class="k">*</span>  
Info: QPID_JAVA_GC not set. Defaulting to JAVA_GC <span class="nt">-XX</span>:+UseConcMarkSweepGC <span class="nt">-XX</span>:+HeapDumpOnOutOfMemoryError  
Info: QPID_JAVA_MEM not set. Defaulting to JAVA_MEM <span class="nt">-Xmx2g</span>  
log4j:WARN No appenders could be found <span class="k">for </span>logger <span class="o">(</span>org.apache.qpid.server.plugin.QpidServiceLoader<span class="o">)</span><span class="nb">.</span>  
log4j:WARN Please initialize the log4j system properly.  
log4j:WARN See http://logging.apache.org/log4j/1.2/faq.html#noconfig <span class="k">for </span>more info.  

<span class="o">[</span>Broker] BRK-1006 : Using configuration : /Users/Chilcano/0dev-env/2srv/qpid-work-std/config.json  
<span class="o">[</span>Broker] BRK-1007 : Using logging configuration : /Users/Chilcano/0dev-env/2srv/qpid-broker-0.30/etc/log4j.xml  
<span class="o">[</span>Broker] BRK-1001 : Startup : Version: 0.30 Build: Unversioned directory  
<span class="o">[</span>Broker] BRK-1010 : Platform : JVM : Oracle Corporation version: 1.7.0_51-b13 OS : Mac OS X version: 10.10 <span class="nb">arch</span>: x86_64  
<span class="o">[</span>Broker] BRK-1011 : Maximum Memory : 2,077,753,344 bytes  
<span class="o">[</span>Broker] BRK-1002 : Starting : Listening on TCP port 5672  
<span class="o">[</span>Broker] MNG-1001 : Web Management Startup  
<span class="o">[</span>Broker] MNG-1002 : Starting : HTTP : Listening on port 8080  
<span class="o">[</span>Broker] MNG-1004 : Web Management Ready  
<span class="o">[</span>Broker] MNG-1001 : JMX Management Startup  
<span class="o">[</span>Broker] MNG-1002 : Starting : RMI Registry : Listening on port 8999  
<span class="o">[</span>Broker] MNG-1002 : Starting : JMX RMIConnectorServer : Listening on port 9099  
<span class="o">[</span>Broker] MNG-1004 : JMX Management Ready  
<span class="o">[</span>Broker] BRK-1004 : Qpid Broker Ready  
</code></pre></div></div>

<p>If you want change the working directory, then you should define “QPID_WORK” variable in ‘qpid-server’ file or as System Variable in your S.O.:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">QPID_WORK</span><span class="o">=</span><span class="nv">$HOME</span>/0dev-env/2srv/qpid-work-std  
</code></pre></div></div>

<p>3.- If you want change ports, enable services, exchanges, enable plugins or replace default configuration, you have a lot of possibilities, just follow this <a href="https://qpid.apache.org/releases/qpid-0.30/java-broker/book/Java-Broker-Configuring-And-Managing.html">indications</a>.</p>

<p>4.- If you want configure High Availability or configure a Cluster of Apache Qpid, then just follow this informations. You could configure Apache Qpid HA as Active-Pasive or Active-Active with automatic Failover. <a href="http://qpid.apache.org/releases/qpid-0.30/java-broker/book/Java-Broker-High-Availability.html">Check this information</a>.</p>

<h2 id="iii-enabling-jms-transport-in-wso2-esb-for-apache-qpid">III. Enabling JMS transport in WSO2 ESB for Apache Qpid</h2>

<p><img src="/assets/blog20141122-qpid-01-jms-transport-wso2esb.png" alt="Enabling JMS Transport" /><br />
<em>Enabling JMS Transport</em></p>

<p>1.- After of installation of WSO2 ESB, to edit the file %WSO2ESB_HOME%/repository/conf/axis2/axis2.xml and add the JMSSender and JMSListener for Apache Qpid as follow:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[...]
<span class="c">&lt;!-- ================================================= --&gt;</span>  
<span class="c">&lt;!-- Transport Ins (Listeners) --&gt;</span>  
<span class="c">&lt;!-- ================================================= --&gt;</span>

[...]
<span class="c">&lt;!-- SAP Transport Listeners --&gt;</span>  
<span class="c">&lt;!-- --&gt;</span>  
<span class="c">&lt;!-- --&gt;</span>
<span class="c">&lt;!-- **** JMS Transport LISTENER support with Apache Qpid **** --&gt;</span>
org.apache.qpid.jndi.PropertiesFileInitialContextFactory  
repository/conf/jndi.properties  
TopicConnectionFactory  
topic
org.apache.qpid.jndi.PropertiesFileInitialContextFactory  
repository/conf/jndi.properties  
QueueConnectionFactory  
queue
org.apache.qpid.jndi.PropertiesFileInitialContextFactory  
repository/conf/jndi.properties  
QueueConnectionFactory  
queue
<span class="c">&lt;!-- ================================================= --&gt;</span>  
<span class="c">&lt;!-- Transport Outs (Senders) --&gt;</span>  
<span class="c">&lt;!-- ================================================= --&gt;</span>
[...]
<span class="c">&lt;!-- SAP Transport Senders --&gt;</span>  
<span class="c">&lt;!-- --&gt;</span>  
<span class="c">&lt;!-- --&gt;</span>
<span class="c">&lt;!-- **** JMS Transport SENDER support with Apache Qpid **** --&gt;</span>
<span class="c">&lt;!-- ================================================= --&gt;</span>  
<span class="c">&lt;!-- Global Engaged Modules --&gt;</span>  
<span class="c">&lt;!-- ================================================= --&gt;</span>
[...]  
</code></pre></div></div>

<p>2.- Now, download the Apache Qpid Java Client (<a href="http://qpid.apache.org/components/qpid-jms/index.html">qpid-client-0.30-bin.tar</a>), unzip it and copy the <code class="highlighter-rouge">qpid-client-0.30.jar</code> and <code class="highlighter-rouge">qpid-common-0.30.jar</code> to <code class="highlighter-rouge">%WSO2ESB_HOME%/repository/components/lib/</code> and restart <code class="highlighter-rouge">WSO2 ESB</code>.</p>

<p>3.- Edit the JNDI file (<code class="highlighter-rouge">%WSO2ESB_HOME%/repository/conf/jndi.properties</code>) as follow:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># register some connection factories  </span>
<span class="c"># connectionfactory.[jndiname] = [ConnectionURL]  </span>
<span class="c">##connectionfactory.QueueConnectionFactory = amqp://admin:admin@clientID/test?brokerlist='tcp://localhost:5672'  </span>
connectionfactory.QueueConnectionFactory <span class="o">=</span> amqp://admin:admin@clientID/default?brokerlist<span class="o">=</span><span class="s1">'tcp://localhost:5672'</span>  
connectionfactory.TopicConnectionFactory <span class="o">=</span> amqp://admin:admin@clientID/default?brokerlist<span class="o">=</span><span class="s1">'tcp://localhost:5672'</span>
<span class="c"># register some queues in JNDI using the form  </span>
<span class="c"># queue.[jndiName] = [physicalName]  </span>
queue.MyJNDIQueue02 <span class="o">=</span> QPID_QUEUE_02
<span class="c"># register some topics in JNDI using the form  </span>
<span class="c"># topic.[jndiName] = [physicalName]  </span>
<span class="c">##topic.MyTopic = example.MyTopic  </span>
</code></pre></div></div>

<p>Where:</p>
<ul>
  <li><code class="highlighter-rouge">clientID/default</code> is the identifier of client used to connect and the virtualhost respectively.</li>
  <li><code class="highlighter-rouge">MyJNDIQueue02</code> is the JNDI name for my queue and ‘QPID_QUEUE_02’ is the physical queue name. They will used in the next section, when creating MessaeStore and MessaProcessor.</li>
</ul>

<p>4.- Create a Synapse Proxy in WSO2 ESB to send a message to Apache Qpid.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Date $1
<span class="nt">&lt;address</span> <span class="nt">/&gt;</span>
Send a message to Apache Qpid queue (QPID_QUEUE_01)
</code></pre></div></div>

<p>Now we can send messages using this Proxy and in the Apache Qpid side are as shown:</p>

<p><img src="/assets/blog20141122-qpid-02-message-in-broker.png" alt="inspecting the store messages in Apache Qpid" /><br />
<em>Inspecting the store messages in Apache Qpid</em>
5.- Create a Synapse Proxy in WSO2 ESB to listen for messages from Apache Qpid.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>contentType  
application/soap+xml
myQueueConnectionFactory  
QPID_QUEUE_01  
queue  
Message received from Apache Qpid queue (QPID_QUEUE_01)
</code></pre></div></div>

<p>6.- Now we can test this configuration using SoapUI and follow the logs in WSO2 ESB console.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>...]  
<span class="o">[</span>2014-11-27 22:13:29,000] INFO - LogMediator <span class="o">[</span>ProxyQpidSender] BODY SENT <span class="o">=</span> Date 11/27/14 10:13 PM  
<span class="o">[</span>2014-11-27 22:13:29,021] INFO - LogMediator <span class="o">[</span>ProxyQpidReceiver] BODY RECEIVED <span class="o">=</span> Date 11/27/14 10:13 PM  
<span class="o">[</span>2014-11-27 22:13:29,474] DEBUG - ServerWorker Starting a new Server Worker instance  
<span class="o">[</span>2014-11-27 22:13:29,476] INFO - LogMediator <span class="o">[</span>ProxyQpidSender] BODY SENT <span class="o">=</span> Date 11/27/14 10:13 PM  
<span class="o">[</span>2014-11-27 22:13:29,496] INFO - LogMediator <span class="o">[</span>ProxyQpidReceiver] BODY RECEIVED <span class="o">=</span> Date 11/27/14 10:13 PM  
<span class="o">[</span>...]  
</code></pre></div></div>

<p>7.- Conclusions:</p>

<ul>
  <li>The first time you run the <code class="highlighter-rouge">ProxyQpidSender</code> proxy, the proxy will automatically create the <code class="highlighter-rouge">QPID_QUEUE_01</code> queue in Apache Qpid.</li>
  <li>If you run several times the <code class="highlighter-rouge">ProxyQpidSender</code> proxy to send and store message in <code class="highlighter-rouge">QPID_QUEUE_01</code> queue, they will be processed quickly for the <code class="highlighter-rouge">ProxyQpidReceiver</code> proxy, because this proxy is listen permanently for messages in this queue. But, if you want inspect the payload of the messages, I recommend you disable the <code class="highlighter-rouge">ProxyQpidReceiver</code> proxy in WSO2 ESB. Of this way, using Apache Qpid Web Console you can review any aspect of message (header and payload).</li>
  <li>The <code class="highlighter-rouge">ProxyQpidSender</code> proxy has as transport the HTTP protocol and <code class="highlighter-rouge">ProxyQpidReceiver</code> proxy is using JMS transport.</li>
</ul>

<h2 id="iv-wso2-esb-message-store-and-message-processor-for-apache-qpid">IV. WSO2 ESB Message Store and Message Processor for Apache Qpid</h2>

<h3 id="iv1-creating-a-message-store-in-wso2-esb">IV.1. Creating a Message Store in WSO2 ESB</h3>

<p>1.- Create the WSO2 ESB Message Store pointing to QPID_QUEUE_02.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>org.apache.qpid.jndi.PropertiesFileInitialContextFactory  
repository/conf/jndi.properties  
MyJNDIQpidQueue02  
QueueConnectionFactory  
admin  
admin  
1.1
</code></pre></div></div>

<p>2.- Create a new WSO2 ESB Proxy to send messages to the new message store ‘MsgStoreQpid02’ using the ‘Store Mediator’.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MsgStore - SysDate $1
Store the message in the WSO2 ESB Message Store (MsgStoreQpid02)
</code></pre></div></div>

<h3 id="iv2-creating-message-sampling-processor-in-wso2-esb">IV.2. Creating Message Sampling Processor in WSO2 ESB</h3>

<p><img src="/assets/blog20141122-qpid-03-msg-sampling-processor.png" alt="Message Sampling Processor with WSO2 ESB and Apache Qpid" /><br />
<em>Message Sampling Processor with WSO2 ESB and Apache Qpid</em></p>

<p>1.- Create a Sequence for the Sampling Processor</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;br</span> <span class="nt">/&gt;&lt;br</span> <span class="nt">/&gt;&lt;br</span> <span class="nt">/&gt;&lt;br</span> <span class="nt">/&gt;&lt;br</span> <span class="nt">/&gt;&lt;br</span> <span class="nt">/&gt;&lt;br</span> <span class="nt">/&gt;</span>
</code></pre></div></div>

<p>2.- Create the Message Sampling Processor</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1000  
1  
SequenceQpidSampling  
0 0/1 * 1/1 * ? *  
true
</code></pre></div></div>

<p>3.- Send messages to Message Store and check the logs</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>2014-11-28 00:06:39,654] DEBUG - ServerWorker Starting a new Server Worker instance  
<span class="o">[</span>2014-11-28 00:06:39,657] INFO - LogMediator <span class="o">[</span>ProxyQpidSender2MsgStoreSampling] MSG STORED <span class="o">=</span> MsgStore - SysDate 11/28/14 12:06 AM  
<span class="o">[</span>2014-11-28 00:06:45,894] DEBUG - ServerWorker Starting a new Server Worker instance  
<span class="o">[</span>2014-11-28 00:06:45,896] INFO - LogMediator <span class="o">[</span>ProxyQpidSender2MsgStoreSampling] MSG STORED <span class="o">=</span> MsgStore - SysDate 11/28/14 12:06 AM  
<span class="o">[</span>2014-11-28 00:07:00,014] INFO - JmsConsumer <span class="o">[</span>MsgStoreQpid02-C-1] reconnected to store.  
<span class="o">[</span>2014-11-28 00:07:00,029] INFO - LogMediator <span class="o">[</span>SequenceQpidSampling] MSG <span class="o">=</span> MsgStore - SysDate 11/28/14 12:06 AM  
<span class="o">[</span>2014-11-28 00:08:00,016] INFO - LogMediator <span class="o">[</span>SequenceQpidSampling] MSG <span class="o">=</span> MsgStore - SysDate 11/28/14 12:06 AM  
</code></pre></div></div>

<h3 id="iv3-creating-message-forwarding-processor-in-wso2-esb">IV.3. Creating Message Forwarding Processor in WSO2 ESB</h3>

<p><strong>1.- Create a Message Forwarding Processor implementing the OUT-ONLY pattern</strong></p>

<p>In this case, if the backend service processes very well the request, then the message processor will delete the message from message store.</p>

<p><img src="/assets/blog20141122-qpid-04-msg-forwarding-processor-out-only.png" alt="Message Forwarding Processor with OUT-ONLY implemented" /><br />
<em>Message Forwarding Processor with OUT-ONLY implemented</em></p>

<p>Before, we have to disable the below MessageProcessor (MsgProcessorQpidSampling), just for testing purposes. Also, we have to create a new Proxy to send messages well formated to MsgStoreQpid02.
1.1. Create the Synapse Proxy with OUT-ONLY property enabled.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;header</span> <span class="nt">/&gt;</span>
MySysDate $1
Store the message in the WSO2 ESB Message Store (MsgStoreQpid02)
</code></pre></div></div>

<p>Where:</p>
<ul>
  <li>Action is the header property of SOAP message that represents the operation to be executed.</li>
  <li>OUT_ONLY: should be set to ‘true’ for OUT-ONLY pattern.
Also, as Endpoint I will use my custom echoPassThroughProxy, where the URL is: http://localhost:8310/services/echoPassThroughProxy
1.2. Create an Endpoint for our External backend service, in this case is my ‘echoPassThroughProxy’ will be created in WSO2 ESB.</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;address&gt;&lt;/address&gt;</span>
</code></pre></div></div>

<p>1.3. Create the Message Forwarding Processor (OUT-ONLY).</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1000  
1000  
0 0/1 * 1/1 * ? *  
true
</code></pre></div></div>

<p>1.4. Check the logs</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>2014-11-27 23:25:25,003] INFO - LogMediator <span class="o">[</span>ProxyQpidSender2MsgStoreFwdOutOnly] MSG STORED <span class="o">=</span> MySysDate 11/27/14 11:25 PM  
<span class="o">[</span>2014-11-27 23:25:26,062] DEBUG - ServerWorker Starting a new Server Worker instance  
<span class="o">[</span>2014-11-27 23:25:26,064] INFO - LogMediator <span class="o">[</span>ProxyQpidSender2MsgStoreFwdOutOnly] MSG STORED <span class="o">=</span> MySysDate 11/27/14 11:25 PM  
<span class="o">[</span>2014-11-27 23:25:27,056] DEBUG - ServerWorker Starting a new Server Worker instance  
<span class="o">[</span>2014-11-27 23:25:27,058] INFO - LogMediator <span class="o">[</span>ProxyQpidSender2MsgStoreFwdOutOnly] MSG STORED <span class="o">=</span> MySysDate 11/27/14 11:25 PM  
<span class="o">[</span>2014-11-27 23:26:00,004] DEBUG - ServerWorker Starting a new Server Worker instance  
<span class="o">[</span>2014-11-27 23:26:00,005] INFO - LogMediator <span class="o">[</span>echoPassThroughProxy] <span class="o">=</span> <span class="nt">-----</span> inSeq <span class="nt">-----</span> <span class="o">=</span> <span class="o">[</span>echoPassThroughProxy]  
<span class="o">[</span>2014-11-27 23:26:00,005] INFO - LogMediator To: /services/echoPassThroughProxy, WSAction: urn:echoString, SOAPAction: urn:echoString, MessageID: urn:uuid:08a5db99-c590-4352-8ced-1ae8908814c2, Direction: request, Envelope: MySysDate 11/27/14 11:25 PM  
<span class="o">[</span>2014-11-27 23:26:00,008] DEBUG - ServerWorker Starting a new Server Worker instance  
<span class="o">[</span>2014-11-27 23:26:00,012] INFO - LogMediator <span class="o">[</span>echoPassThroughProxy] <span class="o">=</span> <span class="nt">-----</span> outSeq <span class="nt">-----</span> <span class="o">=</span> <span class="o">[</span>echoPassThroughProxy]  
<span class="o">[</span>2014-11-27 23:26:00,012] INFO - LogMediator To: http://www.w3.org/2005/08/addressing/anonymous, WSAction: , SOAPAction: , MessageID: urn:uuid:8916ed21-10a3-43ee-9d0e-6acf8a3f4de7, Direction: response, Envelope:  
</code></pre></div></div>

<p><strong>2.- Create a Message Forwarding Processor implementing IN-OUT pattern</strong></p>

<p>The only difference with the above is that it requires two Synapse Sequences (Reply and Fault sequences) that will post-process the SOAP response of Backend Service in a blocking-mode as It is a succesfully response or unseccsfully response, in other words, if everything goes well, the message processor will send an ACK to message store to consume (delete) the stored message and the message processor will trigger the reply sequence, otherwise the message processor will trigger the fault squence (the message is not consumed/deleted of message store).</p>

<p><img src="/assets/blog20141122-qpid-05-msg-forwarding-processor-in-out.png" alt="Message Forwarding Processor with IN-OUT implemented" /><br />
<em>Message Forwarding Processor with IN-OUT implemented</em></p>

<p>Before, disable the above message processor, just for testing purporses.</p>

<p>2.1. Create the Proxy with OUT_ONLY property set to false.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;header</span> <span class="nt">/&gt;</span>
MySysDate $1
Store the message in the WSO2 ESB Message Store (MsgStoreQpid02)
</code></pre></div></div>

<p>Where:</p>
<ul>
  <li>Action is the header property of SOAP message that represents the operation to be executed.</li>
  <li>OUT_ONLY: should be set to ‘false’ for IN-OUT pattern or to remove the entry.</li>
</ul>

<p>2.2. Create the Reply Sequence and Fault Sequence</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;br</span> <span class="nt">/&gt;&lt;br</span> <span class="nt">/&gt;</span>
</code></pre></div></div>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
</code></pre></div></div>

<p>2.3.- Adjust the existing Message Processor to include new Sequences for the IN-OUT pattern.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1500  
1000  
SequenceQpidReplyFwdInOut  
SequenceQpidFaultFwdInOut  
0 0/1 * 1/1 * ? *  
true
</code></pre></div></div>

<p>Where:</p>
<ul>
  <li>SequenceQpidReplyFwdInOut will process Backend message response in blocking-mode (with ACK)</li>
  <li>SequenceQpidFaultFwdInOut, if there is an exception or Backend service give an error (HTTP_SC error), then this sequence will be executed and any ACK will be send.</li>
</ul>

<p>2.4.- Check the logs.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>2014-11-27 23:46:26,401] INFO - LogMediator <span class="o">[</span>ProxyQpidSender2MsgStoreFwdInOut] MSG STORED <span class="o">=</span> MySysDate 11/27/14 11:46 PM  
<span class="o">[</span>2014-11-27 23:47:00,006] DEBUG - ServerWorker Starting a new Server Worker instance  
<span class="o">[</span>2014-11-27 23:47:00,007] INFO - LogMediator <span class="o">[</span>echoPassThroughProxy] <span class="o">=</span> <span class="nt">-----</span> inSeq <span class="nt">-----</span> <span class="o">=</span> <span class="o">[</span>echoPassThroughProxy]  
<span class="o">[</span>2014-11-27 23:47:00,007] INFO - LogMediator To: /services/echoPassThroughProxy, WSAction: urn:echoString, SOAPAction: urn:echoString, MessageID: urn:uuid:fad450ca-19df-4e36-888d-eed3478e936e, Direction: request, Envelope: MySysDate 11/27/14 11:46 PM  
<span class="o">[</span>2014-11-27 23:47:00,010] DEBUG - ServerWorker Starting a new Server Worker instance  
<span class="o">[</span>2014-11-27 23:47:00,013] INFO - LogMediator <span class="o">[</span>echoPassThroughProxy] <span class="o">=</span> <span class="nt">-----</span> outSeq <span class="nt">-----</span> <span class="o">=</span> <span class="o">[</span>echoPassThroughProxy]  
<span class="o">[</span>2014-11-27 23:47:00,014] INFO - LogMediator To: http://www.w3.org/2005/08/addressing/anonymous, WSAction: , SOAPAction: , MessageID: urn:uuid:b785f6d0-de3c-4941-a799-80a7cdc8c0d0, Direction: response, Envelope:  
<span class="o">[</span>2014-11-27 23:47:00,016] INFO - LogMediator <span class="o">[</span>SequenceQpidReplyFwdInOut] <span class="o">=</span> <span class="nt">----------------------</span> <span class="o">=</span> <span class="o">[</span>SequenceQpidReplyFwdInOut]  
<span class="o">[</span>2014-11-27 23:47:00,017] INFO - LogMediator To: /services/ProxyQpidSender2MsgStoreFwdInOut.ProxyQpidSender2MsgStoreFwdInOutHttpSoap12Endpoint, WSAction: urn:echoString, SOAPAction: urn:echoString, MessageID: urn:uuid:888E0D71F886F13CF71417131986402876015-666129391, Direction: request, Envelope:  
</code></pre></div></div>

<h2 id="v-conclusions">V. Conclusions</h2>

<ul>
  <li>Apache Qpid as good alternative to WSO2 Message Broker because you have robustness, integration patterns based messaging implemented, scalability, compatible with JMS and AMQP standard, everything in a lightweight bundle and easy to install it.</li>
  <li>WSO2 ESB is perfectly integrated to Apache Qpid, it is not necessary to program or extend some library, all integration can be achieved based on configurations only. No need to write any line of code.</li>
</ul>

  </div><div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'https://holisticsecurity.io/2014/12/03/wso2-message-broker-vs-apache-qpid-messaging-eip/';
      this.page.identifier = 'https://holisticsecurity.io/2014/12/03/wso2-message-broker-vs-apache-qpid-messaging-eip/';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://holosec.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript><a class="u-url" href="/2014/12/03/wso2-message-broker-vs-apache-qpid-messaging-eip/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading"><img src="/assets/img/logo-holosec.png" width="40" /> Holistic Security</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Holistic Security</li><li><a class="u-email" href="mailto:blog@holisticsecurity.io">blog@holisticsecurity.io</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/Chilcano"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">Chilcano</span></a></li><li><a href="https://www.linkedin.com/in/Chilcano"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">Chilcano</span></a></li><li><a href="https://www.twitter.com/Chilcano"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">Chilcano</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Systems Thinking, Holism, Trust, Security &amp; Usability.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
