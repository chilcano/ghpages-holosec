<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>MTOM en WSO2 ESB para optimizar la transferencia de datos binarios sobre SOAP (Parte 1/2) | Holistic Security</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="MTOM en WSO2 ESB para optimizar la transferencia de datos binarios sobre SOAP (Parte 1/2)" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Hace poco estaba explorando las características de WSO2 ESB para el envío óptimo de datos binarios sobre nuestros servicios implementados en SOAP y me encontré que WSO2 ESB implementa MTOM y SwA. Hice unas pruebas rápidas y pude comprobar que la transferencia de datos binarios, que por lo general son más grandes que datos de tipo textual, usando SOAP con MTOM es realmente muy potente y veloz, luego me puse a profundizar y aquí os muestro mis resultados." />
<meta property="og:description" content="Hace poco estaba explorando las características de WSO2 ESB para el envío óptimo de datos binarios sobre nuestros servicios implementados en SOAP y me encontré que WSO2 ESB implementa MTOM y SwA. Hice unas pruebas rápidas y pude comprobar que la transferencia de datos binarios, que por lo general son más grandes que datos de tipo textual, usando SOAP con MTOM es realmente muy potente y veloz, luego me puse a profundizar y aquí os muestro mis resultados." />
<link rel="canonical" href="https://holisticsecurity.io/2014/05/14/mtom-en-wso2-esb-para-optimizar-la-transferencia-de-datos-binarios-sobre-soap-parte1/" />
<meta property="og:url" content="https://holisticsecurity.io/2014/05/14/mtom-en-wso2-esb-para-optimizar-la-transferencia-de-datos-binarios-sobre-soap-parte1/" />
<meta property="og:site_name" content="Holistic Security" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2014-05-14T21:14:42+02:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://holisticsecurity.io/2014/05/14/mtom-en-wso2-esb-para-optimizar-la-transferencia-de-datos-binarios-sobre-soap-parte1/"},"url":"https://holisticsecurity.io/2014/05/14/mtom-en-wso2-esb-para-optimizar-la-transferencia-de-datos-binarios-sobre-soap-parte1/","headline":"MTOM en WSO2 ESB para optimizar la transferencia de datos binarios sobre SOAP (Parte 1/2)","dateModified":"2014-05-14T21:14:42+02:00","datePublished":"2014-05-14T21:14:42+02:00","description":"Hace poco estaba explorando las características de WSO2 ESB para el envío óptimo de datos binarios sobre nuestros servicios implementados en SOAP y me encontré que WSO2 ESB implementa MTOM y SwA. Hice unas pruebas rápidas y pude comprobar que la transferencia de datos binarios, que por lo general son más grandes que datos de tipo textual, usando SOAP con MTOM es realmente muy potente y veloz, luego me puse a profundizar y aquí os muestro mis resultados.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://holisticsecurity.io/feed.xml" title="Holistic Security" /><script>
if(!(window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1")) {
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-156433649-1', 'auto');
  ga('send', 'pageview');
}
</script>
  
</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/"><img src="/assets/img/logo-holosec.png" width="100" /> Holistic Security</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/">Home</a><a class="page-link" href="/blog/">Blog</a><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">MTOM en WSO2 ESB para optimizar la transferencia de datos binarios sobre SOAP (Parte 1/2)</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2014-05-14T21:14:42+02:00" itemprop="datePublished">May 14, 2014 
      </time>&sim; MIDDLEWARE · SOA
      &sim; APACHE AXIOM · AXIS2 · MTOM · SOAP · SOAPUI · SWA · WSO2 ESB
    </p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Hace poco estaba explorando las características de WSO2 ESB para el envío óptimo de datos binarios sobre nuestros servicios implementados en SOAP y me encontré que WSO2 ESB implementa MTOM y SwA. Hice unas pruebas rápidas y pude comprobar que la transferencia de datos binarios, que por lo general son más grandes que datos de tipo textual, usando SOAP con MTOM es realmente muy potente y veloz, luego me puse a profundizar y aquí os muestro mis resultados.</p>

<p><img src="/assets/blog20140430_wso2_mtom/wso2esb-soapui-mtom.png" alt="wso2esb-soapui-mtom" width="40%" /></p>

<!-- more -->

<h2 id="i-casos-de-uso-mtom-en-wso2-esb">I. Casos de Uso MTOM en WSO2 ESB.</h2>

<p>WSO2 ESB viene con más de 102 ejemplos de Proxy de Apache Synapse, cada uno de ellos implementa diferentes casos de usos necesarios para integrar aplicaciones con diferencias estrategias.
El ejemplo “Sample 51” implementa MTOM y SwA sobre SOAP y esta entrada al blog usa esta implementación.</p>

<p><strong>Requisitos:</strong></p>

<ul>
  <li><a href="https://docs.wso2.org/pages/viewpage.action?pageId=33136025">Sample 51: MTOM and SwA Optimizations and Request/Response Correlation</a></li>
  <li><a href="http://www.soapui.org">SoapUI</a></li>
  <li><a href="http://wso2.com/products/enterprise-service-bus">WSO2 ESB 4.8.1</a></li>
</ul>

<h2 id="ii-desplegar-los-servicios-de-back-end-sample-51-en-axis2-server">II. Desplegar los servicios de back-end (Sample 51) en Axis2 server.</h2>

<p>Para trabajar con los ejemplos de cualquier producto WSO2 es necesario ANT. Basta con añadir ANT a la variable del sistema PATH, en mi caso será:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PATH <span class="o">=</span> %PATH%<span class="p">;</span>C:<span class="se">\0</span>1bizlife<span class="se">\a</span>pache-ant-1.9.3<span class="se">\b</span><span class="k">in</span>  
</code></pre></div></div>

<p>WSO2 ESB viene con Axis2 server y con los servicios de back-end ya implementados. Para sólo es necesario compilarlos y desplegarlos en el Axis2 server. Para ello hacer lo siguiente:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\&gt;</span> <span class="nb">cd</span> &lt;ESB_HOME&gt;/samples/axis2Server/src/MTOMSwASampleService  
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\0</span>1bizlife<span class="se">\w</span>so2esb-4.8.1-dev<span class="se">\s</span>amples<span class="se">\a</span>xis2Server<span class="se">\s</span>rc<span class="se">\M</span>TOMSwASampleService&gt;ant
Buildfile: C:<span class="se">\0</span>1bizlife<span class="se">\w</span>so2esb-4.8.1-dev<span class="se">\s</span>amples<span class="se">\a</span>xis2Server<span class="se">\s</span>rc<span class="se">\M</span>TOMSwASampleService<span class="se">\b</span>uild.xml  
clean:  
init:  
<span class="o">[</span><span class="nb">mkdir</span><span class="o">]</span> Created <span class="nb">dir</span>: C:<span class="se">\0</span>1bizlife<span class="se">\w</span>so2esb-4.8.1-dev<span class="se">\s</span>amples<span class="se">\a</span>xis2Server<span class="se">\s</span>rc<span class="se">\M</span>TOMSwASampleService<span class="se">\t</span>emp  
<span class="o">[</span><span class="nb">mkdir</span><span class="o">]</span> Created <span class="nb">dir</span>: C:<span class="se">\0</span>1bizlife<span class="se">\w</span>so2esb-4.8.1-dev<span class="se">\s</span>amples<span class="se">\a</span>xis2Server<span class="se">\s</span>rc<span class="se">\M</span>TOMSwASampleService<span class="se">\t</span>emp<span class="se">\c</span>lasses  
<span class="o">[</span><span class="nb">mkdir</span><span class="o">]</span> Created <span class="nb">dir</span>: C:<span class="se">\0</span>1bizlife<span class="se">\w</span>so2esb-4.8.1-dev<span class="se">\s</span>amples<span class="se">\a</span>xis2Server<span class="se">\r</span>epository<span class="se">\s</span>ervices  
compile-all:  
<span class="o">[</span>javac] C:<span class="se">\0</span>1bizlife<span class="se">\w</span>so2esb-4.8.1-dev<span class="se">\s</span>amples<span class="se">\a</span>xis2Server<span class="se">\s</span>rc<span class="se">\M</span>TOMSwASampleService<span class="se">\b</span>uild.xml:47: warning: <span class="s1">'includeantruntime'</span> was not <span class="nb">set</span>, defaulting to build.sysclasspath<span class="o">=</span>last<span class="p">;</span> <span class="nb">set </span>to <span class="nb">false </span><span class="k">for </span>repeatable builds  
<span class="o">[</span>javac] Compiling 1 <span class="nb">source </span>file to C:<span class="se">\0</span>1bizlife<span class="se">\w</span>so2esb-4.8.1-dev<span class="se">\s</span>amples<span class="se">\a</span>xis2Server<span class="se">\s</span>rc<span class="se">\M</span>TOMSwASampleService<span class="se">\t</span>emp<span class="se">\c</span>lasses  
build-service:  
<span class="o">[</span><span class="nb">mkdir</span><span class="o">]</span> Created <span class="nb">dir</span>: C:<span class="se">\0</span>1bizlife<span class="se">\w</span>so2esb-4.8.1-dev<span class="se">\s</span>amples<span class="se">\a</span>xis2Server<span class="se">\s</span>rc<span class="se">\M</span>TOMSwASampleService<span class="se">\t</span>emp<span class="se">\M</span>TOMSwASampleService  
<span class="o">[</span><span class="nb">mkdir</span><span class="o">]</span> Created <span class="nb">dir</span>: C:<span class="se">\0</span>1bizlife<span class="se">\w</span>so2esb-4.8.1-dev<span class="se">\s</span>amples<span class="se">\a</span>xis2Server<span class="se">\s</span>rc<span class="se">\M</span>TOMSwASampleService<span class="se">\t</span>emp<span class="se">\M</span>TOMSwASampleService<span class="se">\M</span>ETA-INF  
<span class="o">[</span>copy] Copying 1 file to C:<span class="se">\0</span>1bizlife<span class="se">\w</span>so2esb-4.8.1-dev<span class="se">\s</span>amples<span class="se">\a</span>xis2Server<span class="se">\s</span>rc<span class="se">\M</span>TOMSwASampleService<span class="se">\t</span>emp<span class="se">\M</span>TOMSwASampleService<span class="se">\M</span>ETA-INF  
<span class="o">[</span>copy] Copying 1 file to C:<span class="se">\0</span>1bizlife<span class="se">\w</span>so2esb-4.8.1-dev<span class="se">\s</span>amples<span class="se">\a</span>xis2Server<span class="se">\s</span>rc<span class="se">\M</span>TOMSwASampleService<span class="se">\t</span>emp<span class="se">\M</span>TOMSwASampleService  
<span class="o">[</span>jar] Building jar: C:<span class="se">\0</span>1bizlife<span class="se">\w</span>so2esb-4.8.1-dev<span class="se">\s</span>amples<span class="se">\a</span>xis2Server<span class="se">\r</span>epository<span class="se">\s</span>ervices<span class="se">\M</span>TOMSwASampleService.aar
BUILD SUCCESSFUL  
Total <span class="nb">time</span>: 1 second  
</code></pre></div></div>

<p>Sólo comentar que “MTOMSwASampleService” implementa el servicio de back-end y tiene 3 operaciones:</p>
<ul>
  <li>uploadFileUsingMTOM (in-out): Acepta una imagen en binario desde el request SOAP como MTOM y devuelve esta misma imagen como response SOAP.</li>
  <li>uploadFileUsingSwA (in-out): Acepta una imagen en binario desde el request SOAP como SwA y devuelve esta misma imagen as response SOAP.</li>
  <li>oneWayUploadUsingMTOM (in-only): Guarda el mensaje de request al disco.</li>
</ul>

<h2 id="iii-iniciar-axis2-server">III. Iniciar Axis2 server.</h2>

<p>Axis2 server usa HTTP listener en el puerto 9000 y el HTTPS 9002 por defecto.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\0</span>1bizlife<span class="se">\w</span>so2esb-4.8.1-dev<span class="se">\s</span>amples<span class="se">\a</span>xis2Server&gt;axis2server.bat 
<span class="s2">"Starting Sample Axis2 Server ..."</span>  
Using AXIS2_HOME: C:<span class="se">\0</span>1BIZL~1<span class="se">\W</span>SO2ES~1.1-D<span class="se">\s</span>amples<span class="se">\A</span>XIS2S~1<span class="se">\ </span> 
Using JAVA_HOME: C:<span class="se">\P</span>rogram Files<span class="se">\J</span>ava<span class="se">\j</span>dk1.7.0_51  
14/04/30 12:31:36 INFO util.SampleAxis2ServerManager: <span class="o">[</span>SimpleAxisServer] Starting  
<span class="o">[</span>SimpleAxisServer] Using the Axis2 Repository : C:<span class="se">\0</span>1BIZL~1<span class="se">\W</span>SO2ES~1.1-D<span class="se">\s</span>amples<span class="se">\A</span>XIS2S~1<span class="se">\r</span>epository  
<span class="o">[</span>SimpleAxisServer] Using the Axis2 Configuration File : C:<span class="se">\0</span>1BIZL~1<span class="se">\W</span>SO2ES~1.1-D<span class="se">\s</span>amples<span class="se">\A</span>XIS2S~1<span class="se">\r</span>epository<span class="se">\c</span>onf<span class="se">\a</span>xis2.xml  
14/04/30 12:31:36 INFO deployment.ModuleDeployer: Deploying module: addressing - file:/C:/01BIZL~1/WSO2ES~1.1-D/samples/AXIS2S~1/repository/modules/addressing.mar  
14/04/30 12:31:36 INFO deployment.ModuleDeployer: Deploying module: rampart - file:/C:/01BIZL~1/WSO2ES~1.1-D/samples/AXIS2S~1/repository/modules/rampart.mar  
14/04/30 12:31:36 INFO deployment.ModuleDeployer: Deploying module: sandesha2 - file:/C:/01BIZL~1/WSO2ES~1.1-D/samples/AXIS2S~1/repository/modules/sandesha2.mar  
14/04/30 12:31:36 INFO deployment.ModuleDeployer: Deploying module: addressing - file:/C:/01BIZL~1/WSO2ES~1.1-D/samples/AXIS2S~1/./../../repository/components/plugins/org.wso2.carbon.addressing_4.2.0.jar  
14/04/30 12:31:36 INFO deployment.ModuleDeployer: Deploying module: wso2caching - file:/C:/01BIZL~1/WSO2ES~1.1-D/samples/AXIS2S~1/./../../repository/components/plugins/org.wso2.carbon.caching.core_4.2.0.jar  
14/04/30 12:31:36 INFO deployment.ModuleDeployer: Deploying module: ComponentMgtModule - file:/C:/01BIZL~1/WSO2ES~1.1-D/samples/AXIS2S~1/./../../repository/components/plugins/org.wso2.carbon.feature.mgt.services_4.2.0.jar  
14/04/30 12:31:37 INFO deployment.ModuleDeployer: Deploying module: wso2mex - file:/C:/01BIZL~1/WSO2ES~1.1-D/samples/AXIS2S~1/./../../repository/components/plugins/org.wso2.carbon.mex_4.2.0.jar  
14/04/30 12:31:37 INFO deployment.ModuleDeployer: Deploying module: pagination - file:/C:/01BIZL~1/WSO2ES~1.1-D/samples/AXIS2S~1/./../../repository/components/plugins/org.wso2.carbon.registry.server_4.2.0.jar  
14/04/30 12:31:37 INFO deployment.ModuleDeployer: Deploying module: relay - file:/C:/01BIZL~1/WSO2ES~1.1-D/samples/AXIS2S~1/./../../repository/components/plugins/org.wso2.carbon.relay.module_4.2.0.jar  
14/04/30 12:31:37 INFO deployment.ModuleDeployer: Deploying module: sandesha2 - file:/C:/01BIZL~1/WSO2ES~1.1-D/samples/AXIS2S~1/./../../repository/components/plugins/org.wso2.carbon.rm_4.2.0.jar  
14/04/30 12:31:37 INFO deployment.ModuleDeployer: Deploying module: POXSecurityModule - file:/C:/01BIZL~1/WSO2ES~1.1-D/samples/AXIS2S~1/./../../repository/components/plugins/org.wso2.carbon.security.mgt_4.2.2.jar  
14/04/30 12:31:37 INFO deployment.ModuleDeployer: Deploying module: ServerAdminModule - file:/C:/01BIZL~1/WSO2ES~1.1-D/samples/AXIS2S~1/./../../repository/components/plugins/org.wso2.carbon.server.admin_4.2.0.jar  
14/04/30 12:31:37 INFO deployment.ModuleDeployer: Deploying module: wso2statistics - file:/C:/01BIZL~1/WSO2ES~1.1-D/samples/AXIS2S~1/./../../repository/components/plugins/org.wso2.carbon.statistics_4.2.2.jar  
14/04/30 12:31:37 INFO deployment.ModuleDeployer: Deploying module: wso2throttle - file:/C:/01BIZL~1/WSO2ES~1.1-D/samples/AXIS2S~1/./../../repository/components/plugins/org.wso2.carbon.throttle.core_4.2.0.jar  
14/04/30 12:31:37 INFO deployment.ModuleDeployer: Deploying module: usagethrottling - file:/C:/01BIZL~1/WSO2ES~1.1-D/samples/AXIS2S~1/./../../repository/components/plugins/org.wso2.carbon.throttling.agent_2.2.0.jar  
14/04/30 12:31:37 INFO deployment.ModuleDeployer: Deploying module: wso2tracer - file:/C:/01BIZL~1/WSO2ES~1.1-D/samples/AXIS2S~1/./../../repository/components/plugins/org.wso2.carbon.tracer_4.2.0.jar  
14/04/30 12:31:37 INFO deployment.ModuleDeployer: Deploying module: metering - file:/C:/01BIZL~1/WSO2ES~1.1-D/samples/AXIS2S~1/./../../repository/components/plugins/org.wso2.carbon.usage.agent_2.2.0.jar  
14/04/30 12:31:37 INFO deployment.ModuleDeployer: Deploying module: wso2xfer - file:/C:/01BIZL~1/WSO2ES~1.1-D/samples/AXIS2S~1/./../../repository/components/plugins/org.wso2.carbon.xfer_4.2.0.jar  
14/04/30 12:31:37 INFO deployment.ModuleDeployer: Deploying module: rampart - file:/C:/01BIZL~1/WSO2ES~1.1-D/samples/AXIS2S~1/./../../repository/components/plugins/rampart-core_1.6.1.wso2v12.jar  
14/04/30 12:31:37 INFO deployment.ModuleDeployer: Deploying module: rahas - file:/C:/01BIZL~1/WSO2ES~1.1-D/samples/AXIS2S~1/./../../repository/components/plugins/rampart-trust_1.6.1.wso2v12.jar  
14/04/30 12:31:37 ERROR sandesha2.SandeshaModule: Could not load module policies. Using default values.  
14/04/30 12:31:37 INFO config.ClientConnFactoryBuilder: HTTPS Loading Identity Keystore from : ../../repository/resources/security/wso2carbon.jks  
14/04/30 12:31:37 INFO config.ClientConnFactoryBuilder: HTTPS Loading Trust Keystore from : ../../repository/resources/security/client-truststore.jks  
14/04/30 12:31:37 INFO nhttp.HttpCoreNIOSender: HTTPS Sender starting  
14/04/30 12:31:37 INFO nhttp.HttpCoreNIOSender: HTTP Sender starting  
14/04/30 12:31:37 INFO jms.JMSSender: JMS Sender started  
14/04/30 12:31:37 INFO jms.JMSSender: JMS Transport Sender initialized...  
14/04/30 12:31:37 INFO deployment.DeploymentEngine: Deploying Web service: MTOMSwASampleService.aar - file:/C:/01BIZL~1/WSO2ES~1.1-D/samples/AXIS2S~1/repository/services/MTOMSwASampleService.aar  
14/04/30 12:31:37 INFO nhttp.HttpCoreNIOListener: HTTPS Listener started on 0.0.0.0:9002  
14/04/30 12:31:37 INFO nhttp.HttpCoreNIOListener: HTTP Listener started on 0.0.0.0:9000  
14/04/30 12:31:37 INFO util.SampleAxis2ServerManager: <span class="o">[</span>SimpleAxisServer] Started  
</code></pre></div></div>

<p>Si es necesario abrir varias instancias de Axis2 server, hay que iniciarlos en puertos diferentes como se indica a continuación:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./axis2server.sh <span class="nt">-http</span> 9001 <span class="nt">-https</span> 9005 <span class="nt">-name</span> MyServer1  
./axis2server.sh <span class="nt">-http</span> 9002 <span class="nt">-https</span> 9006 <span class="nt">-name</span> MyServer2  
./axis2server.sh <span class="nt">-http</span> 9003 <span class="nt">-https</span> 9007 <span class="nt">-name</span> MyServer3
</code></pre></div></div>

<h2 id="iv-cargar-la-configuración-synapse-de-sample-51-en-wso2-esb">IV. Cargar la configuración synapse de “Sample 51” en WSO2 ESB.</h2>

<p>Es posible cargar “Sample 51” por defecto cuando WSO2 ESB inicie, esto hará que se cargue el fichero synapse, mientras que los proxies antes creados no se cargarán, al volver a iniciar WSO2 ESB de la forma normal dichos Proxies volverán a cargarse.
Iniciemos WSO2 ESB con <code class="highlighter-rouge">&lt;ESB_HOME&gt;\repository\samples\synapse_sample_51.xml</code> pre-cargado, de esta forma:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\0</span>1bizlife<span class="se">\w</span>so2esb-4.8.1-dev<span class="se">\b</span><span class="k">in</span><span class="o">&gt;</span>wso2esb-samples.bat <span class="nt">-sn</span> 51
JAVA_HOME environment variable is <span class="nb">set </span>to C:<span class="se">\P</span>rogram Files<span class="se">\J</span>ava<span class="se">\j</span>dk1.7.0_51  
CARBON_HOME environment variable is <span class="nb">set </span>to C:<span class="se">\0</span>1BIZL~1<span class="se">\W</span>SO2ES~1.1-D<span class="se">\b</span><span class="k">in</span><span class="se">\\</span>..  
<span class="o">[</span>2014-04-30 12:53:51,708] INFO - CarbonCoreActivator Starting WSO2 Carbon...  
<span class="o">[</span>2014-04-30 12:53:51,708] INFO - CarbonCoreActivator Operating System : Windows XP 5.1, x86  
<span class="o">[</span>2014-04-30 12:53:51,708] INFO - CarbonCoreActivator Java Home : C:<span class="se">\P</span>rogram Files<span class="se">\J</span>ava<span class="se">\j</span>dk1.7.0_51<span class="se">\j</span>re  
<span class="o">[</span>2014-04-30 12:53:51,708] INFO - CarbonCoreActivator Java Version : 1.7.0_51  
<span class="o">[</span>2014-04-30 12:53:51,718] INFO - CarbonCoreActivator Java VM : Java HotSpot<span class="o">(</span>TM<span class="o">)</span> Client VM 24.51-b03,Oracle Corporation  
<span class="o">[</span>...]  
<span class="o">[</span>2014-04-30 12:54:08,162] INFO - PassThroughHttpSSLListener Pass-through HTTPS Listener started on 0.0.0.0:8246  
<span class="o">[</span>2014-04-30 12:54:08,162] INFO - PassThroughHttpListener Starting Pass-through HTTP Listener...  
<span class="o">[</span>2014-04-30 12:54:08,172] INFO - PassThroughHttpListener Pass-through HTTP Listener started on 0.0.0.0:8283  
<span class="o">[</span>2014-04-30 12:54:08,172] INFO - JMSListener JMS listener started  
<span class="o">[</span>2014-04-30 12:54:08,172] INFO - NioSelectorPool Using a shared selector <span class="k">for </span>servlet write/read  
<span class="o">[</span>2014-04-30 12:54:08,382] INFO - NioSelectorPool Using a shared selector <span class="k">for </span>servlet write/read  
<span class="o">[</span>2014-04-30 12:54:08,412] INFO - RegistryEventingServiceComponent Successfully Initialized Eventing on Registry  
<span class="o">[</span>2014-04-30 12:54:08,462] INFO - JMXServerManager JMX Service URL : service:jmx:rmi://localhost:11114/jndi/rmi://localhost:10002/jmxrmi  
<span class="o">[</span>2014-04-30 12:54:08,462] INFO - StartupFinalizerServiceComponent Server : WSO2 ESB <span class="o">(</span>DEV<span class="o">)</span><span class="nt">-4</span>.8.1  
<span class="o">[</span>2014-04-30 12:54:08,462] INFO - StartupFinalizerServiceComponent WSO2 Carbon started <span class="k">in </span>24 sec  
<span class="o">[</span>2014-04-30 12:54:08,853] INFO - CarbonUIServiceComponent Mgt Console URL : https://10.0.2.15:9446/carbon/  
</code></pre></div></div>

<h2 id="v-ejecutar-el-ejemplo-desde-un-cliente-axis2">V. Ejecutar el ejemplo desde un cliente Axis2.</h2>

<p>Para ejecutar este ejemplo debemos emplear un cliente Axis2 e invocar el Proxy correspondiente al “Sample 51”.<br />
WSO2 ESB viene con cliente Axis2 implementado (OptimizeClient) para este ejemplo. Este cliente enviará una petición a WSO2 ESB en el puerto 8280, pero mi ESB tiene el offset puesto a 3 por lo que tendré que redirigir las peticiones del puerto 8280 al 8283, para ello usaré TCPMon, una herramienta muy útil para debugging que hará todo este trabajo, además podemos inspeccionar los mensajes SOAP de request y response, y modificarlos en tiempo real.
Entonces, iniciar TCPmon y crear un Listener en 8280 y reenviarlo a 8283:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\&gt; cd <span class="nt">&lt;ESB_HOME&gt;</span>\bin  
C:\01bizlife\wso2esb-4.8.1-dev\bin&gt;tcpmon.bat  

</code></pre></div></div>

<p>Usar estos valores en TCPmon:</p>
<ul>
  <li>Listen Port #: 8280</li>
  <li>Target Hostname: 127.0.0.1</li>
  <li>Target Port #: 8283</li>
</ul>

<p>Ahora, ejecutar el cliente Axis2. Seguir estos pasos para ejecutarlo:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\&gt; cd <span class="nt">&lt;ESB_HOME&gt;</span>\samples\axis2Client  
C:\01bizlife\wso2esb-4.8.1-dev\samples\axis2Client&gt;ant optimizeclient -Dopt_mode=mtom
Buildfile: C:\01bizlife\wso2esb-4.8.1-dev\samples\axis2Client\build.xml
init:  
[jar] Building jar: C:\01bizlife\wso2esb-4.8.1-dev\samples\axis2Client\pathing.jar
compile:
optimizeclient:  
[java] Sending file : ./../../repository/samples/resources/mtom/asf-logo.gif as MTOM  
[java] 14/04/30 13:57:33 INFO deployment.DeploymentEngine: No services directory was found under C:\01bizlife\wso2esb-4.8.1-dev\samples\axis2Client\client_repo.  
[java] 14/04/30 13:57:33 INFO deployment.ModuleDeployer: Deploying module: addressing - file:/C:/01bizlife/wso2esb-4.8.1-dev/samples/axis2Client/client_repo/modules/addressing.mar  
[java] 14/04/30 13:57:33 INFO deployment.ModuleDeployer: Deploying module: rampart - file:/C:/01bizlife/wso2esb-4.8.1-dev/samples/axis2Client/client_repo/modules/rampart.mar  
[java] 14/04/30 13:57:34 INFO deployment.ModuleDeployer: Deploying module: sandesha2 - file:/C:/01bizlife/wso2esb-4.8.1-dev/samples/axis2Client/client_repo/modules/sandesha2.mar  
[java] 14/04/30 13:57:34 INFO deployment.ModuleDeployer: Deploying module: addressing - file:/C:/01bizlife/wso2esb-4.8.1-dev/repository/components/plugins/org.wso2.carbon.addressing_4.2.0.jar  
[java] 14/04/30 13:57:34 INFO deployment.ModuleDeployer: Deploying module: wso2caching - file:/C:/01bizlife/wso2esb-4.8.1-dev/repository/components/plugins/org.wso2.carbon.caching.core_4.2.0.jar  
[java] 14/04/30 13:57:34 INFO deployment.ModuleDeployer: Deploying module: ComponentMgtModule - file:/C:/01bizlife/wso2esb-4.8.1-dev/repository/components/plugins/org.wso2.carbon.feature.mgt.services_4.2.0.jar  
[java] 14/04/30 13:57:34 INFO deployment.ModuleDeployer: Deploying module: wso2mex - file:/C:/01bizlife/wso2esb-4.8.1-dev/repository/components/plugins/org.wso2.carbon.mex_4.2.0.jar  
[java] 14/04/30 13:57:34 INFO deployment.ModuleDeployer: Deploying module: pagination - file:/C:/01bizlife/wso2esb-4.8.1-dev/repository/components/plugins/org.wso2.carbon.registry.server_4.2.0.jar  
[java] 14/04/30 13:57:34 INFO deployment.ModuleDeployer: Deploying module: relay - file:/C:/01bizlife/wso2esb-4.8.1-dev/repository/components/plugins/org.wso2.carbon.relay.module_4.2.0.jar  
[java] 14/04/30 13:57:34 INFO deployment.ModuleDeployer: Deploying module: sandesha2 - file:/C:/01bizlife/wso2esb-4.8.1-dev/repository/components/plugins/org.wso2.carbon.rm_4.2.0.jar  
[java] 14/04/30 13:57:34 INFO deployment.ModuleDeployer: Deploying module: POXSecurityModule - file:/C:/01bizlife/wso2esb-4.8.1-dev/repository/components/plugins/org.wso2.carbon.security.mgt_4.2.2.jar  
[java] 14/04/30 13:57:34 INFO deployment.ModuleDeployer: Deploying module: ServerAdminModule - file:/C:/01bizlife/wso2esb-4.8.1-dev/repository/components/plugins/org.wso2.carbon.server.admin_4.2.0.jar  
[java] 14/04/30 13:57:34 INFO deployment.ModuleDeployer: Deploying module: wso2statistics - file:/C:/01bizlife/wso2esb-4.8.1-dev/repository/components/plugins/org.wso2.carbon.statistics_4.2.2.jar  
[java] 14/04/30 13:57:34 INFO deployment.ModuleDeployer: Deploying module: wso2throttle - file:/C:/01bizlife/wso2esb-4.8.1-dev/repository/components/plugins/org.wso2.carbon.throttle.core_4.2.0.jar  
[java] 14/04/30 13:57:34 INFO deployment.ModuleDeployer: Deploying module: usagethrottling - file:/C:/01bizlife/wso2esb-4.8.1-dev/repository/components/plugins/org.wso2.carbon.throttling.agent_2.2.0.jar  
[java] 14/04/30 13:57:34 INFO deployment.ModuleDeployer: Deploying module: wso2tracer - file:/C:/01bizlife/wso2esb-4.8.1-dev/repository/components/plugins/org.wso2.carbon.tracer_4.2.0.jar  
[java] 14/04/30 13:57:34 INFO deployment.ModuleDeployer: Deploying module: metering - file:/C:/01bizlife/wso2esb-4.8.1-dev/repository/components/plugins/org.wso2.carbon.usage.agent_2.2.0.jar  
[java] 14/04/30 13:57:34 INFO deployment.ModuleDeployer: Deploying module: wso2xfer - file:/C:/01bizlife/wso2esb-4.8.1-dev/repository/components/plugins/org.wso2.carbon.xfer_4.2.0.jar  
[java] 14/04/30 13:57:34 INFO deployment.ModuleDeployer: Deploying module: rampart - file:/C:/01bizlife/wso2esb-4.8.1-dev/repository/components/plugins/rampart-core_1.6.1.wso2v12.jar  
[java] 14/04/30 13:57:34 INFO deployment.ModuleDeployer: Deploying module: rahas - file:/C:/01bizlife/wso2esb-4.8.1-dev/repository/components/plugins/rampart-trust_1.6.1.wso2v12.jar  
[java] 14/04/30 13:57:34 ERROR sandesha2.SandeshaModule: Could not load module policies. Using default values.  
[java] 14/04/30 13:57:34 INFO mail.MailTransportSender: MAILTO Sender started  
[java] 14/04/30 13:57:34 INFO jms.JMSSender: JMS Sender started  
[java] 14/04/30 13:57:34 INFO jms.JMSSender: JMS Transport Sender initialized...  
[java] Saved response to file : C:\01bizlife\wso2esb-4.8.1-dev\samples\axis2Client\\.\\..\\..\tmp\sampleClient\mtom-7597224514139522188.gif
BUILD SUCCESSFUL  
Total time: 3 seconds  
</code></pre></div></div>

<p>Según los logs, se ha podido enviar satisfactoriamente una imagen ubicada en <code class="highlighter-rouge">C:&gt;1bizlife\wso2esb-4.8.1-dev\repository\samples\resources\mtom\asf-logo.gif</code>, además, la imagen recibida ha sido guardada en el lado servidor en esta ruta <code class="highlighter-rouge">C:&gt;1bizlife\wso2esb-4.8.1-dev\tmp\sampleClient\mtom-7597224514139522188.gif</code></p>

<h2 id="vi-revisando-el-request-y-response-soap-mtom">VI. Revisando el request y response SOAP MTOM.</h2>

<p>Gracias al uso de TCPmon hemos podido interceptar el request y el response, aunque sólo serán legibles las cabeceras SOAP mientras que parte de los payloads no ya que contienen información en formato binario.</p>

<p><strong>MTOM SOAP request message</strong> :</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /services/MTOMSwASampleService HTTP/1.1  
Content-Type: multipart/related; boundary="MIMEBoundary_6b43ce2cbb2f537bc614ca2667f80dd0906a861a70931f26"; type="application/xop+xml"; start="<span class="nt">&lt;0.1b43ce2cbb2f537bc614ca2667f80dd0906a861a70931f26</span><span class="err">@apache.org</span><span class="nt">&gt;</span>"; start-info="text/xml"  
SOAPAction: "urn:uploadFileUsingMTOM"  
User-Agent: Axis2  
Host: 127.0.0.1:8280  
Transfer-Encoding: chunked
210e  
\--MIMEBoundary_6b43ce2cbb2f537bc614ca2667f80dd0906a861a70931f26  
Content-Type: application/xop+xml; charset=UTF-8; type="text/xml"  
Content-Transfer-Encoding: binary  
Content-ID: <span class="nt">&lt;0.1b43ce2cbb2f537bc614ca2667f80dd0906a861a70931f26</span><span class="err">@apache.org</span><span class="nt">&gt;</span>
<span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>  
<span class="nt">&lt;soapenv:Envelope</span> <span class="na">xmlns:soapenv=</span><span class="s">"http://schemas.xmlsoap.org/soap/envelope/"</span><span class="nt">&gt;</span>  
<span class="nt">&lt;soapenv:Header</span> <span class="na">xmlns:wsa=</span><span class="s">"http://www.w3.org/2005/08/addressing"</span><span class="nt">&gt;</span>  
<span class="nt">&lt;wsa:To&gt;</span>http://localhost:8280/services/MTOMSwASampleService<span class="nt">&lt;/wsa:To&gt;</span>  
<span class="nt">&lt;wsa:MessageID&gt;</span>urn:uuid:526d38f6-510c-4e9e-9a0b-93ff70c8d0eb<span class="nt">&lt;/wsa:MessageID&gt;</span>  
<span class="nt">&lt;wsa:Action&gt;</span>urn:uploadFileUsingMTOM<span class="nt">&lt;/wsa:Action&gt;</span>  
<span class="nt">&lt;/soapenv:Header&gt;</span>  
<span class="nt">&lt;soapenv:Body&gt;</span>  
<span class="nt">&lt;m0:uploadFileUsingMTOM</span> <span class="na">xmlns:m0=</span><span class="s">"http://services.samples"</span><span class="nt">&gt;</span>  
<span class="nt">&lt;m0:request&gt;</span>  
<span class="nt">&lt;m0:image&gt;</span>  
<span class="nt">&lt;xop:Include</span> <span class="na">xmlns:xop=</span><span class="s">"http://www.w3.org/2004/08/xop/include"</span> <span class="na">href=</span><span class="s">"cid:1.0b43ce2cbb2f537bc614ca2667f80dd0906a861a70931f26@apache.org"</span><span class="nt">&gt;</span>  
<span class="nt">&lt;/xop:Include&gt;</span>  
<span class="nt">&lt;/m0:image&gt;</span>  
<span class="nt">&lt;/m0:request&gt;</span>  
<span class="nt">&lt;/m0:uploadFileUsingMTOM&gt;</span>  
<span class="nt">&lt;/soapenv:Body&gt;</span>  
<span class="nt">&lt;/soapenv:Envelope&gt;</span>  
\--MIMEBoundary_6b43ce2cbb2f537bc614ca2667f80dd0906a861a70931f26  
Content-Type: application/octet-stream  
Content-Transfer-Encoding: binary  
Content-ID: <span class="nt">&lt;1.0b43ce2cbb2f537bc614ca2667f80dd0906a861a70931f26</span><span class="err">@apache.org</span><span class="nt">&gt;</span>
GIF89a ...<span class="err">&lt;</span><span class="nt">&lt;binary-content&gt;</span>&gt;  
...  
\--MIMEBoundary_6b43ce2cbb2f537bc614ca2667f80dd0906a861a70931f26--
0  

</code></pre></div></div>

<p><strong>MTOM SOAP response message:</strong></p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 200 OK  
messageType: multipart/related  
Content-Type: multipart/related; boundary="MIMEBoundary_1773747b8c9584bd1c67c2029eb620e46671585360cbb85a"; type="application/xop+xml"; start="<span class="nt">&lt;0.0773747b8c9584bd1c67c2029eb620e46671585360cbb85a</span><span class="err">@apache.org</span><span class="nt">&gt;</span>"; start-info="text/xml"  
Date: Wed, 30 Apr 2014 11:57:35 GMT  
Server: WSO2-PassThrough-HTTP  
Transfer-Encoding: chunked
1ff4  
\--MIMEBoundary_1773747b8c9584bd1c67c2029eb620e46671585360cbb85a  
Content-Type: application/xop+xml; charset=UTF-8; type="text/xml"  
Content-Transfer-Encoding: binary  
Content-ID: <span class="nt">&lt;0.0773747b8c9584bd1c67c2029eb620e46671585360cbb85a</span><span class="err">@apache.org</span><span class="nt">&gt;</span>
<span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><span class="nt">&lt;soapenv:Envelope</span> <span class="na">xmlns:soapenv=</span><span class="s">"http://schemas.xmlsoap.org/soap/envelope/"</span><span class="nt">&gt;&lt;soapenv:Body&gt;&lt;m0:uploadFileUsingMTOMResponse</span> <span class="na">xmlns:m0=</span><span class="s">"http://services.samples"</span><span class="nt">&gt;&lt;m0:response&gt;&lt;m0:image&gt;&lt;xop:Include</span> <span class="na">xmlns:xop=</span><span class="s">"http://www.w3.org/2004/08/xop/include"</span> <span class="na">href=</span><span class="s">"cid:1.3773747b8c9584bd1c67c2029eb620e46671585360cbb85a@apache.org"</span><span class="nt">&gt;&lt;/xop:Include&gt;&lt;/m0:image&gt;&lt;/m0:response&gt;&lt;/m0:uploadFileUsingMTOMResponse&gt;&lt;/soapenv:Body&gt;&lt;/soapenv:Envelope&gt;</span>  
\--MIMEBoundary_1773747b8c9584bd1c67c2029eb620e46671585360cbb85a  
Content-Type: application/octet-stream  
Content-Transfer-Encoding: binary  
Content-ID: <span class="nt">&lt;1.3773747b8c9584bd1c67c2029eb620e46671585360cbb85a</span><span class="err">@apache.org</span><span class="nt">&gt;</span>
GIF89a ...<span class="err">&lt;</span><span class="nt">&lt;binary-content&gt;</span>&gt;  
...  
\--MIMEBoundary_1773747b8c9584bd1c67c2029eb620e46671585360cbb85a--
0  
</code></pre></div></div>

<h2 id="vii-usando-soapui-para-envio-de-mensajes-mtom-soap-directamente-a-axis2-server">VII. Usando SoapUI para envio de mensajes MTOM SOAP directamente a Axis2 server.</h2>

<p>Para poder usar un cliente SOAP como SoapUI en este ejemplo, necesitamos el endpoint que representa al servicio expuesto a través del Axis2 server, la acción/operación a invocar y un mensaje SOAP MTOM de ejemplo. En otras palabras, necesitamos el WSDL.<br />
Sabemos que los servicios de back-end están desplegados sobre Axis2 server, pues si accedemos a la web de Axis2 server nos mostrará los servicios expuestos y sus respectivos WSDL, si los tienen.
Las URLs de la web de Axis2 server son:</p>
<ul>
  <li>HTTP: http://localhost:9000/services</li>
  <li>HTTPS: https://localhost:9002/services</li>
</ul>

<p>En el caso que no exista WSDL o necesitemos exponer el mismo servicio usando otro contrato, pues podemos crear un Proxy nuevo de tipo Pass Through en WSO2 ESB a partir del fichero synapse <code class="highlighter-rouge">&lt;ESB_HOME&gt;\repository\samples\synapse_sample_51.xml</code>, en dicho Proxy nuevo debemos indicarle el nuevo WSDL que vamos a emplear.
Entonces, el WSDL para el back-end servicio MTOMSwASampleService estará en esta URL:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://localhost:9000/services/MTOMSwASampleService?wsdl  
</code></pre></div></div>

<p>Recordar que deberá existir 3 operaciones disponibles y que SoapUI deberá generar automáticamente 3 request:</p>
<ul>
  <li>oneWayUploadUsingMTOM</li>
  <li>uploadFileUsingMTOM</li>
  <li>uploadFileUsingSwA</li>
</ul>

<p><img src="/assets/blog20140430_wso2_mtom/wso2-esb-mtom-MTOMSwASampleService-soapui-01.png" alt="MTOMSwASampleService operaciones" width="70%" /><br />
<em>MTOMSwASampleService operaciones</em></p>

<p>Desde SoapUI hacemos “request SOAP” para la operación uploadFileUsingMTOM indicando como endpoint a <a href="http://localhost:9000/services/MTOMSwASampleService">http://localhost:9000/services/MTOMSwASampleService</a>, el mensaje SOAP es el siguiente:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;soapenv:Envelope</span>  
<span class="na">xmlns:soapenv=</span><span class="s">"http://schemas.xmlsoap.org/soap/envelope/"</span>  
<span class="na">xmlns:ser=</span><span class="s">"http://services.samples"</span><span class="nt">&gt;</span>  
<span class="nt">&lt;soapenv:Header/&gt;</span>  
<span class="nt">&lt;soapenv:Body&gt;</span>  
<span class="nt">&lt;ser:uploadFileUsingMTOM&gt;</span>  
<span class="nt">&lt;ser:request&gt;</span>  
<span class="nt">&lt;ser:image&gt;</span>cid:chilcano.jpg<span class="nt">&lt;/ser:image&gt;</span>  
<span class="nt">&lt;/ser:request&gt;</span>  
<span class="nt">&lt;/ser:uploadFileUsingMTOM&gt;</span>  
<span class="nt">&lt;/soapenv:Body&gt;</span>  
<span class="nt">&lt;/soapenv:Envelope&gt;</span>  
</code></pre></div></div>

<p>Debemos habilitar en SoapUI las “Request Properties” para MTOM:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Enable MTOM = true  
</code></pre></div></div>

<p>Luego en la pestaña “Attachments” (ubicado al pie de la ventana Request en el SoapUI) anexar el fichero que deseamos enviar junto al mensaje SOAP.<br />
En este caso el fichero será “chilcano.jpg”.
Ahora, ya estamos listos para lanzar la petición a la implementación del servicio “MTOMSwASampleService” alojado en Axis2 server.<br />
Al final, siguiendo el comportamiento de la acción/operación “uploadFileUsingMTOM”, el fichero “chilcano.jpg” debe ser enviado por SoapUI y recibido por Axis2 server, el mismo fichero debe ser retornado como fichero anexado al response MTOM SOAP message, para verificarlo basta con comprobar si existe algún fichero anexado en la pestaña “Attachments” del Response.</p>

<p><img src="/assets/blog20140430_wso2_mtom/wso2-esb-mtom-MTOMSwASampleService-soapui-02-uploadFileUsingMTOM.png" alt="Haciendo MTOM SOAP request a uploadFileUsingMTOM" width="90%" /> <br />
<em>Haciendo MTOM SOAP request a uploadFileUsingMTOM</em></p>

<h2 id="viii-usando-soapui-para-envio-de-mensajes-mtom-soap-a-través-de-un-pass-through-proxy-en-wso2-esb">VIII. Usando SoapUI para envio de mensajes MTOM SOAP a través de un Pass Through Proxy en WSO2 ESB.</h2>

<p>En este caso implementaremos un Proxy, pero para fines demostrativos mantendremos el contrato original.<br />
Y según dicho contrato, el servicio tendrá 3 acciones/operaciones (oneWayUploadUsingMTOM, uploadFileUsingMTOM y uploadFileUsingSwA).
El Proxy que crearemos en WSO2 ESB será el siguiente y usará el WSDL expuesto desde Axis2:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>  
<span class="nt">&lt;proxy</span> <span class="na">xmlns=</span><span class="s">"http://ws.apache.org/ns/synapse"</span>  
<span class="na">name=</span><span class="s">"proxy_MTOMSwASampleService"</span>  
<span class="na">transports=</span><span class="s">"https,http"</span>  
<span class="na">statistics=</span><span class="s">"disable"</span>  
<span class="na">trace=</span><span class="s">"disable"</span>  
<span class="na">startOnLoad=</span><span class="s">"true"</span><span class="nt">&gt;</span>  
<span class="nt">&lt;target&gt;</span>  
<span class="nt">&lt;inSequence&gt;</span>  
<span class="nt">&lt;log</span> <span class="na">level=</span><span class="s">"custom"</span><span class="nt">&gt;</span>  
<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"====== Proxy-MTOMSwASampleService"</span> <span class="na">value=</span><span class="s">"====== inSeq - ini"</span><span class="nt">/&gt;</span>  
<span class="nt">&lt;/log&gt;</span>  
<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"POST_TO_URI"</span> <span class="na">value=</span><span class="s">"true"</span> <span class="na">scope=</span><span class="s">"default"</span> <span class="na">type=</span><span class="s">"STRING"</span><span class="nt">/&gt;</span>  
<span class="nt">&lt;filter</span> <span class="na">source=</span><span class="s">"get-property('Action')"</span> <span class="na">regex=</span><span class="s">"urn:uploadFileUsingMTOM"</span><span class="nt">&gt;</span>  
<span class="nt">&lt;then&gt;</span>  
<span class="nt">&lt;header</span> <span class="na">name=</span><span class="s">"Action"</span> <span class="na">scope=</span><span class="s">"default"</span> <span class="na">action=</span><span class="s">"remove"</span><span class="nt">/&gt;</span>  
<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"SOAPAction"</span> <span class="na">scope=</span><span class="s">"default"</span> <span class="na">action=</span><span class="s">"remove"</span><span class="nt">/&gt;</span>  
<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"example"</span> <span class="na">value=</span><span class="s">"mtom"</span><span class="nt">/&gt;</span>  
<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"Action"</span> <span class="na">value=</span><span class="s">"urn:uploadFileUsingMTOM"</span> <span class="na">scope=</span><span class="s">"default"</span><span class="nt">/&gt;</span>  
<span class="nt">&lt;header</span> <span class="na">name=</span><span class="s">"Action"</span> <span class="na">scope=</span><span class="s">"default"</span> <span class="na">value=</span><span class="s">"urn:uploadFileUsingMTOM"</span><span class="nt">/&gt;</span>  
<span class="nt">&lt;send&gt;</span>  
<span class="nt">&lt;endpoint&gt;</span>  
<span class="nt">&lt;address</span> <span class="na">uri=</span><span class="s">"http://localhost:9001/services/MTOMSwASampleService"</span>  
<span class="na">optimize=</span><span class="s">"mtom"</span><span class="nt">/&gt;</span>  
<span class="nt">&lt;/endpoint&gt;</span>  
<span class="nt">&lt;/send&gt;</span>  
<span class="nt">&lt;/then&gt;</span>  
<span class="nt">&lt;else/&gt;</span>  
<span class="nt">&lt;/filter&gt;</span>  
<span class="nt">&lt;filter</span> <span class="na">source=</span><span class="s">"get-property('Action')"</span> <span class="na">regex=</span><span class="s">"urn:uploadFileUsingSwA"</span><span class="nt">&gt;</span>  
<span class="nt">&lt;then&gt;</span>  
<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"example"</span> <span class="na">value=</span><span class="s">"swa"</span><span class="nt">/&gt;</span>  
<span class="nt">&lt;send&gt;</span>  
<span class="nt">&lt;endpoint&gt;</span>  
<span class="nt">&lt;address</span> <span class="na">uri=</span><span class="s">"http://localhost:9000/services/MTOMSwASampleService"</span>  
<span class="na">optimize=</span><span class="s">"swa"</span><span class="nt">/&gt;</span>  
<span class="nt">&lt;/endpoint&gt;</span>  
<span class="nt">&lt;/send&gt;</span>  
<span class="nt">&lt;/then&gt;</span>  
<span class="nt">&lt;else/&gt;</span>  
<span class="nt">&lt;/filter&gt;</span>  
<span class="nt">&lt;filter</span> <span class="na">source=</span><span class="s">"get-property('Action')"</span> <span class="na">regex=</span><span class="s">"urn:oneWayUploadUsingMTOM"</span><span class="nt">&gt;</span>  
<span class="nt">&lt;then&gt;</span>  
<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"OUT_ONLY"</span> <span class="na">value=</span><span class="s">"true"</span><span class="nt">/&gt;</span>  
<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"FORCE_SC_ACCEPTED"</span> <span class="na">value=</span><span class="s">"true"</span> <span class="na">scope=</span><span class="s">"axis2"</span><span class="nt">/&gt;</span>  
<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"example"</span> <span class="na">value=</span><span class="s">"onewaymtom"</span><span class="nt">/&gt;</span>  
<span class="nt">&lt;send&gt;</span>  
<span class="nt">&lt;endpoint&gt;</span>  
<span class="nt">&lt;address</span> <span class="na">uri=</span><span class="s">"http://localhost:9001/services/MTOMSwASampleService"</span>  
<span class="na">optimize=</span><span class="s">"mtom"</span><span class="nt">/&gt;</span>  
<span class="nt">&lt;/endpoint&gt;</span>  
<span class="nt">&lt;/send&gt;</span>  
<span class="nt">&lt;/then&gt;</span>  
<span class="nt">&lt;else/&gt;</span>  
<span class="nt">&lt;/filter&gt;</span>  
<span class="nt">&lt;log</span> <span class="na">level=</span><span class="s">"custom"</span><span class="nt">&gt;</span>  
<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"Proxy MTOMSwASampleService"</span> <span class="na">value=</span><span class="s">"================ inSeq - fin"</span><span class="nt">/&gt;</span>  
<span class="nt">&lt;/log&gt;</span>  
<span class="nt">&lt;/inSequence&gt;</span>  
<span class="nt">&lt;outSequence&gt;</span>  
<span class="nt">&lt;log</span> <span class="na">level=</span><span class="s">"custom"</span><span class="nt">&gt;</span>  
<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"====== Proxy MTOMSwASampleService"</span> <span class="na">value=</span><span class="s">"====== outSeq - ini"</span><span class="nt">/&gt;</span>  
<span class="nt">&lt;/log&gt;</span>  
<span class="nt">&lt;filter</span> <span class="na">source=</span><span class="s">"get-property('example')"</span> <span class="na">regex=</span><span class="s">"onewaymtom"</span><span class="nt">&gt;</span>  
<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"enableMTOM"</span> <span class="na">value=</span><span class="s">"true"</span> <span class="na">scope=</span><span class="s">"axis2"</span><span class="nt">/&gt;</span>  
<span class="nt">&lt;/filter&gt;</span>  
<span class="nt">&lt;filter</span> <span class="na">source=</span><span class="s">"get-property('example')"</span> <span class="na">regex=</span><span class="s">"mtom"</span><span class="nt">&gt;</span>  
<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"enableMTOM"</span> <span class="na">value=</span><span class="s">"true"</span> <span class="na">scope=</span><span class="s">"axis2"</span><span class="nt">/&gt;</span>  
<span class="nt">&lt;/filter&gt;</span>  
<span class="nt">&lt;filter</span> <span class="na">source=</span><span class="s">"get-property('example')"</span> <span class="na">regex=</span><span class="s">"swa"</span><span class="nt">&gt;</span>  
<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"enableSwA"</span> <span class="na">value=</span><span class="s">"true"</span> <span class="na">scope=</span><span class="s">"axis2"</span><span class="nt">/&gt;</span>  
<span class="nt">&lt;/filter&gt;</span>  
<span class="nt">&lt;send/&gt;</span>  
<span class="nt">&lt;log</span> <span class="na">level=</span><span class="s">"custom"</span><span class="nt">&gt;</span>  
<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"====== Proxy MTOMSwASampleService"</span> <span class="na">value=</span><span class="s">"====== outSeq - fin"</span><span class="nt">/&gt;</span>  
<span class="nt">&lt;/log&gt;</span>  
<span class="nt">&lt;/outSequence&gt;</span>  
<span class="nt">&lt;/target&gt;</span>  
<span class="nt">&lt;publishWSDL</span> <span class="na">uri=</span><span class="s">"http://localhost:9000/services/MTOMSwASampleService?wsdl"</span><span class="nt">/&gt;</span>  
<span class="nt">&lt;parameter</span> <span class="na">name=</span><span class="s">"enableMTOM"</span><span class="nt">&gt;</span>true<span class="nt">&lt;/parameter&gt;</span>  
<span class="nt">&lt;description&gt;</span>MTOMSwASampleService (Sample 51)<span class="nt">&lt;/description&gt;</span>  
<span class="nt">&lt;/proxy&gt;</span>  
</code></pre></div></div>
<p>En este caso, el nuevo WSDL estará servido desde el WSO2 ESB cuando despleguemos el Proxy, será la siguiente URL:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://localhost:8283/services/proxy_MTOMSwASampleService?wsdl  
</code></pre></div></div>

<p>La ventaja de usar un Pass Through Proxy es porder mediar (manipular, transformar, ruteo, etc.) el request/response, y también para un debugging más exacto empleando el mediador de LOG.
Si ahora creamos un nuevo proyecto con el Proxy, el proyecto sería el siguiente:</p>

<p><img src="/assets/blog20140430_wso2_mtom/wso2-esb-mtom-MTOMSwASampleService-soapui-03-proxy.png" alt="Proyecto SoapUI: Proxy MTOMSwASampleService" width="50%" /><br />
<em>Proyecto SoapUI: Proxy MTOMSwASampleService</em></p>

<p>Los request message para cada operación son los siguientes.</p>

<p><strong>Request message para oneWayUploadUsingMTOM</strong> :</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;soapenv:Envelope</span>  
<span class="na">xmlns:soapenv=</span><span class="s">"http://schemas.xmlsoap.org/soap/envelope/"</span>  
<span class="na">xmlns:ser=</span><span class="s">"http://services.samples"</span><span class="nt">&gt;</span>  
<span class="nt">&lt;soapenv:Header/&gt;</span>  
<span class="nt">&lt;soapenv:Body&gt;</span>  
<span class="nt">&lt;ser:oneWayUploadUsingMTOM&gt;</span>cid:chilcano.jpg<span class="nt">&lt;/ser:oneWayUploadUsingMTOM&gt;</span>  
<span class="nt">&lt;/soapenv:Body&gt;</span>  
<span class="nt">&lt;/soapenv:Envelope&gt;</span>  
</code></pre></div></div>

<p><strong>Request message SOAP para uploadFileUsingMTOM:</strong></p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;soapenv:Envelope</span> <span class="na">xmlns:soapenv=</span><span class="s">"http://schemas.xmlsoap.org/soap/envelope/"</span><span class="nt">&gt;</span>  
<span class="nt">&lt;soapenv:Body&gt;</span>  
<span class="nt">&lt;m0:uploadFileUsingMTOMResponse</span> <span class="na">xmlns:m0=</span><span class="s">"http://services.samples"</span><span class="nt">&gt;</span>  
<span class="nt">&lt;m0:response&gt;</span>  
<span class="nt">&lt;m0:image&gt;</span>  
<span class="nt">&lt;xop:Include</span> <span class="na">href=</span><span class="s">"cid:1.c83f1f7b0058d225ca82b4f9a5875be65b9d20debd92abe8@apache.org"</span> <span class="na">xmlns:xop=</span><span class="s">"http://www.w3.org/2004/08/xop/include"</span><span class="nt">/&gt;</span>  
<span class="nt">&lt;/m0:image&gt;</span>  
<span class="nt">&lt;/m0:response&gt;</span>  
<span class="nt">&lt;/m0:uploadFileUsingMTOMResponse&gt;</span>  
<span class="nt">&lt;/soapenv:Body&gt;</span>  
<span class="nt">&lt;/soapenv:Envelope&gt;</span>  
</code></pre></div></div>

<p><strong>El mensaje request SOAP para uploadFileUsingSwA usado es:</strong></p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;soapenv:Envelope</span>  
<span class="na">xmlns:soapenv=</span><span class="s">"http://schemas.xmlsoap.org/soap/envelope/"</span>  
<span class="na">xmlns:ser=</span><span class="s">"http://services.samples"</span><span class="nt">&gt;</span>  
<span class="nt">&lt;soapenv:Header/&gt;</span>  
<span class="nt">&lt;soapenv:Body&gt;</span>  
<span class="nt">&lt;ser:uploadFileUsingSwA&gt;</span>  
<span class="nt">&lt;ser:request&gt;</span>  
<span class="nt">&lt;ser:imageId&gt;</span>tux-mario.jpg<span class="nt">&lt;/ser:imageId&gt;</span>  
<span class="nt">&lt;/ser:request&gt;</span>  
<span class="nt">&lt;/ser:uploadFileUsingSwA&gt;</span>  
<span class="nt">&lt;/soapenv:Body&gt;</span>  
<span class="nt">&lt;/soapenv:Envelope&gt;</span>  
</code></pre></div></div>

<p>Y en el lado de Axis2 Server veremos las siguientes trazas:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./axis2server.sh  
Using JAVA_HOME: /Library/Java/JavaVirtualMachines/jdk1.7.0_51.jdk/Contents/Home  
Using AXIS2 Repository : /Users/Chilcano/0dev-env/2srv/wso2esb-4.8.1/samples/axis2Server/repository  
Using AXIS2 Configuration : /Users/Chilcano/0dev-env/2srv/wso2esb-4.8.1/samples/axis2Server/repository/conf/axis2.xml  
14/05/12 15:46:47 INFO util.SampleAxis2ServerManager: [SimpleAxisServer] Starting  

[...]  
14/05/12 15:46:48 INFO nhttp.HttpCoreNIOListener: HTTPS Listener started on 0:0:0:0:0:0:0:0:9002  
14/05/12 15:46:48 INFO nhttp.HttpCoreNIOListener: HTTP Listener started on 0:0:0:0:0:0:0:0:9000  
14/05/12 15:46:48 INFO util.SampleAxis2ServerManager: [SimpleAxisServer] Started  

[...]  
Wrote to file : /Users/Chilcano/0dev-env/2srv/wso2esb-4.8.1/samples/axis2Server/../../tmp/sampleServer/mtom-6291717480475442754.gif  
Wrote MTOM content to temp file : /Users/Chilcano/0dev-env/2srv/wso2esb-4.8.1/samples/axis2Server/../../tmp/sampleServer/mtom-7105409971701841709.gif  
Wrote SwA attachment to temp file : /Users/Chilcano/0dev-env/2srv/wso2esb-4.8.1/samples/axis2Server/../../tmp/sampleServer/swa-5320928313738320843.gif  
</code></pre></div></div>

<h2 id="ix-enviando-binarydata-desde-un-form-html-a-servicio-soap">IX. Enviando BinaryData desde un Form HTML a servicio SOAP.</h2>

<p>SOAP usa comúnmente HTTP como transporte, SOAP MTOM también usa lo mismo y el ejemplo “Sample 51” también. En lugar de usar SoapUI por qué no empleamos un formulario HTML para enviar el un fichero pero usando un formulario del tipo <code class="highlighter-rouge">multipart/form-data</code>?.<br />
Creo que sería la forma más natural para enviar ficheros, además sabiendo que la especificación HTTP desde inicios implementa el envío vía <code class="highlighter-rouge">multipart/form-data</code>, por qué no seguir haciéndolo?.
Dicho esto, vamos a implementar un formulario HTML para este propósito, luego, aprovechando que tenemos desplegado el “Sample 51” en WSO2 ESB y “MTOMSwASampleService” desplegado en Axis2 Server, vamos a crear un simple Form HTML con <code class="highlighter-rouge">mutipart/form-data</code>, crearemos un nuevo Pass Through Proxy que recibirá la petición del Form HTML y reenviará una petición SOAP al Proxy creado al inicio de esta entrada pero con unas pequeñas modificaciones.
También será necesario modificar la implementación de “MTOMSwASampleService” para implementar una nueva operación que sepa decondificar la nueva petición efectuada desde un Form HTML.</p>

<p>El siguiente gráfico representa la situación final:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[HTML Form]=&gt;[ msg HTTP]=&gt;[Proxy 01]=&gt;[msg-soap]=&gt;[Proxy 02]=&gt;[msg SOAP]=&gt;[  SOAP req  ]
             [multipart]  [WSO2 ESB]  [ base64 ]  [WSO2 ESB]  [ base64 ]  [Axis2 Server]
             [form-data]                                      [or MTOM ]  
</code></pre></div></div>

<p>Pues los proxies de WSO2 ESB nuevos y actualizados, el Form HTML, el servicio <code class="highlighter-rouge">MTOMSwASampleService</code> modificado <a href="/2014/05/14/mtom-en-wso2-e…re-soap-parte1">los publicaré en un segundo post en este blog</a>.</p>

<p>Asi que siga sintonizado :)</p>

<h2 id="x-conclusiones">X. Conclusiones.</h2>

<ul>
  <li>En un escenario SOA lo más probable es que todo sean servicios implementados en SOAP y si se requiere enviar de manera optimizada ficheros en formato binario de manera óptima y de una forma estándar, lo recomendable es usar MTOM sobre SOAP.</li>
  <li>Si estamos fuera de un proyecto SOA, podemos disponer de opciones como FTP, VFS o Formulario HTML con CGI en el lado servidor.</li>
  <li>Hay que destacar que el uso de MTOM sobre SOAP es un forma de envio de ficheros en binario de una manera óptima y eficiente, además el envío de ficheros grandes también sigue siendo de una manera óptima. Si estáis buscando el envío de grandes volúmenes de ficheros grandes, considerar MTOM sobre SOAP como una buena opción.</li>
</ul>

<h2 id="xi-referencias">XI. Referencias.</h2>

<ul>
  <li><a href="https://docs.wso2.org/pages/viewpage.action?pageId=33136025">WSO2 ESB: Sample 51: MTOM and SwA Optimizations and Request/Response Correlation</a></li>
  <li><a href="http://www.soapui.org/SOAP-and-WSDL/adding-headers-and-attachments.html">SoapUI: Adding Headers and Attachments</a></li>
</ul>

  </div><div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'https://holisticsecurity.io/2014/05/14/mtom-en-wso2-esb-para-optimizar-la-transferencia-de-datos-binarios-sobre-soap-parte1/';
      this.page.identifier = 'https://holisticsecurity.io/2014/05/14/mtom-en-wso2-esb-para-optimizar-la-transferencia-de-datos-binarios-sobre-soap-parte1/';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://holosec.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript><a class="u-url" href="/2014/05/14/mtom-en-wso2-esb-para-optimizar-la-transferencia-de-datos-binarios-sobre-soap-parte1/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading"><img src="/assets/img/logo-holosec.png" width="40" /> Holistic Security</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Holistic Security</li><li><a class="u-email" href="mailto:blog@holisticsecurity.io">blog@holisticsecurity.io</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/Chilcano"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">Chilcano</span></a></li><li><a href="https://www.linkedin.com/in/Chilcano"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">Chilcano</span></a></li><li><a href="https://www.twitter.com/Chilcano"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">Chilcano</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Systems Thinking, Holism, Trust, Security &amp; Usability.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
