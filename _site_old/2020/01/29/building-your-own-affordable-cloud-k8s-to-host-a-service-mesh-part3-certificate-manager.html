<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Building your own affordable K8s to host a Service Mesh - Part 3: Certificate Manager | Holistic Security</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Building your own affordable K8s to host a Service Mesh - Part 3: Certificate Manager" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="In this blog post I’ll explain how to get a X.509 TLS Certificate from Let’s Encrypt automatically during the Terraform provision time, in this way we can now invoke the services additionally on port 443 (HTTPS/TLS). During the Terraform execution, immediately after Kubernetes Cluster creation, the JetStack Cert-Manager is deployed in a Pod, it is who will request to Let’s Encrypt service a X.509 TLS Certificate, once completed, the JetStack Cert-Manager will inject the X.509 Certificate as a Kubernetes Secret into NGINX Ingress Controller to enbale TLS. At this point you must have created a Kubernetes Cluster with ExternalDNS and NGINX as Ingress Controller. If you don’t know how to achieve that, I recommend to follow these posts: Part 1 - Building your own affordable K8s to host a Service Mesh. Part 2 - Building your own affordable K8s - ExternalDNS and NGINX as Ingress." />
<meta property="og:description" content="In this blog post I’ll explain how to get a X.509 TLS Certificate from Let’s Encrypt automatically during the Terraform provision time, in this way we can now invoke the services additionally on port 443 (HTTPS/TLS). During the Terraform execution, immediately after Kubernetes Cluster creation, the JetStack Cert-Manager is deployed in a Pod, it is who will request to Let’s Encrypt service a X.509 TLS Certificate, once completed, the JetStack Cert-Manager will inject the X.509 Certificate as a Kubernetes Secret into NGINX Ingress Controller to enbale TLS. At this point you must have created a Kubernetes Cluster with ExternalDNS and NGINX as Ingress Controller. If you don’t know how to achieve that, I recommend to follow these posts: Part 1 - Building your own affordable K8s to host a Service Mesh. Part 2 - Building your own affordable K8s - ExternalDNS and NGINX as Ingress." />
<link rel="canonical" href="https://holisticsecurity.io/2020/01/29/building-your-own-affordable-cloud-k8s-to-host-a-service-mesh-part3-certificate-manager" />
<meta property="og:url" content="https://holisticsecurity.io/2020/01/29/building-your-own-affordable-cloud-k8s-to-host-a-service-mesh-part3-certificate-manager" />
<meta property="og:site_name" content="Holistic Security" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-01-29T10:00:00+01:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://holisticsecurity.io/2020/01/29/building-your-own-affordable-cloud-k8s-to-host-a-service-mesh-part3-certificate-manager"},"url":"https://holisticsecurity.io/2020/01/29/building-your-own-affordable-cloud-k8s-to-host-a-service-mesh-part3-certificate-manager","headline":"Building your own affordable K8s to host a Service Mesh - Part 3: Certificate Manager","dateModified":"2020-01-29T10:00:00+01:00","datePublished":"2020-01-29T10:00:00+01:00","description":"In this blog post I’ll explain how to get a X.509 TLS Certificate from Let’s Encrypt automatically during the Terraform provision time, in this way we can now invoke the services additionally on port 443 (HTTPS/TLS). During the Terraform execution, immediately after Kubernetes Cluster creation, the JetStack Cert-Manager is deployed in a Pod, it is who will request to Let’s Encrypt service a X.509 TLS Certificate, once completed, the JetStack Cert-Manager will inject the X.509 Certificate as a Kubernetes Secret into NGINX Ingress Controller to enbale TLS. At this point you must have created a Kubernetes Cluster with ExternalDNS and NGINX as Ingress Controller. If you don’t know how to achieve that, I recommend to follow these posts: Part 1 - Building your own affordable K8s to host a Service Mesh. Part 2 - Building your own affordable K8s - ExternalDNS and NGINX as Ingress.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://holisticsecurity.io/feed.xml" title="Holistic Security" /><script>
if(!(window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1")) {
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-156433649-1', 'auto');
  ga('send', 'pageview');
}
</script>
  
</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/"><img src="/assets/img/logo-holosec.png" width="100" /> Holistic Security</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/">Home</a><a class="page-link" href="/blog/">Blog</a><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Building your own affordable K8s to host a Service Mesh - Part 3: Certificate Manager</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2020-01-29T10:00:00+01:00" itemprop="datePublished">Jan 29, 2020 
      </time>&sim; CLOUD · APAAS · SERVICE MESH
      &sim; AWS · DOCKER · KUBERNETES · DATA PLANE · MICROSERVICE · X509 · PKI
    </p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>In this blog post I’ll explain how to get a X.509 TLS Certificate from <a href="https://letsencrypt.org" target="_blank">Let’s Encrypt</a> automatically during the Terraform provision time, in this way we can now invoke the services additionally on port 443 (HTTPS/TLS).<br />
During the Terraform execution, immediately after Kubernetes Cluster creation, the <a href="https://github.com/jetstack/cert-manager" target="_blank">JetStack Cert-Manager</a> is deployed in a Pod, it is who will request to <a href="https://letsencrypt.org" target="_blank">Let’s Encrypt</a> service a X.509 TLS Certificate, once completed, the <a href="https://github.com/jetstack/cert-manager" target="_blank">JetStack Cert-Manager</a> will inject the X.509 Certificate as a Kubernetes Secret into NGINX Ingress Controller to enbale TLS.</p>

<p>At this point you must have created a Kubernetes Cluster with ExternalDNS and NGINX as Ingress Controller. If you don’t know how to achieve that, I recommend to follow these posts:</p>

<ul>
  <li><a href="http://holisticsecurity.io/2020/01/16/building-your-own-affordable-cloud-k8s-to-host-a-service-mesh-data-plane" target="_blank">Part 1 - Building your own affordable K8s to host a Service Mesh</a>.</li>
  <li><a href="http://holisticsecurity.io/2020/01/22/building-your-own-affordable-cloud-k8s-to-host-a-service-mesh-part2-external-dns-ingress" target="_blank">Part 2 - Building your own affordable K8s - ExternalDNS and NGINX as Ingress</a>.</li>
</ul>

<p><a href="/assets/img/20200129-affordablek8s-aws-01-arch-ingress-dns-tls-cert-manager.png" target="_blank"><img src="/assets/img/20200129-affordablek8s-aws-01-arch-ingress-dns-tls-cert-manager.png" alt="K8s Cluster created using AWS Spot Instances - Cert-Manager and Let's Encrypt" title="K8s Cluster created using AWS Spot Instances - Cert-Manager and Let's Encrypt" /></a></p>

<!-- more -->

<h2 id="steps">Steps</h2>

<h3 id="1-cleaning-everything">1. Cleaning everything</h3>

<p>If you are using the Terraform scripts to create an affordable K8s Cluster I’ve forked and updated for you, then first of all you should clean up to start creating a new fresh K8s Cluster for following this scenario.</p>

<blockquote>
  <p>If you want a cheap K8s Infrastructure on AWS, I recommend to use this GitHub repo I’ve updated for you:
<a href="https://github.com/chilcano/kubeadm-aws/tree/0.2.1-chilcano">https://github.com/chilcano/kubeadm-aws/tree/0.2.1-chilcano</a></p>
</blockquote>

<p>Removing existing K8s Cluster.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>terraform destroy <span class="se">\</span>
  <span class="nt">-var</span> cluster-name<span class="o">=</span><span class="s2">"cheapk8s"</span> <span class="se">\</span>
  <span class="nt">-var</span> k8s-ssh-key<span class="o">=</span><span class="s2">"ssh-key-for-us-east-1"</span> <span class="se">\</span>
  <span class="nt">-var</span> admin-cidr-blocks<span class="o">=</span><span class="s2">"83.50.13.174/32"</span> <span class="se">\</span>
  <span class="nt">-var</span> <span class="nv">region</span><span class="o">=</span><span class="s2">"us-east-1"</span> <span class="se">\</span>
  <span class="nt">-var</span> kubernetes-version<span class="o">=</span><span class="s2">"1.14.3"</span> <span class="se">\</span>
  <span class="nt">-var</span> external-dns-enabled<span class="o">=</span><span class="s2">"1"</span> <span class="se">\</span>
  <span class="nt">-var</span> nginx-ingress-enabled<span class="o">=</span><span class="s2">"1"</span> <span class="se">\</span>
  <span class="nt">-var</span> nginx-ingress-domain<span class="o">=</span><span class="s2">"ingress-nginx.cloud.holisticsecurity.io"</span> 
</code></pre></div></div>

<p>If you have destroyed the K8s Cluster with <code class="highlighter-rouge">terraform destroy</code>, likely you have to remove unwanted records (created for your services) in the AWS Hosted Zone.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">export </span><span class="nv">MY_SUBDOMAIN</span><span class="o">=</span><span class="s2">"cloud.holisticsecurity.io"</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">HZ_ID</span><span class="o">=</span><span class="si">$(</span>aws route53 list-hosted-zones-by-name <span class="nt">--dns-name</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MY_SUBDOMAIN</span><span class="k">}</span><span class="s2">."</span> | jq <span class="nt">-r</span> <span class="s1">'.HostedZones[0].Id'</span><span class="si">)</span>
<span class="nv">$ </span>aws route53 list-resource-record-sets <span class="nt">--hosted-zone-id</span> <span class="nv">$HZ_ID</span> <span class="nt">--query</span> <span class="s2">"ResourceRecordSets[?Name != '</span><span class="k">${</span><span class="nv">MY_SUBDOMAIN</span><span class="k">}</span><span class="s2">.']"</span> | jq <span class="nt">-c</span> <span class="s1">'.[]'</span> |
  <span class="k">while </span><span class="nb">read</span> <span class="nt">-r</span> RRS<span class="p">;</span> <span class="k">do
    </span><span class="nb">read</span> <span class="nt">-r</span> name <span class="nb">type</span> <span class="o">&lt;&lt;&lt;</span> <span class="si">$(</span>jq <span class="nt">-jr</span> <span class="s1">'.Name, " ", .Type'</span> <span class="o">&lt;&lt;&lt;</span> <span class="s2">"</span><span class="nv">$RRS</span><span class="s2">"</span><span class="si">)</span> 
    <span class="nv">CHG_ID</span><span class="o">=</span><span class="si">$(</span>aws route53 change-resource-record-sets <span class="nt">--hosted-zone-id</span> <span class="nv">$HZ_ID</span> <span class="nt">--change-batch</span> <span class="s1">'{"Changes":[{"Action":"DELETE","ResourceRecordSet": '</span><span class="s2">"</span><span class="nv">$RRS</span><span class="s2">"</span><span class="s1">' }]}'</span> <span class="nt">--output</span> text <span class="nt">--query</span> <span class="s1">'ChangeInfo.Id'</span><span class="si">)</span>
    <span class="nb">echo</span> <span class="s2">" - DELETING: </span><span class="nv">$type</span><span class="s2"> </span><span class="nv">$name</span><span class="s2"> - CHANGE ID: </span><span class="nv">$CHG_ID</span><span class="s2">"</span>    
  <span class="k">done</span>
</code></pre></div></div>

<p>For further details and an explanation about above step review this post:</p>
<ul>
  <li><a href="http://holisticsecurity.io/2020/01/22/building-your-own-affordable-cloud-k8s-to-host-a-service-mesh-part2-external-dns-ingress" target="_blank">Part 2 - Building your own affordable K8s - ExternalDNS and NGINX as Ingress</a>.</li>
</ul>

<h3 id="2-create-a-fresh-k8s-cluster-with-jetstack-cert-manager-installed">2. Create a fresh K8s Cluster with JetStack Cert-Manager installed</h3>

<p>Note the <code class="highlighter-rouge">cert-manager-enabled="1"</code> and <code class="highlighter-rouge">cert-manager-email="cheapk8s@holisticsecurity.io"</code> parameters which are required to create a Kubernetes Cluster with the <a href="https://github.com/jetstack/cert-manager" target="_blank">JetStack Cert-Manager</a> installed.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>terraform plan <span class="se">\</span>
  <span class="nt">-var</span> cluster-name<span class="o">=</span><span class="s2">"cheapk8s"</span> <span class="se">\</span>
  <span class="nt">-var</span> k8s-ssh-key<span class="o">=</span><span class="s2">"ssh-key-for-us-east-1"</span> <span class="se">\</span>
  <span class="nt">-var</span> admin-cidr-blocks<span class="o">=</span><span class="s2">"83.50.13.174/32"</span> <span class="se">\</span>
  <span class="nt">-var</span> <span class="nv">region</span><span class="o">=</span><span class="s2">"us-east-1"</span> <span class="se">\</span>
  <span class="nt">-var</span> kubernetes-version<span class="o">=</span><span class="s2">"1.14.3"</span> <span class="se">\</span>
  <span class="nt">-var</span> external-dns-enabled<span class="o">=</span><span class="s2">"1"</span> <span class="se">\</span>
  <span class="nt">-var</span> nginx-ingress-enabled<span class="o">=</span><span class="s2">"1"</span> <span class="se">\</span>
  <span class="nt">-var</span> nginx-ingress-domain<span class="o">=</span><span class="s2">"ingress-nginx.cloud.holisticsecurity.io"</span> <span class="se">\</span>
  <span class="nt">-var</span> cert-manager-enabled<span class="o">=</span><span class="s2">"1"</span> <span class="se">\</span>
  <span class="nt">-var</span> cert-manager-email<span class="o">=</span><span class="s2">"cheapk8s@holisticsecurity.io"</span> 

<span class="nv">$ </span>terraform apply <span class="se">\</span>
  <span class="nt">-var</span> cluster-name<span class="o">=</span><span class="s2">"cheapk8s"</span> <span class="se">\</span>
  <span class="nt">-var</span> k8s-ssh-key<span class="o">=</span><span class="s2">"ssh-key-for-us-east-1"</span> <span class="se">\</span>
  <span class="nt">-var</span> admin-cidr-blocks<span class="o">=</span><span class="s2">"83.50.13.174/32"</span> <span class="se">\</span>
  <span class="nt">-var</span> <span class="nv">region</span><span class="o">=</span><span class="s2">"us-east-1"</span> <span class="se">\</span>
  <span class="nt">-var</span> kubernetes-version<span class="o">=</span><span class="s2">"1.14.3"</span> <span class="se">\</span>
  <span class="nt">-var</span> external-dns-enabled<span class="o">=</span><span class="s2">"1"</span> <span class="se">\</span>
  <span class="nt">-var</span> nginx-ingress-enabled<span class="o">=</span><span class="s2">"1"</span> <span class="se">\</span>
  <span class="nt">-var</span> nginx-ingress-domain<span class="o">=</span><span class="s2">"ingress-nginx.cloud.holisticsecurity.io"</span> <span class="se">\</span>
  <span class="nt">-var</span> cert-manager-enabled<span class="o">=</span><span class="s2">"1"</span> <span class="se">\</span>
  <span class="nt">-var</span> cert-manager-email<span class="o">=</span><span class="s2">"cheapk8s@holisticsecurity.io"</span> 
</code></pre></div></div>

<h3 id="3-checking-recently-created-k8s-cluster-and-jetstack-cert-manager">3. Checking recently created K8s Cluster and JetStack Cert-Manager</h3>

<p><strong>1. Exploring the JetStack Cert-Manager resources created in the K8s Cluster</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Get SSH access to K8s master node</span>
<span class="nv">$ </span>ssh ubuntu@<span class="si">$(</span>terraform output master_dns<span class="si">)</span> <span class="nt">-i</span> ~/Downloads/ssh-key-for-us-east-1.pem

<span class="c"># List all namespaces</span>
<span class="nv">$ </span>kubectl get ns
NAME              STATUS   AGE
cert-manager      Active   159m
default           Active   161m
ingress-nginx     Active   158m
kube-node-lease   Active   161m
kube-public       Active   161m
kube-system       Active   161m

<span class="c"># Listing all resources under namespace 'cert-manager'</span>
<span class="nv">$ </span>kubectl get all <span class="nt">-n</span> cert-manager
NAME                                READY   STATUS    RESTARTS   AGE
pod/cert-manager-54d94bb6fc-9zchz   1/1     Running   0          5h22m

NAME                           READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/cert-manager   1/1     1            1           5h22m

NAME                                      DESIRED   CURRENT   READY   AGE
replicaset.apps/cert-manager-54d94bb6fc   1         1         1       5h22m
</code></pre></div></div>

<p><strong>2. Calling Ingress’ <code class="highlighter-rouge">health check</code> over TLS.</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl https://ingress-nginx.cloud.holisticsecurity.io/healthz <span class="nt">-v</span> <span class="nt">-k</span>
<span class="o">[</span>...]
&lt; HTTP/2 200 
&lt; server: nginx/1.15.5
&lt; <span class="nb">date</span>: Tue, 28 Jan 2020 15:23:26 GMT
&lt; content-type: text/html
&lt; content-length: 0
&lt; 
<span class="k">*</span> Connection <span class="c">#0 to host ingress-nginx.cloud.holisticsecurity.io left intact</span>
</code></pre></div></div>

<p><strong>3. Getting the TLS Certificate using <code class="highlighter-rouge">openssl</code></strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">echo</span> | openssl s_client <span class="nt">-showcerts</span> <span class="nt">-servername</span> ingress-nginx.cloud.holisticsecurity.io <span class="nt">-connect</span> ingress-nginx.cloud.holisticsecurity.io:443 2&gt;/dev/null | openssl x509 <span class="nt">-inform</span> pem <span class="nt">-noout</span> <span class="nt">-text</span>
</code></pre></div></div>

<h3 id="4-calling-a-microservice-over-https-port-443">4. Calling a Microservice over HTTPS (port 443)</h3>

<p>Since all Microservices and RESTful API were configured to be invoked over 80/HTTP and 443/HTTPS and routed through the NGINX Ingress Controller. The only thing to do is call them through their FQDN (Fully Qualified Domain Name) and the Microservices’ FQDN could be <code class="highlighter-rouge">https://ingress-nginx.cloud.holisticsecurity.io/&lt;MICROSERVICE_NAME&gt;</code>.</p>

<p>Then, let’s try it using the <code class="highlighter-rouge">Hello Microservice</code>.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Get SSH access to K8s master node</span>
<span class="nv">$ </span>ssh ubuntu@<span class="si">$(</span>terraform output master_dns<span class="si">)</span> <span class="nt">-i</span> ~/Downloads/ssh-key-for-us-east-1.pem
   
<span class="c"># Deploy Hello microservices, services and ingress</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/chilcano/kubeadm-aws/0.2.1-chilcano/examples/hello-cheapk8s-app.yaml
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/chilcano/kubeadm-aws/0.2.1-chilcano/examples/hello-cheapk8s-svc.yaml
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/chilcano/kubeadm-aws/0.2.1-chilcano/examples/hello-cheapk8s-ingress.yaml
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/chilcano/kubeadm-aws/0.2.1-chilcano/examples/hello-cheapk8s-ingress-tls.yaml
   
<span class="c"># Get status</span>
<span class="nv">$ </span>kubectl get pod,svc,ingress <span class="nt">-n</span> hello <span class="nt">-o</span> wide
<span class="o">[</span>...]
NAME                                       HOSTS                                     ADDRESS   PORTS     AGE
ingress.extensions/hello-ingress-cip       ingress-nginx.cloud.holisticsecurity.io             80        16m
ingress.extensions/hello-ingress-cip-tls   ingress-nginx.cloud.holisticsecurity.io             80, 443   15s
ingress.extensions/hello-ingress-np        hello-svc-np.cloud.holisticsecurity.io              80        16m
ingress.extensions/hello-ingress-np-tls    hello-svc-np.cloud.holisticsecurity.io              80, 443   15s
</code></pre></div></div>

<p>Now, from any computer in Internet execute this command:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Calling Hello Microservices over HTTP</span>
<span class="nv">$ </span>curl http://ingress-nginx.cloud.holisticsecurity.io/hello
<span class="nv">$ </span>curl http://hello-svc-np.cloud.holisticsecurity.io/hello 

<span class="c"># Calling Hello Microservices over HTTPS/TLS through `hello-ingress-cip-tls`</span>
<span class="nv">$ </span>curl https://ingress-nginx.cloud.holisticsecurity.io/hello <span class="nt">-v</span> <span class="nt">-k</span>
<span class="o">[</span>...]
Hello version: v1, instance: hello-v1-66fc9c7d98-tljkw
<span class="k">*</span> Connection <span class="c">#0 to host ingress-nginx.cloud.holisticsecurity.io left intact</span>

<span class="c"># Calling Hello Microservices over HTTPS/TLS through `hello-ingress-np-tls`</span>
<span class="nv">$ </span>curl https://hello-svc-np.cloud.holisticsecurity.io/hello <span class="nt">-v</span> <span class="nt">-k</span>
<span class="o">[</span>...]
Hello version: v2, instance: hello-v2-845749f774-tft56
<span class="k">*</span> Connection <span class="c">#0 to host hello-svc-np.cloud.holisticsecurity.io left intact</span>

</code></pre></div></div>

<h2 id="conclusions">Conclusions</h2>

<ol>
  <li>NGINX Ingress Controller routes HTTP and HTTPS/TLS traffic to Hello Microservices.</li>
  <li>NGINX Ingress Controller manages TLS Termination, that means that Hello Microservices don’t require X.509 TLS Certificate. In other words, the NGINX Ingress Controller redirect the ingress traffic to downstream microservice over HTTP standard.</li>
  <li>Hello Microservices are exposed through NGINX Ingress enabling TLS and requesting X.509 TLS Certificate. Note the <code class="highlighter-rouge">annotations</code> used in the <code class="highlighter-rouge">Ingress Resource</code> definition. Below details:</li>
</ol>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">extensions/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Ingress</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">hello-ingress-cip-tls</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="s">kubernetes.io/ingress.class</span><span class="pi">:</span> <span class="s2">"</span><span class="s">nginx"</span>
    <span class="s">certmanager.k8s.io/issuer</span><span class="pi">:</span> <span class="s2">"</span><span class="s">letsencrypt-prod"</span>
    <span class="s">certmanager.k8s.io/acme-challenge-type</span><span class="pi">:</span> <span class="s">http01</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">hello</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">tls</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">hosts</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">ingress-nginx.cloud.holisticsecurity.io</span>
    <span class="na">secretName</span><span class="pi">:</span> <span class="s">ingress-nginx-cloud-holisticsecurity-io-https</span>
  <span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">host</span><span class="pi">:</span> <span class="s">ingress-nginx.cloud.holisticsecurity.io</span>
    <span class="na">http</span><span class="pi">:</span>
      <span class="na">paths</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">path</span><span class="pi">:</span> <span class="s">/</span>
        <span class="na">backend</span><span class="pi">:</span>
          <span class="na">serviceName</span><span class="pi">:</span> <span class="s">hello-svc-cip</span>
          <span class="na">servicePort</span><span class="pi">:</span> <span class="m">5080</span>
<span class="nn">---</span>
</code></pre></div></div>

<p>In the next post I’ll explain how to enable Mutual TLS Authentication for Microservices.
Stay tuned.</p>

<h2 id="references">References</h2>

<ol>
  <li><a href="https://github.com/jetstack/cert-manager" target="_blank">JetStack Cert Manager - x.509 Certs for Kubernetes</a></li>
  <li><a href="http://holisticsecurity.io/2020/01/16/building-your-own-affordable-cloud-k8s-to-host-a-service-mesh-data-plane" target="_blank">Part 1 - Building your own affordable K8s to host a Service Mesh</a>.</li>
  <li><a href="http://holisticsecurity.io/2020/01/22/building-your-own-affordable-cloud-k8s-to-host-a-service-mesh-part2-external-dns-ingress" target="_blank">Part 2 - Building your own affordable K8s - ExternalDNS and NGINX as Ingress</a>.</li>
</ol>

  </div><div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'https://holisticsecurity.io/2020/01/29/building-your-own-affordable-cloud-k8s-to-host-a-service-mesh-part3-certificate-manager';
      this.page.identifier = 'https://holisticsecurity.io/2020/01/29/building-your-own-affordable-cloud-k8s-to-host-a-service-mesh-part3-certificate-manager';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://holosec.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript><a class="u-url" href="/2020/01/29/building-your-own-affordable-cloud-k8s-to-host-a-service-mesh-part3-certificate-manager" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading"><img src="/assets/img/logo-holosec.png" width="40" /> Holistic Security</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Holistic Security</li><li><a class="u-email" href="mailto:blog@holisticsecurity.io">blog@holisticsecurity.io</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/Chilcano"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">Chilcano</span></a></li><li><a href="https://www.linkedin.com/in/Chilcano"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">Chilcano</span></a></li><li><a href="https://www.twitter.com/Chilcano"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">Chilcano</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Systems Thinking, Holism, Trust, Security &amp; Usability.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
