<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Building your own affordable K8s to host a Service Mesh - Part 1 | Holistic Security</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Building your own affordable K8s to host a Service Mesh - Part 1" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I want to build a Container-based Cloud to deploy any kind of workload (RESTful API, Microservices, Event-Driven, Functions, etc.) but it should be affordable, ready to use, reliable, secure and productionable. This means: Productionable: should be fully functional and ready to be used as a production environment. Reliable and Secure: able to improve the security level by implementing more security controls, at least fully isolated secure private networking. Affordable: cheaper. Ready to use: able to be automated (DevOps and IaC) with a mature management API. Below a high level architecture of Container-based Cloud I want to get. I will focus on the Service Mesh Data Plane. These requeriments restric some options, all of them using any Public Cloud Provider, but considering the AWS Spot Instances and Google Cloud Preemptible VM Instances. Unfortunately Microsoft Azure only provides Low-Priority VMs to be used from Azure Batch Service. But if you are new user, you could apply for using the Free Tier in all of 3 Cloud Providers." />
<meta property="og:description" content="I want to build a Container-based Cloud to deploy any kind of workload (RESTful API, Microservices, Event-Driven, Functions, etc.) but it should be affordable, ready to use, reliable, secure and productionable. This means: Productionable: should be fully functional and ready to be used as a production environment. Reliable and Secure: able to improve the security level by implementing more security controls, at least fully isolated secure private networking. Affordable: cheaper. Ready to use: able to be automated (DevOps and IaC) with a mature management API. Below a high level architecture of Container-based Cloud I want to get. I will focus on the Service Mesh Data Plane. These requeriments restric some options, all of them using any Public Cloud Provider, but considering the AWS Spot Instances and Google Cloud Preemptible VM Instances. Unfortunately Microsoft Azure only provides Low-Priority VMs to be used from Azure Batch Service. But if you are new user, you could apply for using the Free Tier in all of 3 Cloud Providers." />
<link rel="canonical" href="https://holisticsecurity.io/2020/01/16/building-your-own-affordable-cloud-k8s-to-host-a-service-mesh-data-plane" />
<meta property="og:url" content="https://holisticsecurity.io/2020/01/16/building-your-own-affordable-cloud-k8s-to-host-a-service-mesh-data-plane" />
<meta property="og:site_name" content="Holistic Security" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-01-16T10:00:00+01:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://holisticsecurity.io/2020/01/16/building-your-own-affordable-cloud-k8s-to-host-a-service-mesh-data-plane"},"url":"https://holisticsecurity.io/2020/01/16/building-your-own-affordable-cloud-k8s-to-host-a-service-mesh-data-plane","headline":"Building your own affordable K8s to host a Service Mesh - Part 1","dateModified":"2020-01-16T10:00:00+01:00","datePublished":"2020-01-16T10:00:00+01:00","description":"I want to build a Container-based Cloud to deploy any kind of workload (RESTful API, Microservices, Event-Driven, Functions, etc.) but it should be affordable, ready to use, reliable, secure and productionable. This means: Productionable: should be fully functional and ready to be used as a production environment. Reliable and Secure: able to improve the security level by implementing more security controls, at least fully isolated secure private networking. Affordable: cheaper. Ready to use: able to be automated (DevOps and IaC) with a mature management API. Below a high level architecture of Container-based Cloud I want to get. I will focus on the Service Mesh Data Plane. These requeriments restric some options, all of them using any Public Cloud Provider, but considering the AWS Spot Instances and Google Cloud Preemptible VM Instances. Unfortunately Microsoft Azure only provides Low-Priority VMs to be used from Azure Batch Service. But if you are new user, you could apply for using the Free Tier in all of 3 Cloud Providers.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://holisticsecurity.io/feed.xml" title="Holistic Security" /><script>
if(!(window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1")) {
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-156433649-1', 'auto');
  ga('send', 'pageview');
}
</script>
  
</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/"><img src="/assets/img/logo-holosec.png" width="100" /> Holistic Security</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/">Home</a><a class="page-link" href="/blog/">Blog</a><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Building your own affordable K8s to host a Service Mesh - Part 1</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2020-01-16T10:00:00+01:00" itemprop="datePublished">Jan 16, 2020 
      </time>&sim; CLOUD · APAAS · SERVICE MESH
      &sim; AWS · DOCKER · KUBERNETES · DATA PLANE · MICROSERVICE
    </p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>I want to build a Container-based Cloud to deploy any kind of workload (RESTful API, Microservices, Event-Driven, Functions, etc.) but it should be affordable, ready to use, reliable, secure and productionable. This means:</p>

<ul>
  <li>Productionable: should be fully functional and ready to be used as a production environment.</li>
  <li>Reliable and Secure: able to improve the security level by implementing more security controls, at least fully isolated secure private networking.</li>
  <li>Affordable: cheaper.</li>
  <li>Ready to use: able to be automated (DevOps and IaC) with a mature management API.</li>
</ul>

<p>Below a high level architecture of Container-based Cloud I want to get. I will focus on the Service Mesh Data Plane.<br />
<a href="/assets/img/20200116-service-mesh-01-reference-arch-2.png" target="_blank"><img src="/assets/img/20200116-service-mesh-01-reference-arch-2.png" alt="" title="Service Mesh hosted in a Container-based Cloud" /></a></p>

<p>These requeriments restric some options, all of them using any Public Cloud Provider, but considering the <a href="https://aws.amazon.com/ec2/spot">AWS Spot Instances</a> and <a href="https://cloud.google.com/preemptible-vms">Google Cloud Preemptible VM Instances</a>. Unfortunately Microsoft Azure only provides Low-Priority VMs to be used from Azure Batch Service. But if you are new user, you could apply for using the Free Tier in all of 3 Cloud Providers.</p>

<!-- more -->

<p>For further information, you can read these articles:</p>

<ul>
  <li><a href="https://spotinst.com/blog/amazon-ec2-spot-vs-azure-lpvms-vs-google-pvms-vs-ibm-transient-servers/">Understanding Excess Cloud Capacity: Amazon EC2 Spot vs. Azure Low-Priority VM vs. Google Preemptible VM vs IBM Transient Servers</a> - By Zev Schonberg, 2019-Mar</li>
  <li><a href="https://www.computerworld.com/article/3427685/cloud-vendor-free-tiers-compared--aws-vs-azure-vs-google-cloud-platform.html">Cloud vendor free tiers compared: AWS vs Azure vs Google Cloud Platform</a> - By Scott Carey, 2018-May</li>
</ul>

<p>The automation can be achieved using Terraform, Python, Bash, etc. and the 2 Cloud Providers (AWS and Google Cloud) choosen for this project have a mature Management API which can be used to automatization and configuration.</p>

<h2 id="how-much-will-the-kubernetes-cluster-cost-me">How much will the Kubernetes Cluster cost me?</h2>

<p>Well, It is too difficult to know the cost exactly right now, however, I can estimate what it will cost me for a month. Below you can see two images, the first one is the High level AWS design and the next one is the approximate cost of the all AWS resources used during a month.</p>

<p><a href="/assets/img/20200122-service-mesh-01-affordablek8s-aws-arch.png" target="_blank"><img src="/assets/img/20200122-service-mesh-01-affordablek8s-aws-arch.png" alt="" title="Kubernetes Cluster using AWS Spot Instances" /></a></p>

<p>You can see below that my K8s Cluster using AWS Spot instances will cost approx. <code class="highlighter-rouge">6.79 Euros</code>, that includes:</p>
<ul>
  <li>Instances EC2 Spot: 2</li>
  <li>Type: m1.small</li>
  <li>AZ: us-east-1</li>
  <li>S3 Storage 1GB</li>
  <li>S3 Put/Copy/Post / mo(K): 96</li>
  <li>S3 Get and other / mo(K): 2880</li>
  <li>Backup into S3 cron expression: “*/15 * * * *”</li>
</ul>

<p><a href="/assets/img/20200116-service-mesh-04-affordable-k8s-aws-budget.png" target="_blank"><img src="/assets/img/20200116-service-mesh-04-affordable-k8s-aws-budget.png" alt="" title="K8s Cluster hosted using AWS Spot Instances - Cost" /></a></p>

<h2 id="what-about-digital-ocean-hetzner-cloud-scaleway-and-other-providers">What about Digital Ocean, Hetzner Cloud, Scaleway and other Providers?</h2>

<p>Yes, all of them are worthy of being considered too and will do it in next blog posts, but let’s start with AWS and Google first. 
Ah, if you don’t want to wait, I suggest you read the <a href="https://github.com/hobby-kube/guide">Kubernetes clusters for the hobbyist</a> guide written by Patrick Stadler. This guide explains how to build a Kubernetes Cluster on <a href="https://www.digitalocean.com">Digital Ocean</a>, <a href="https://www.hetzner.com/">Hetzner Cloud</a> and/or <a href="https://www.scaleway.com">Scaleway</a>, and this guide is accompanied by a fully automated cluster setup based on Terraform recipes. The guide suggests that <a href="https://www.linode.com/">Linode</a>, <a href="https://www.vultr.com">Vultr</a> are other viable options.</p>

<blockquote>

  <p>If you know a reliable, secure and affordable Cloud Provider, don’t hesitate to drop me a line.</p>

</blockquote>

<h2 id="cheap-doesnt-mean-unreliable-doesnt-mean-unsecure">Cheap doesn’t mean unreliable, doesn’t mean unsecure</h2>

<p>Choose a cloud provider based on a few criteria such as trustworthiness, reliability, pricing and data center location is critical for this project. Security is a must, create a cluster in a private network doesn’t mean it is secure. I will create multiple clusters to host different kind of workloads, then they should be isolated, implement secure private networking and implement Access Control (Authentication and Authorization).</p>

<h2 id="lets-do-it">Let’s do it</h2>

<p>Then, in this post I will explain how to create an affordable Data Plane in AWS, to do that I’m going to use the <a href="https://github.com/cablespaghetti/kubeadm-aws">Really cheap Kubernetes cluster on AWS with kubeadm</a> Guide’s <a href="https://cablespaghetti.github.io">Sam Weston</a> which will create a Kubernetes Cluster in AWS by using <a href="https://aws.amazon.com/ec2/spot">AWS EC2 Spot Instances</a>, <a href="https://www.terraform.io">Terraform</a>, Bash and <a href="https://helm.sh">Helm</a> for automation, External DNS and Nginx Ingress as a cheap ELB alternative, and <a href="https://cert-manager.io">Cert Manager</a> for TLS certificates via <a href="https://letsencrypt.org">Let’s Encrypt</a>. Other features implemented are:</p>

<ul>
  <li>Automatic backup and recovery.</li>
  <li>Auto Scaling of worker nodes.</li>
  <li>Persistent Volumes using General Purpose SSD (GP2) storage on <a href="https://aws.amazon.com/ebs">AWS EBS</a>.</li>
</ul>

<h3 id="steps">Steps</h3>

<p><strong>1) Terraform</strong></p>

<ol>
  <li>
    <p>Download Terraform bundle.</p>

    <blockquote>
      <p>I’ve attempted to use Terraform 12.x, but unfortunately Terraform scrips need to be tweaked before, for that, for this blog post I recommend download and install <a href="https://releases.hashicorp.com/terraform/">Terraform 11.15-oci</a> version.<br />
The <code class="highlighter-rouge">oci</code> suffix means that Terraform is compatible with <a href="https://www.terraform.io/docs/providers/oci/guides/faq.html">Oracle Cloud Infrastructure</a>.</p>
    </blockquote>
  </li>
  <li>
    <p>Extract the downloaded <code class="highlighter-rouge">terraform</code> binary file and move it into a directory searched for executables.</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chilcano@inti:~<span class="nv">$ </span>unzip ~/Downloads/terraform_0.11.15-oci_linux_amd64.zip 
 
chilcano@inti:~<span class="nv">$ </span><span class="nb">sudo mv </span>terraform /usr/local/bin/
   
chilcano@inti:~<span class="nv">$ </span>terraform <span class="nt">-v</span>
Terraform v0.11.15-oci
</code></pre></div>    </div>
  </li>
</ol>

<p><strong>2) AWS (optional)</strong></p>

<p>Although AWS CLI isn’t needed for the purpose of running Terraform, that will be useful in the next blog posts.</p>

<ol>
  <li>
    <p>Install AWS CLI. It requires Pip 3.</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chilcano@inti:~<span class="nv">$ </span>pip3 <span class="nt">--version</span>
pip 18.1 from /usr/lib/python3/dist-packages/pip <span class="o">(</span>python 3.7<span class="o">)</span>
   
chilcano@inti:~<span class="nv">$ </span>pip3 <span class="nb">install </span>awscli <span class="nt">--upgrade</span> <span class="nt">--user</span>
   
chilcano@inti:~<span class="nv">$ </span>aws <span class="nt">--version</span>
aws-cli/1.16.314 Python/3.7.5 Linux/5.3.0-26-generic botocore/1.13.50
   
chilcano@inti:~<span class="nv">$ </span>which aws
/home/chilcano/.local/bin/aws
</code></pre></div>    </div>
  </li>
  <li>
    <p>Configure the AWS account.</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chilcano@inti:~<span class="nv">$ </span>aws configure <span class="nt">--profile</span> affordablek8s01
AWS Access Key ID <span class="o">[</span>None]: &lt;ACCESS-KEY-ID&gt;
AWS Secret Access Key <span class="o">[</span>None]: &lt;SECRET-ACCESS-KEY&gt;
Default region name <span class="o">[</span>None]: us-west-2
Default output format <span class="o">[</span>None]: json
 
chilcano@inti:~<span class="nv">$ </span><span class="nb">cat</span> .aws/credentials 
<span class="o">[</span>affordablek8s01]
aws_access_key_id <span class="o">=</span> &lt;ACCESS-KEY-ID&gt;
aws_secret_access_key <span class="o">=</span> &lt;SECRET-ACCESS-KEY&gt;
</code></pre></div>    </div>
  </li>
  <li>
    <p>Create a SSH key under the AZ where the resources will be created. In my case I’ll create in <code class="highlighter-rouge">us-east-1</code> (Virginia) from the <code class="highlighter-rouge">AWS Web Console &gt; NETWORK &amp; SECURITY &gt; Key Pairs</code>. This SSH key will be used to get access to all nodes created in AWS for that specific AZ.</p>
  </li>
</ol>

<p><strong>3) Create the Kubernetes Cluster in AWS using Terraform</strong></p>

<ol>
  <li>
    <p>Clone the Github repo.</p>

    <p>You can clone the <a href="https://github.com/chilcano/kubeadm-aws" target="_blank">forked GitHub repo</a> and switch to <code class="highlighter-rouge">0.2.1-chilcano</code> branch.</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chilcano@inti:~/git-repos<span class="nv">$ </span>git clone https://github.com/chilcano/kubeadm-aws affordable-k8s-tf
   
Cloning into <span class="s1">'affordable-k8s-tf'</span>...
remote: Enumerating objects: 327, <span class="k">done</span><span class="nb">.</span>
remote: Total 327 <span class="o">(</span>delta 0<span class="o">)</span>, reused 0 <span class="o">(</span>delta 0<span class="o">)</span>, pack-reused 327
Receiving objects: 100% <span class="o">(</span>327/327<span class="o">)</span>, 71.68 KiB | 638.00 KiB/s, <span class="k">done</span><span class="nb">.</span>
Resolving deltas: 100% <span class="o">(</span>210/210<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
   
chilcano@inti:~/git-repos<span class="nv">$ </span><span class="nb">cd </span>affordable-k8s-tf/
   
chilcano@inti:~/git-repos/affordable-k8s-tf<span class="nv">$ </span>git tag <span class="nt">-l</span>
0.1.0
0.1.1
0.1.2
0.2.0
0.2.1

chilcano@inti:~/git-repos/affordable-k8s-tf<span class="nv">$ </span>git branch <span class="nt">-a</span>
<span class="k">*</span> master
  remotes/origin/0.2.1-chilcano
  remotes/origin/HEAD -&gt; origin/master
  remotes/origin/master

chilcano@inti:~/git-repos/affordable-k8s-tf<span class="nv">$ </span>git branch <span class="nt">-r</span>
  origin/0.2.1-chilcano
  origin/HEAD -&gt; origin/master
  origin/master
</code></pre></div>    </div>
    <p>Now, let’s switch to <code class="highlighter-rouge">0.2.1-chilcano</code> branch.</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chilcano@inti:~/git-repos/affordable-k8s-tf<span class="nv">$ </span>git checkout 0.2.1-chilcano
Branch <span class="s1">'0.2.1-chilcano'</span> <span class="nb">set </span>up to track remote branch <span class="s1">'0.2.1-chilcano'</span> from <span class="s1">'origin'</span><span class="nb">.</span>
Switched to a new branch <span class="s1">'0.2.1-chilcano'</span>

chilcano@inti:~/git-repos/affordable-k8s-tf<span class="nv">$ </span>git status
On branch 0.2.1-chilcano
Your branch is up to <span class="nb">date </span>with <span class="s1">'origin/0.2.1-chilcano'</span><span class="nb">.</span>
   
nothing to commit, working tree clean
</code></pre></div>    </div>

    <blockquote>
      <p>Alternatively to all above steps you can clone the <code class="highlighter-rouge">0.2.1-chilcano</code> branch only of GitHub repo as follow:</p>
      <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chilcano@inti:~/git-repos<span class="nv">$ </span>git clone <span class="nt">--single-branch</span> <span class="nt">--branch</span> 0.2.1-chilcano https://github.com/chilcano/kubeadm-aws affordable-k8s-tf
</code></pre></div>      </div>
    </blockquote>
  </li>
  <li>
    <p>Update <code class="highlighter-rouge">variables.tf</code>.</p>

    <blockquote>

      <p>Hard-coding any credentials into any Terraform configuration is not recommended. I recommend to provide your AWS credentials via <code class="highlighter-rouge">AWS_ACCESS_KEY_ID</code> and <code class="highlighter-rouge">AWS_SECRET_ACCESS_KEY</code> environment variables.</p>

    </blockquote>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">export </span><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span><span class="s2">"an-access-key"</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span><span class="s2">"a-secret-key"</span>
</code></pre></div>    </div>

    <p>In my case I’m not going to update any variables in <code class="highlighter-rouge">variables.tf</code>, I will overwrite them when running <code class="highlighter-rouge">terraform apply</code>. But if you want to do, the variables you have to modify are:</p>

    <ul>
      <li><code class="highlighter-rouge">cluster-name = "MY-CHEAP-K8S"</code></li>
      <li><code class="highlighter-rouge">access_key = "ENV-VAR-VALUE-WILL-BE-READ"</code></li>
      <li><code class="highlighter-rouge">secret_key = "ENV-VAR-VALUE-WILL-BE-READ"</code></li>
      <li><code class="highlighter-rouge">k8s-ssh-key = "SSH-KEY-NAME-CREATED-IN-AWS-CONSOLE"</code></li>
      <li><code class="highlighter-rouge">admin-cidr-blocks = "YOUR-PUBLIC-IP-ADDRESS/32"</code></li>
      <li><code class="highlighter-rouge">region = "us-east-1"</code></li>
      <li><code class="highlighter-rouge">master-instance-type = "m1.small"</code></li>
      <li><code class="highlighter-rouge">worker-instance-type = "m1.small"</code></li>
    </ul>

    <blockquote>

      <p>If you change the <code class="highlighter-rouge">master-instance-type</code> and <code class="highlighter-rouge">worker-instance-type</code> values to <code class="highlighter-rouge">t2.micro</code> for example, that isn’t going to work because the <code class="highlighter-rouge">t2.micro</code> AMIs are prepared to be autoscaled.</p>

    </blockquote>
  </li>
  <li>
    <p>Update <code class="highlighter-rouge">main.tf</code> and initialize the Terraform Providers.</p>

    <p>I will update <code class="highlighter-rouge">main.tf</code> to configure the 2 Terraform providers (<code class="highlighter-rouge">aws</code> and <code class="highlighter-rouge">random</code>) with proper versions according <code class="highlighter-rouge">Terraform v0.11.15-oci</code> version:</p>

    <div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">provider</span> <span class="s2">"aws"</span> <span class="p">{</span>
  <span class="c1">#version    = "~&gt; 1.48"</span>
  <span class="nx">version</span>    <span class="p">=</span> <span class="s2">"~&gt; 2.44.0"</span>
  <span class="nx">access_key</span> <span class="p">=</span> <span class="s2">"</span><span class="k">${</span><span class="kd">var</span><span class="p">.</span><span class="nx">access_key</span><span class="k">}</span><span class="s2">"</span>
  <span class="nx">secret_key</span> <span class="p">=</span> <span class="s2">"</span><span class="k">${</span><span class="kd">var</span><span class="p">.</span><span class="nx">secret_key</span><span class="k">}</span><span class="s2">"</span>
  <span class="nx">region</span>     <span class="p">=</span> <span class="s2">"</span><span class="k">${</span><span class="kd">var</span><span class="p">.</span><span class="nx">region</span><span class="k">}</span><span class="s2">"</span>
<span class="p">}</span>
   
<span class="k">provider</span> <span class="s2">"template"</span> <span class="p">{</span>
  <span class="nx">version</span>    <span class="p">=</span> <span class="s2">"1.0.0"</span>
<span class="p">}</span>
   
<span class="k">provider</span> <span class="s2">"random"</span> <span class="p">{</span>
  <span class="c1">#version    = "2.0.0"</span>
  <span class="nx">version</span>    <span class="p">=</span> <span class="s2">"2.1.0"</span>
<span class="p">}</span>
</code></pre></div>    </div>

    <p>Now, initialize Terraform.</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chilcano@inti:~/git-repos/affordable-k8s-tf<span class="nv">$ </span>terraform init
   
Initializing provider plugins...
- Checking <span class="k">for </span>available provider plugins on https://releases.hashicorp.com...
- Downloading plugin <span class="k">for </span>provider <span class="s2">"template"</span> <span class="o">(</span>1.0.0<span class="o">)</span>...
- Downloading plugin <span class="k">for </span>provider <span class="s2">"random"</span> <span class="o">(</span>2.1.0<span class="o">)</span>...
- Downloading plugin <span class="k">for </span>provider <span class="s2">"aws"</span> <span class="o">(</span>2.44.0<span class="o">)</span>...
   
Terraform has been successfully initialized!
   
You may now begin working with Terraform. Try running <span class="s2">"terraform plan"</span> to see
any changes that are required <span class="k">for </span>your infrastructure. All Terraform commands
should now work.
   
If you ever <span class="nb">set </span>or change modules or backend configuration <span class="k">for </span>Terraform,
rerun this <span class="nb">command </span>to reinitialize your working directory. If you forget, other
commands will detect it and remind you to <span class="k">do </span>so <span class="k">if </span>necessary.
</code></pre></div>    </div>
  </li>
  <li>
    <p>Get the Terraform Plan.</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chilcano@inti:~/git-repos/affordable-k8s-tf<span class="nv">$ </span>terraform plan <span class="se">\</span>
  <span class="nt">-var</span> cluster-name<span class="o">=</span><span class="s2">"cheapk8s"</span> <span class="se">\</span>
  <span class="nt">-var</span> k8s-ssh-key<span class="o">=</span><span class="s2">"ssh-key-for-us-east-1"</span> <span class="se">\</span>
  <span class="nt">-var</span> admin-cidr-blocks<span class="o">=</span><span class="s2">"83.46.128.76/32"</span> <span class="se">\</span>
  <span class="nt">-var</span> <span class="nv">region</span><span class="o">=</span><span class="s2">"us-east-1"</span> <span class="se">\</span>
  <span class="nt">-var</span> kubernetes-version<span class="o">=</span><span class="s2">"1.14.3"</span>
   
chilcano@inti:~/git-repos/affordable-k8s-tf<span class="nv">$ </span>terraform <span class="nt">-v</span>
Terraform v0.11.15-oci
+ provider.aws v2.44.0
+ provider.random v2.1.0
+ provider.template v1.0.0
   
Your version of Terraform is out of <span class="nb">date</span><span class="o">!</span> The latest version
is 0.12.19. You can update by downloading from www.terraform.io/downloads.html
</code></pre></div>    </div>
  </li>
  <li>
    <p>Visual exploration of the AWS resources are going to be created by Terraform.</p>

    <p>Terraform is able to export all Terraform scripts into a file in <a href="https://www.graphviz.org/doc/info/lang.html">DOT format</a>, useful to generate a graph through <a href="http://www.graphviz.org">GraphViz</a>. All details are explained here <a href="https://www.terraform.io/docs/commands/graph.html">“Terraform - Command: graph”</a>.</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chilcano@inti:~/git-repos/affordable-k8s-tf<span class="nv">$ </span><span class="nb">sudo </span>apt <span class="nb">install </span>graphviz
terraform graph | dot <span class="nt">-Tsvg</span> <span class="o">&gt;</span> your-graph.svg
</code></pre></div>    </div>

    <p>In my case I’m going to tweaking the DOT file to get a better graph. In fact, you can do it and once done, using an online service like this <a href="https://dreampuf.github.io/GraphvizOnline">Graphviz Online</a> generate SVG file.</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chilcano@inti:~/git-repos/affordable-k8s-tf<span class="nv">$ </span>terraform graph <span class="nt">-draw-cycles</span> <span class="nt">-module-depth</span><span class="o">=</span>1 <span class="nt">-type</span><span class="o">=</span>apply <span class="o">&gt;</span> 20200116-service-mesh-02-affordable-k8s-aws-graph.dot
</code></pre></div>    </div>

    <blockquote>

      <p>You can download my updated DOT file from here <a href="/assets/img/20200116-service-mesh-02-affordable-k8s-aws-graph.dot">20200116-service-mesh-02-affordable-k8s-aws-graph.dot</a>.</p>

    </blockquote>

    <p><a href="/assets/img/20200116-service-mesh-02-affordable-k8s-aws-graph.svg" target="_blank"><img src="/assets/img/20200116-service-mesh-02-affordable-k8s-aws-graph.svg" alt="Affordable K8s Data Plane hosted in AWS Graph" title="Affordable K8s Data Plane hosted in AWS Graph" /></a></p>
  </li>
  <li>
    <p>Apply the Terraform Plan.</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chilcano@inti:~/git-repos/affordable-k8s-tf<span class="nv">$ </span>terraform apply <span class="se">\</span>
  <span class="nt">-var</span> cluster-name<span class="o">=</span><span class="s2">"cheapk8s"</span> <span class="se">\</span>
  <span class="nt">-var</span> k8s-ssh-key<span class="o">=</span><span class="s2">"ssh-key-for-us-east-1"</span> <span class="se">\</span>
  <span class="nt">-var</span> admin-cidr-blocks<span class="o">=</span><span class="s2">"83.46.128.76/32"</span> <span class="se">\</span>
  <span class="nt">-var</span> <span class="nv">region</span><span class="o">=</span><span class="s2">"us-east-1"</span> <span class="se">\</span>
  <span class="nt">-var</span> kubernetes-version<span class="o">=</span><span class="s2">"1.14.3"</span>
</code></pre></div>    </div>

    <p>And if you want to destroy all resources recently created by <code class="highlighter-rouge">terraform apply</code>, you can do it executing this:</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chilcano@inti:~/git-repos/affordable-k8s-tf<span class="nv">$ </span>terraform destroy <span class="se">\</span>
  <span class="nt">-var</span> cluster-name<span class="o">=</span><span class="s2">"cheapk8s"</span> <span class="se">\</span>
  <span class="nt">-var</span> k8s-ssh-key<span class="o">=</span><span class="s2">"ssh-key-for-us-east-1"</span> <span class="se">\</span>
  <span class="nt">-var</span> admin-cidr-blocks<span class="o">=</span><span class="s2">"83.46.128.76/32"</span> <span class="se">\</span>
  <span class="nt">-var</span> <span class="nv">region</span><span class="o">=</span><span class="s2">"us-east-1"</span> <span class="se">\</span>
  <span class="nt">-var</span> kubernetes-version<span class="o">=</span><span class="s2">"1.14.3"</span>
</code></pre></div>    </div>
  </li>
</ol>

<p><strong>4) Check the Kubernetes Cluster</strong></p>

<p>If we want to check the Kubernetes Cluster creation, we have to review the <code class="highlighter-rouge">/var/log/cloud-init-output.log</code>. Before we should get remote access to Kubernetes Master host.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chilcano@inti:~/git-repos/affordable-k8s-tf<span class="nv">$ </span><span class="nb">chmod </span>400 ~/Downloads/ssh-key-for-us-east-1.pem
</code></pre></div></div>

<p>Now, getting remote access to Kubernetes Master host.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chilcano@inti:~/git-repos/affordable-k8s-tf<span class="nv">$ </span>ssh ubuntu@<span class="si">$(</span>terraform output master_dns<span class="si">)</span> <span class="nt">-i</span> ~/Downloads/ssh-key-for-us-east-1.pem <span class="nt">--</span> <span class="nb">cat</span> /var/log/cloud-init-output.log

<span class="o">[</span>...]
Completed 1.0 KiB/1.0 KiB <span class="o">(</span>6.9 KiB/s<span class="o">)</span> with 1 file<span class="o">(</span>s<span class="o">)</span> remaining
upload: etc/kubernetes/pki/ca.crt to s3://cheapk8s20200115152212812700000001/pki/i-9343ae2e5c0e52dec/ca.crt
Completed 1.6 KiB/1.6 KiB <span class="o">(</span>12.5 KiB/s<span class="o">)</span> with 1 file<span class="o">(</span>s<span class="o">)</span> remaining
upload: etc/kubernetes/pki/ca.key to s3://cheapk8s20200115152212812700000001/pki/i-9343ae2e5c0e52dec/ca.key
Created symlink /etc/systemd/system/multi-user.target.wants/check-termination.service → /etc/systemd/system/check-termination.service.
Cloud-init v. 19.3-41-gc4735dd3-0ubuntu1~18.04.1 running <span class="s1">'modules:final'</span> at Wed, 15 Jan 2020 15:24:48 +0000. Up 81.04 seconds.
Cloud-init v. 19.3-41-gc4735dd3-0ubuntu1~18.04.1 finished at Wed, 15 Jan 2020 15:33:22 +0000. Datasource DataSourceEc2Local.  Up 594.92 seconds
</code></pre></div></div>

<blockquote>

  <p>If you see above logs, that means that likely everything worked and Kubernetes Cluster was created successfully.
But, if you see below logs, that means Kubernetes Cluster wasn’t created. In the below logs there are errors about Kubernetes packages (<code class="highlighter-rouge">kubeadm</code>, <code class="highlighter-rouge">kubelet</code> and <code class="highlighter-rouge">kubernetes-cni</code>) dependencies unmet when using <code class="highlighter-rouge">kubernetes-version="1.13.4"</code> (default version of these Terraform scripts). To fix it we should change it to <code class="highlighter-rouge">kubernetes-version="1.14.3"</code>.</p>

</blockquote>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ubuntu@ip-10-0-100-4:~<span class="nv">$ </span><span class="nb">cat</span> /var/log/cloud-init-output.log

<span class="o">[</span>...]
Some packages could not be installed. This may mean that you have
requested an impossible situation or <span class="k">if </span>you are using the unstable
distribution that some required packages have not yet been created
or been moved out of Incoming.
The following information may <span class="nb">help </span>to resolve the situation:

The following packages have unmet dependencies:
 kubeadm : Depends: kubernetes-cni <span class="o">(=</span> 0.6.0<span class="o">)</span> but 0.7.5-00 is to be installed
 kubelet : Depends: kubernetes-cni <span class="o">(=</span> 0.6.0<span class="o">)</span> but 0.7.5-00 is to be installed
E: Unable to correct problems, you have held broken packages.
Cloud-init v. 19.3-41-gc4735dd3-0ubuntu1~18.04.1 running <span class="s1">'modules:final'</span> at Wed, 15 Jan 2020 11:15:47 +0000. Up 88.84 seconds.
2020-01-15 11:16:17,468 - util.py[WARNING]: Failed running /var/lib/cloud/instance/scripts/part-001 <span class="o">[</span>100]
2020-01-15 11:16:17,486 - cc_scripts_user.py[WARNING]: Failed to run module scripts-user <span class="o">(</span>scripts <span class="k">in</span> /var/lib/cloud/instance/scripts<span class="o">)</span>
2020-01-15 11:16:17,486 - util.py[WARNING]: Running module scripts-user <span class="o">(</span>&lt;module <span class="s1">'cloudinit.config.cc_scripts_user'</span> from <span class="s1">'/usr/lib/python3/dist-packages/cloudinit/config/cc_scripts_user.py'</span><span class="o">&gt;)</span> failed
Cloud-init v. 19.3-41-gc4735dd3-0ubuntu1~18.04.1 finished at Wed, 15 Jan 2020 11:16:18 +0000. Datasource DataSourceEc2Local.  Up 119.65 seconds
</code></pre></div></div>

<blockquote>

  <p>The below log shows other error related with incompatible <code class="highlighter-rouge">apiVersion</code> in <code class="highlighter-rouge">init-config.yaml</code> file created by <code class="highlighter-rouge">master.sh</code>. 
It shoud be changed to <code class="highlighter-rouge">apiVersion: kubeadm.k8s.io/v1beta1</code>.</p>

</blockquote>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ubuntu@ip-10-0-100-4:~<span class="nv">$ </span><span class="nb">cat</span> /var/log/cloud-init-output.log

<span class="o">[</span>...]
<span class="k">else
  </span><span class="nb">echo</span> <span class="s2">"Running kubeadm init"</span>
  kubeadm init <span class="nt">--config</span><span class="o">=</span>init-config.yaml <span class="nt">--ignore-preflight-errors</span><span class="o">=</span>NumCPU
  <span class="nb">touch</span> /tmp/fresh-cluster
<span class="k">fi
</span>Running kubeadm init
your configuration file uses a deprecated API spec: <span class="s2">"kubeadm.k8s.io/v1alpha3"</span><span class="nb">.</span> Please use <span class="s1">'kubeadm config migrate --old-config old.yaml --new-config new.yaml'</span>, which will write the new, similar spec using a newer API version.
Cloud-init v. 19.3-41-gc4735dd3-0ubuntu1~18.04.1 running <span class="s1">'modules:final'</span> at Wed, 15 Jan 2020 12:05:30 +0000. Up 78.18 seconds.
2020-01-15 12:10:10,299 - util.py[WARNING]: Failed running /var/lib/cloud/instance/scripts/part-001 <span class="o">[</span>1]
2020-01-15 12:10:10,308 - cc_scripts_user.py[WARNING]: Failed to run module scripts-user <span class="o">(</span>scripts <span class="k">in</span> /var/lib/cloud/instance/scripts<span class="o">)</span>
2020-01-15 12:10:10,308 - util.py[WARNING]: Running module scripts-user <span class="o">(</span>&lt;module <span class="s1">'cloudinit.config.cc_scripts_user'</span> from <span class="s1">'/usr/lib/python3/dist-packages/cloudinit/config/cc_scripts_user.py'</span><span class="o">&gt;)</span> failed
Cloud-init v. 19.3-41-gc4735dd3-0ubuntu1~18.04.1 finished at Wed, 15 Jan 2020 12:10:10 +0000. Datasource DataSourceEc2Local.  Up 357.91 seconds
</code></pre></div></div>

<p><strong>5) Access to Kubernetes Cluster</strong></p>

<p>If you want to know if your Kubernetes Cluster was created successfully, then you should do these checkings:</p>

<ol>
  <li>
    <p>Check that there are no errors in <code class="highlighter-rouge">/var/log/cloud-init-output.log</code> log file.</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chilcano@inti:~/git-repos/affordable-k8s-tf<span class="nv">$ </span>ssh ubuntu@<span class="si">$(</span>terraform output master_dns<span class="si">)</span> <span class="nt">-i</span> ~/Downloads/ssh-key-for-us-east-1.pem <span class="nt">--</span> <span class="nb">cat</span> /var/log/cloud-init-output.log
</code></pre></div>    </div>
  </li>
  <li>
    <p>Check that <code class="highlighter-rouge">kubelet</code> has started successfully.</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chilcano@inti:~/git-repos/affordable-k8s-tf<span class="nv">$ </span>ssh ubuntu@<span class="si">$(</span>terraform output master_dns<span class="si">)</span> <span class="nt">-i</span> ~/Downloads/ssh-key-for-us-east-1.pem <span class="nt">--</span> systemctl status kubelet
</code></pre></div>    </div>
  </li>
  <li>
    <p>Finally, ask to Kubernetes to show all Cluster Nodes and its status.</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chilcano@inti:~/git-repos/affordable-k8s-tf<span class="nv">$ </span>ssh ubuntu@<span class="si">$(</span>terraform output master_dns<span class="si">)</span> <span class="nt">-i</span> ~/Downloads/ssh-key-for-us-east-1.pem <span class="nt">--</span> kubectl get nodes
   
NAME                           STATUS   ROLES    AGE   VERSION
ip-10-0-100-154.ec2.internal   Ready    &lt;none&gt;   48m   v1.14.3
ip-10-0-100-4.ec2.internal     Ready    master   49m   v1.14.3

chilcano@inti:~/git-repos/affordable-k8s-tf<span class="nv">$ </span>ssh ubuntu@<span class="si">$(</span>terraform output master_dns<span class="si">)</span> <span class="nt">-i</span> ~/Downloads/ssh-key-for-us-east-1.pem <span class="nt">--</span> kubectl cluster-info
Kubernetes master is running at https://10.0.100.4:6443
KubeDNS is running at https://10.0.100.4:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
</code></pre></div>    </div>

    <p><img src="/assets/img/20200116-service-mesh-03-affordable-k8s-aws.png" alt="Affordable K8s Data Plane hosted in AWS" title="Affordable K8s Data Plane hosted in AWS" /></p>

    <blockquote>

      <p>If you want a cheap K8s Infrastructure on AWS, I recommend to use this GitHub repo I’ve updated for you, once cloned just follow the above steps.</p>

      <p><a href="https://github.com/chilcano/kubeadm-aws/tree/0.2.1-chilcano">https://github.com/chilcano/kubeadm-aws/tree/0.2.1-chilcano</a></p>

    </blockquote>

    <p>Below I’ve selected a set of good references to read related to this article and that will surely interest you.
I hope this helps.</p>
  </li>
</ol>

<h2 id="references">References</h2>

<ul>
  <li><a href="https://www.doxsey.net/blog/kubernetes--the-surprisingly-affordable-platform-for-personal-projects">Kubernetes: The Surprisingly Affordable Platform for Personal Projects</a> By Caleb Doxsey - Sep 30, 2018</li>
  <li><a href="https://devonblog.com/containers/affordable-kubernetes-cluster/">Affordable Kubernetes Cluster</a> By Remko Seelig - March 12, 2019</li>
  <li><a href="https://github.com/hobby-kube/guide">Kubernetes clusters for the hobbyist</a> By Patrick Stadler - Latest commit on Oct 11, 2019</li>
  <li><a href="https://software.danielwatrous.com/kubernetes-on-the-cheap/">Kubernetes on the cheap</a> By Daniel Watrous - Feb 9, 2019</li>
  <li><a href="https://itsilesia.com/kubernetes-for-poor-how-to-run-your-cluster-and-not-go-bankrupt/">Kubernetes for poor - How to run your cluster and not go bankrupt</a> By Aleksander Grzybowski - Nov 13, 2018</li>
  <li><a href="https://mehdi.me/running-a-personal-kubernetes-cluster-for-almost-from-on-gke/">Diary of a GKE Journeyman - Running your personal Kubernetes Cluster for (almost) free on GKE</a> By Mehdi El Gueddari - Mar 22, 2019</li>
  <li><a href="https://github.com/awslabs/ec2-spot-labs">Collection of tools and code examples to demonstrate best practices in using Amazon EC2 Spot Instances.</a></li>
  <li><a href="https://aws.amazon.com/ec2/spot/instance-advisor">AWS Spot Instance Advisor</a></li>
</ul>

<h3 id="kubernetes-distributions">Kubernetes’ distributions</h3>

<ul>
  <li><a href="https://microk8s.io/">MicroK8s - Zero-ops Kubernetes for workstations and edge / IoT</a> By Ubuntu</li>
  <li><a href="https://k3s.io/">K3s - Lightweight Kubernetes for IoT &amp; Edge computing</a> By Rancher</li>
  <li><a href="https://github.com/kubernetes-sigs/kind">KinD - Kubernetes in Docker</a> By Kubernetes SIGs</li>
  <li><a href="https://github.com/poseidon/typhoon">Typhoon - Minimal and free Kubernetes distribution</a> By poseidon</li>
</ul>

  </div><div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'https://holisticsecurity.io/2020/01/16/building-your-own-affordable-cloud-k8s-to-host-a-service-mesh-data-plane';
      this.page.identifier = 'https://holisticsecurity.io/2020/01/16/building-your-own-affordable-cloud-k8s-to-host-a-service-mesh-data-plane';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://holosec.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript><a class="u-url" href="/2020/01/16/building-your-own-affordable-cloud-k8s-to-host-a-service-mesh-data-plane" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading"><img src="/assets/img/logo-holosec.png" width="40" /> Holistic Security</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Holistic Security</li><li><a class="u-email" href="mailto:blog@holisticsecurity.io">blog@holisticsecurity.io</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/Chilcano"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">Chilcano</span></a></li><li><a href="https://www.linkedin.com/in/Chilcano"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">Chilcano</span></a></li><li><a href="https://www.twitter.com/Chilcano"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">Chilcano</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Systems Thinking, Holism, Trust, Security &amp; Usability.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
