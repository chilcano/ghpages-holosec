---
layout: post
title: MTOM en WSO2 ESB para optimizar la transferencia de datos binarios sobre SOAP
  (Parte 2/2)
date: 2014-05-26 22:02:00.000000000 +02:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Middleware
- SOA
tags:
- Apache Axiom
- Axis2
- MTOM
- SOAP
- soapUI
- SwA
- WSO2 ESB
meta:
  _wpcom_is_markdown: '1'
  _edit_last: '578869'
  geo_public: '0'
  publicize_google_plus_url: https://plus.google.com/113031469837757886298/posts/Amx44L1L9fy
  _wpas_done_5053089: '1'
  _publicize_done_external: a:1:{s:11:"google_plus";a:1:{s:21:"113031469837757886298";b:1;}}
  publicize_twitter_user: Chilcano
  publicize_twitter_url: http://t.co/UleKqszqkg
  _wpas_done_13849: '1'
  publicize_linkedin_url: http://www.linkedin.com/updates?discuss=&scope=6985267&stype=M&topic=5876799257251446784&type=U&a=dO9w
  _wpas_done_5053092: '1'
  _oembed_2305a1f1531893b785434251c904675c: "{{unknown}}"
  _oembed_d809b03794f4995909ba8c2870d396cd: "{{unknown}}"
  _oembed_52fd83150b5288ad7886b82590868eff: "{{unknown}}"
  _oembed_d6b028b255b87c639dd63d55a2da5c62: "{{unknown}}"
  _oembed_c3cf83b2181c32692a7667d447da5307: "{{unknown}}"
  _oembed_50603c212fec58df208c4a33537912bf: "{{unknown}}"
author:
  login: rcarhuatocto
  email: roger@intix.info
  display_name: Roger Carhuatocto
  first_name: ''
  last_name: ''
permalink: "/2014/05/26/mtom-en-wso2-esb-para-optimizar-la-transferencia-de-datos-binarios-sobre-soap-parte-22/"
---
<p><a title="MTOM en WSO2 ESB para optimizar la transferencia de datos binarios sobre SOAP (Parte 1/2)" href="http://holisticsecurity.wordpress.com/2014/05/14/mtom-en-wso2-esb-para-optimizar-la-transferencia-de-datos-binarios-sobre-soap-parte1/">En la anterior entrada</a> explorábamos los beneficios del uso de MTOM en WSO2 ESB, ahora explicaremos cómo integrar esta funcionalidad en nuestras aplicaciones web, es decir, cómo invocar el mismo servicio desde una página web tradicional.</p>
<p><a href="http://holisticsecurity.files.wordpress.com/2014/05/wso2-esb.jpg"><br />
<img class="aligncenter wp-image-1195 size-medium" src="{{ site.baseurl }}/assets/wso2-esb.jpg?w=300" alt="wso2-esb" width="300" height="41" /><br />
</a></p>
<h2>I. Escenario.</h2>
<hr />
<p>Una vez implementado MTOM sobre SOAP empleando WSO2, subir ficheros es sumamente fácil desde SoapUI, pero lo sería también desde un formulario HTML?. Pues, en principio no lo es debido a que ambos implementan maneras diferentes de hacerlo, a pesar de que ambos envían información sobre el mismo protocolo HTTP.</p>
<p>Un formulario HTML envía ficheros sobre HTTP codificándolo en "multipart/form-data", mientras que en el servidor se decodifica. Hay que decirlo, "multipart/form-data" es una especificación nada reciente, es la forma de envio de ficheros más usada equiparable al FTP.</p>
<p>MTOM sobre SOAP, es una especificación relativamente joven, cubre la necesidad de envio de fichero sobre el protocolo SOAP, pero el valor añadido es que el envio es optimizado, esto requiere implementar un cliente SOAP que use MTOM. SoapUI es una buena herramienta de prueba para estos fines, pero dentro de tu proyecto tarde o temprano tendrás que implementar un cliente SOAP con MTOM.</p>
<p>Entonces, sacando ventaja de los mecanismos de mediación que WSO2 ESB ofrece, podríamos crear un Proxy_01 que exponga un servicio de transferencia de fichero usando MTOM y SOAP, luego podríamos crear otro Proxy_02 que nos facilite enviar ficheros desde un formulario HTML. En el fondo el Proxy_02 haría la traducción de "multipart/form-data" a "MTOM".</p>
<p>Si tenemos un cliente MTOM/SOAP que nos permita subir ficheros, lo enviaremos a Proxy_01, pero si tenemos un formulario HTML para subir ficheros, éste apuntará a Proxy_02, que hará la traducción y que luego lo enviará a Proxy_01.</p>
<p>[caption id="attachment_1220" align="aligncenter" width="800"]<a href="http://holisticsecurity.files.wordpress.com/2014/05/wso2esb-mtom-part2-http2soap-01.png"><img class="wp-image-1220 size-large" src="{{ site.baseurl }}/assets/wso2esb-mtom-part2-http2soap-01.png?w=800" alt="HTTP Multipart/form-data a MTOM SOAP en WSO2 ESB" width="800" height="369" /></a> HTTP Multipart/form-data a MTOM SOAP en WSO2 ESB[/caption]</p>
<h2>II. Implementando el escenario.</h2>
<hr />
<p>Para implementar este escenario necesitamos lo siguiente:</p>
<ol>
<li>WSO2 ESB 4.8.1 (<a href="http://wso2.com/products/enterprise-service-bus">http://wso2.com/products/enterprise-service-bus</a>)</li>
<li>Proxy_01, similar al "Sample 51" (<a href="https://docs.wso2.org/pages/viewpage.action?pageId=33136025">MTOM and SwA Optimizations and Request/Response Correlation</a>) desplegado en WSO2 ESB.</li>
<li>Proxy_02 que reciba la petición de envio de fichero codificada en "multipart/form-data" realizada desde un formulario HTML.</li>
<li>El formulario HTML para enviar el fichero.</li>
<li>Modificar la implementación del servicio MTOM SOAP en el lado del Axis2 Server.</li>
</ol>
<p>&nbsp;</p>
<h3>II.1. Proxy_01 para el envio de ficheros usando MTOM y SOAP.</h3>
<hr />
<p>En la anterior entrada implementamos un proxy para el envio de ficheros usando MTOM y SOAP. Entonces, vamos a reutilizar el mismo proxy y añadiremos unos pequeños cambios.Este proxy es un proxy actualizado a partir del proxy publicado en la entrada anterior "<a title="MTOM en WSO2 ESB para optimizar la transferencia de datos binarios sobre SOAP (Parte 1/2)" href="http://holisticsecurity.wordpress.com/2014/05/14/mtom-en-wso2-esb-para-optimizar-la-transferencia-de-datos-binarios-sobre-soap-parte1/">MTOM en WSO2 ESB para optimizar la transferencia de datos binarios sobre SOAP (Parte 1/2)</a>". Sabemos que en el lado servidor tenemos que desplegar la implementación de este servicio para que todo funcione. Más adelante explicaré que es necesario tocar algunas líneas de código.</p>
<p>[sourcecode language="xml" gutter="true" wraplines="false"]<br />
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;<br />
&lt;proxy xmlns=&quot;http://ws.apache.org/ns/synapse&quot;<br />
       name=&quot;MTOMSwASampleService_proxy&quot;<br />
       transports=&quot;https,http&quot;<br />
       statistics=&quot;disable&quot;<br />
       trace=&quot;disable&quot;<br />
       startOnLoad=&quot;true&quot;&gt;<br />
   &lt;target&gt;<br />
      &lt;inSequence&gt;<br />
         &lt;log level=&quot;custom&quot;&gt;<br />
            &lt;property name=&quot;======== Proxy-MTOMSwASampleService&quot; value=&quot;====== inSeq - ini&quot;/&gt;<br />
         &lt;/log&gt;<br />
         &lt;filter source=&quot;get-property('Action')&quot; regex=&quot;urn:oneWayUploadUsingHTTP&quot;&gt;<br />
            &lt;then&gt;<br />
               &lt;log level=&quot;custom&quot;&gt;<br />
                  &lt;property name=&quot;...calling &quot; value=&quot;oneWayUploadUsingHTTP&quot;/&gt;<br />
               &lt;/log&gt;<br />
               &lt;property name=&quot;OUT_ONLY&quot; value=&quot;true&quot;/&gt;<br />
               &lt;property name=&quot;FORCE_SC_ACCEPTED&quot; value=&quot;true&quot; scope=&quot;axis2&quot;/&gt;<br />
               &lt;property name=&quot;example&quot; value=&quot;onewayhttp&quot;/&gt;<br />
               &lt;send&gt;<br />
                  &lt;endpoint&gt;<br />
                     &lt;address uri=&quot;http://localhost:9000/services/MTOMSwASampleService&quot;/&gt;<br />
                  &lt;/endpoint&gt;<br />
               &lt;/send&gt;<br />
            &lt;/then&gt;<br />
            &lt;else/&gt;<br />
         &lt;/filter&gt;<br />
         &lt;filter source=&quot;get-property('Action')&quot; regex=&quot;urn:uploadFileUsingMTOM&quot;&gt;<br />
            &lt;then&gt;<br />
               &lt;log level=&quot;custom&quot;&gt;<br />
                  &lt;property name=&quot;...calling &quot; value=&quot;uploadFileUsingMTOM&quot;/&gt;<br />
               &lt;/log&gt;<br />
               &lt;header name=&quot;Action&quot; scope=&quot;default&quot; action=&quot;remove&quot;/&gt;<br />
               &lt;property name=&quot;SOAPAction&quot; scope=&quot;default&quot; action=&quot;remove&quot;/&gt;<br />
               &lt;property name=&quot;example&quot; value=&quot;mtom&quot;/&gt;<br />
               &lt;property name=&quot;Action&quot; value=&quot;urn:uploadFileUsingMTOM&quot; scope=&quot;default&quot;/&gt;<br />
               &lt;header name=&quot;Action&quot; scope=&quot;default&quot; value=&quot;urn:uploadFileUsingMTOM&quot;/&gt;<br />
               &lt;send&gt;<br />
                  &lt;endpoint&gt;<br />
                     &lt;address uri=&quot;http://localhost:9000/services/MTOMSwASampleService&quot;<br />
                              optimize=&quot;mtom&quot;/&gt;<br />
                  &lt;/endpoint&gt;<br />
               &lt;/send&gt;<br />
            &lt;/then&gt;<br />
            &lt;else/&gt;<br />
         &lt;/filter&gt;<br />
         &lt;filter source=&quot;get-property('Action')&quot; regex=&quot;urn:uploadFileUsingSwA&quot;&gt;<br />
            &lt;then&gt;<br />
               &lt;log level=&quot;custom&quot;&gt;<br />
                  &lt;property name=&quot;...calling &quot; value=&quot;uploadFileUsingSwA&quot;/&gt;<br />
               &lt;/log&gt;<br />
               &lt;property name=&quot;example&quot; value=&quot;swa&quot;/&gt;<br />
               &lt;send&gt;<br />
                  &lt;endpoint&gt;<br />
                     &lt;address uri=&quot;http://localhost:9000/services/MTOMSwASampleService&quot;<br />
                              optimize=&quot;swa&quot;/&gt;<br />
                  &lt;/endpoint&gt;<br />
               &lt;/send&gt;<br />
            &lt;/then&gt;<br />
            &lt;else/&gt;<br />
         &lt;/filter&gt;<br />
         &lt;filter source=&quot;get-property('Action')&quot; regex=&quot;urn:oneWayUploadUsingMTOM&quot;&gt;<br />
            &lt;then&gt;<br />
               &lt;log level=&quot;custom&quot;&gt;<br />
                  &lt;property name=&quot;...calling &quot; value=&quot;oneWayUploadUsingMTOM&quot;/&gt;<br />
               &lt;/log&gt;<br />
               &lt;property name=&quot;OUT_ONLY&quot; value=&quot;true&quot;/&gt;<br />
               &lt;property name=&quot;FORCE_SC_ACCEPTED&quot; value=&quot;true&quot; scope=&quot;axis2&quot;/&gt;<br />
               &lt;property name=&quot;example&quot; value=&quot;onewaymtom&quot;/&gt;<br />
               &lt;send&gt;<br />
                  &lt;endpoint&gt;<br />
                     &lt;address uri=&quot;http://localhost:9000/services/MTOMSwASampleService&quot;<br />
                              optimize=&quot;mtom&quot;/&gt;<br />
                  &lt;/endpoint&gt;<br />
               &lt;/send&gt;<br />
            &lt;/then&gt;<br />
            &lt;else/&gt;<br />
         &lt;/filter&gt;<br />
         &lt;log level=&quot;custom&quot;&gt;<br />
            &lt;property name=&quot;======== Proxy MTOMSwASampleService&quot; value=&quot;====== inSeq - fin&quot;/&gt;<br />
         &lt;/log&gt;<br />
      &lt;/inSequence&gt;<br />
      &lt;outSequence&gt;<br />
         &lt;log level=&quot;custom&quot;&gt;<br />
            &lt;property name=&quot;======== Proxy MTOMSwASampleService&quot; value=&quot;====== outSeq - ini&quot;/&gt;<br />
         &lt;/log&gt;<br />
         &lt;filter source=&quot;get-property('example')&quot; regex=&quot;onewayhttp&quot;&gt;<br />
            &lt;property name=&quot;enableMTOM&quot; value=&quot;true&quot; scope=&quot;axis2&quot;/&gt;<br />
         &lt;/filter&gt;<br />
         &lt;filter source=&quot;get-property('example')&quot; regex=&quot;onewaymtom&quot;&gt;<br />
            &lt;property name=&quot;enableMTOM&quot; value=&quot;true&quot; scope=&quot;axis2&quot;/&gt;<br />
         &lt;/filter&gt;<br />
         &lt;filter source=&quot;get-property('example')&quot; regex=&quot;mtom&quot;&gt;<br />
            &lt;property name=&quot;enableMTOM&quot; value=&quot;true&quot; scope=&quot;axis2&quot;/&gt;<br />
         &lt;/filter&gt;<br />
         &lt;filter source=&quot;get-property('example')&quot; regex=&quot;swa&quot;&gt;<br />
            &lt;property name=&quot;enableSwA&quot; value=&quot;true&quot; scope=&quot;axis2&quot;/&gt;<br />
         &lt;/filter&gt;<br />
         &lt;send/&gt;<br />
         &lt;log level=&quot;custom&quot;&gt;<br />
            &lt;property name=&quot;======== Proxy MTOMSwASampleService&quot; value=&quot;====== outSeq - fin&quot;/&gt;<br />
         &lt;/log&gt;<br />
      &lt;/outSequence&gt;<br />
   &lt;/target&gt;<br />
   &lt;publishWSDL uri=&quot;http://localhost:9000/services/MTOMSwASampleService?wsdl&quot;/&gt;<br />
   &lt;parameter name=&quot;enableMTOM&quot;&gt;true&lt;/parameter&gt;<br />
   &lt;description&gt;MTOMSwASampleService (Sample 51) updated&lt;/description&gt;<br />
&lt;/proxy&gt;<br />
[/sourcecode]</p>
<p>La URL <code>http://localhost:9000</code> representa al Axis2 server, donde desplegamos el servicio. Es Axis2 server que auto-genera el <code>WSDL</code> asociado al backend service.<br />
Es importante iniciar primero el Axis2 server, luego iniciar WSO2 ESB ya que desde el ESB hacemos referencia al <code>WSDL</code> alojado en Axis2 server. Esto es lo que en WSO2 ESB se llamada "WSDL inline".</p>
<p>&nbsp;</p>
<h3>II.2. Proxy_02 que reciba el fichero en "multipart/form-data" y lo envie a Proxy_01.</h3>
<hr />
<p>Aquí básicamente, el Proxy_02 transformará la cabecera y el cuerpo del mensaje para adaptarlo al formato que el Proxy_01 lo necesita.<br />
Evidentemente, deberás conocer cómo "multipart/form-data" y MTOM codifican para implementar este proxy.</p>
<p>[sourcecode language="xml" gutter="true" wraplines="false"]<br />
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;<br />
&lt;proxy xmlns=&quot;http://ws.apache.org/ns/synapse&quot;<br />
       name=&quot;MTOMSwASampleService_http&quot;<br />
       transports=&quot;https,http&quot;<br />
       statistics=&quot;disable&quot;<br />
       trace=&quot;disable&quot;<br />
       startOnLoad=&quot;true&quot;&gt;<br />
   &lt;target&gt;<br />
      &lt;inSequence&gt;<br />
         &lt;log level=&quot;custom&quot;&gt;<br />
            &lt;property name=&quot;****** MTOMSwASampleService - HTTP&quot; value=&quot;***** inSeq - ini&quot;/&gt;<br />
         &lt;/log&gt;<br />
         &lt;property name=&quot;DISABLE_CHUNKING&quot; value=&quot;true&quot;/&gt;<br />
         &lt;property name=&quot;Action&quot; value=&quot;urn:oneWayUploadUsingHTTP&quot; scope=&quot;default&quot;/&gt;<br />
         &lt;header name=&quot;Action&quot; scope=&quot;default&quot; value=&quot;urn:oneWayUploadUsingHTTP&quot;/&gt;<br />
         &lt;send&gt;<br />
            &lt;endpoint&gt;<br />
               &lt;address uri=&quot;http://localhost:8281/services/MTOMSwASampleService_proxy&quot;<br />
                        format=&quot;soap11&quot;/&gt;<br />
            &lt;/endpoint&gt;<br />
         &lt;/send&gt;<br />
         &lt;log level=&quot;custom&quot;&gt;<br />
            &lt;property name=&quot;****** MTOMSwASampleService - HTTP&quot; value=&quot;***** inSeq - fin&quot;/&gt;<br />
         &lt;/log&gt;<br />
      &lt;/inSequence&gt;<br />
      &lt;outSequence&gt;<br />
         &lt;log level=&quot;custom&quot;&gt;<br />
            &lt;property name=&quot;******* MTOMSwASampleService - HTTP&quot; value=&quot;***** outSeq - ini&quot;/&gt;<br />
         &lt;/log&gt;<br />
         &lt;property name=&quot;OUT_ONLY&quot; value=&quot;true&quot;/&gt;<br />
         &lt;property name=&quot;FORCE_SC_ACCEPTED&quot; value=&quot;true&quot;/&gt;<br />
         &lt;send/&gt;<br />
         &lt;log level=&quot;custom&quot;&gt;<br />
            &lt;property name=&quot;******* MTOMSwASampleService - HTTP&quot; value=&quot;***** outSeq - fin&quot;/&gt;<br />
         &lt;/log&gt;<br />
      &lt;/outSequence&gt;<br />
   &lt;/target&gt;<br />
   &lt;description&gt;Proxy Upload File using Multipart Form Data&lt;/description&gt;<br />
&lt;/proxy&gt;<br />
[/sourcecode]</p>
<p>&nbsp;</p>
<h3>II.3. Formulario HTML para el envio de ficheros.</h3>
<hr />
<p>Implementar un formulario de este tipo es muy fácil, sólo hay que usar <code>enctype</code> con el siguiente valor <code>"multipart/form-data"</code>. Tal como se muestra a continuación:</p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
&lt;html&gt;<br />
    &lt;head&gt;<br />
        &lt;title&gt;Sending Binary Data by SOAP with MTOM using WSO2 ESB&lt;/title&gt;<br />
    &lt;/head&gt;<br />
    &lt;body&gt;<br />
        &lt;h2&gt;Sending Binary Data by SOAP with MTOM using WSO2 ESB&lt;/h2&gt;</p>
<p>        &lt;form action=&quot;http://localhost:8283/services/MTOMSwASampleService_http&quot; method=&quot;POST&quot; enctype=&quot;multipart/form-data&quot;&gt;<br />
            Binary file: &lt;input type=&quot;file&quot; name=&quot;myimagefile&quot; size=&quot;50&quot; multiple&gt;<br />
            &lt;br/&gt;<br />
            &lt;input type=&quot;submit&quot; value=&quot;Submit&quot;&gt;<br />
        &lt;/form&gt;</p>
<p>    &lt;/body&gt;<br />
 &lt;/html&gt;<br />
[/sourcecode]</p>
<p>&nbsp;</p>
<p>Las 3 partes a prestar atención aquí son:</p>
<ol>
<li>El <code>Action</code> del form apunta al <code>Proxy_02</code>, asegurarse que el puerto sea el correcto y corresponda al del WSO2 ESB.</li>
<li>El <code>enctype</code> debe indicar la codificación con el que se enviará el fichero.</li>
<li>El <code>input</code> del form es de tipo <code>file</code> y debe tener un nombre, como en este caso <code>myimagefile</code>, con el que podamos luego leerlo para hacer la transformación.</li>
</ol>
<p>Finalmente, recordar que no será necesario un Servidor Web para invocar este formulario HTML, basta con abrir el formulario desde cualquier navegador y elegir el fichero que queremos enviar desde nuestro disco duro.</p>
<p>&nbsp;</p>
<h3>II.4. Modificar el servicio de backend que implementa el envio y recepción de ficheros.</h3>
<hr />
<p>Como indiqué líneas arriba, será necesario actualizar la implementación del servicio de backend del "Sample 51" para nuestro escenario, ya que en principio sólo está preparado para trabajar con MTOM y SwA sobre SOAP.</p>
<p>Lo que haremos es básicamente añadir una nueva operación SOAP que recoja el mensaje y sepa decodificarlo para guardarlo en el lado servidor.</p>
<p>[sourcecode language="java" gutter="true" wraplines="false"]<br />
package samples.services;</p>
<p>import org.apache.axiom.om.OMText;<br />
import org.apache.axiom.om.OMElement;<br />
import org.apache.axiom.om.OMFactory;<br />
import org.apache.axiom.om.OMNamespace;<br />
import org.apache.axiom.util.base64.Base64Utils;<br />
import org.apache.axiom.attachments.Attachments;<br />
import org.apache.axis2.context.MessageContext;<br />
import org.apache.axis2.wsdl.WSDLConstants;</p>
<p>import javax.activation.DataHandler;<br />
import javax.activation.FileDataSource;<br />
import javax.xml.namespace.QName;<br />
import java.io.*;</p>
<p>public class MTOMSwASampleService {</p>
<p>    private static final int BUFFER = 2048;</p>
<p>    public OMElement uploadFileUsingMTOM(OMElement request) throws Exception {</p>
<p>        /*<br />
        &lt;soapenv:Envelope<br />
               xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;<br />
               xmlns:ser=&quot;http://services.samples&quot;&gt;<br />
           &lt;soapenv:Header/&gt;<br />
           &lt;soapenv:Body&gt;<br />
              &lt;ser:uploadFileUsingMTOM&gt;<br />
                 &lt;ser:request&gt;<br />
                    &lt;ser:image&gt;cid:tux-grenade.png&lt;/ser:image&gt;<br />
                 &lt;/ser:request&gt;<br />
              &lt;/ser:uploadFileUsingMTOM&gt;<br />
           &lt;/soapenv:Body&gt;<br />
        &lt;/soapenv:Envelope&gt;<br />
        */</p>
<p>        OMText binaryNode = (OMText) request.<br />
            getFirstChildWithName(new QName(&quot;http://services.samples&quot;, &quot;request&quot;)).<br />
            getFirstChildWithName(new QName(&quot;http://services.samples&quot;, &quot;image&quot;)).<br />
            getFirstOMChild();<br />
        DataHandler dataHandler = (DataHandler) binaryNode.getDataHandler();<br />
        InputStream is = dataHandler.getInputStream();</p>
<p>        File tempFile = File.createTempFile(&quot;mtom-&quot;, &quot;.gif&quot;);<br />
        FileOutputStream fos = new FileOutputStream(tempFile);<br />
        BufferedOutputStream dest = new BufferedOutputStream(fos, BUFFER);</p>
<p>        byte data[] = new byte[BUFFER];<br />
        int count;<br />
        while ((count = is.read(data, 0, BUFFER)) != -1) {<br />
            dest.write(data, 0, count);<br />
        }</p>
<p>        dest.flush();<br />
        dest.close();<br />
        System.out.println(&quot;Wrote MTOM content to temp file : &quot; + tempFile.getAbsolutePath());</p>
<p>        OMFactory factory = request.getOMFactory();<br />
        OMNamespace ns = factory.createOMNamespace(&quot;http://services.samples&quot;, &quot;m0&quot;);<br />
        OMElement payload  = factory.createOMElement(&quot;uploadFileUsingMTOMResponse&quot;, ns);<br />
        OMElement response = factory.createOMElement(&quot;response&quot;, ns);<br />
        OMElement image    = factory.createOMElement(&quot;image&quot;, ns);</p>
<p>        FileDataSource fileDataSource = new FileDataSource(tempFile);<br />
        dataHandler = new DataHandler(fileDataSource);<br />
        OMText textData = factory.createOMText(dataHandler, true);<br />
        image.addChild(textData);<br />
        response.addChild(image);<br />
        payload.addChild(response);</p>
<p>        MessageContext outMsgCtx = MessageContext.getCurrentMessageContext().getOperationContext().getMessageContext(WSDLConstants.MESSAGE_LABEL_OUT_VALUE);<br />
        outMsgCtx.setProperty(<br />
            org.apache.axis2.Constants.Configuration.ENABLE_MTOM,<br />
            org.apache.axis2.Constants.VALUE_TRUE);</p>
<p>        return payload;<br />
    }</p>
<p>    public OMElement uploadFileUsingSwA(OMElement request) throws Exception {</p>
<p>        String imageContentId = request.<br />
            getFirstChildWithName(new QName(&quot;http://services.samples&quot;, &quot;request&quot;)).<br />
            getFirstChildWithName(new QName(&quot;http://services.samples&quot;, &quot;imageId&quot;)).<br />
            getText();</p>
<p>        MessageContext msgCtx   = MessageContext.getCurrentMessageContext();<br />
        Attachments attachment  = msgCtx.getAttachmentMap();<br />
        DataHandler dataHandler = attachment.getDataHandler(imageContentId);<br />
        File tempFile = File.createTempFile(&quot;swa-&quot;, &quot;.gif&quot;);<br />
        FileOutputStream fos = new FileOutputStream(tempFile);<br />
        dataHandler.writeTo(fos);<br />
        fos.flush();<br />
        fos.close();<br />
        System.out.println(&quot;Wrote SwA attachment to temp file : &quot; + tempFile.getAbsolutePath());</p>
<p>        MessageContext outMsgCtx = msgCtx.getOperationContext().getMessageContext(WSDLConstants.MESSAGE_LABEL_OUT_VALUE);<br />
        outMsgCtx.setProperty(<br />
            org.apache.axis2.Constants.Configuration.ENABLE_SWA,<br />
            org.apache.axis2.Constants.VALUE_TRUE);</p>
<p>        OMFactory factory = request.getOMFactory();<br />
        OMNamespace ns = factory.createOMNamespace(&quot;http://services.samples&quot;, &quot;m0&quot;);<br />
        OMElement payload  = factory.createOMElement(&quot;uploadFileUsingSwAResponse&quot;, ns);<br />
        OMElement response = factory.createOMElement(&quot;response&quot;, ns);<br />
        OMElement imageId  = factory.createOMElement(&quot;imageId&quot;, ns);</p>
<p>        FileDataSource fileDataSource = new FileDataSource(tempFile);<br />
        dataHandler = new DataHandler(fileDataSource);<br />
        imageContentId = outMsgCtx.addAttachment(dataHandler);<br />
        imageId.setText(imageContentId);<br />
        response.addChild(imageId);<br />
        payload.addChild(response);</p>
<p>        return payload;<br />
    }</p>
<p>    public void oneWayUploadUsingMTOM(OMElement element) throws Exception {</p>
<p>        /*<br />
        &lt;soapenv:Envelope<br />
               xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;<br />
               xmlns:ser=&quot;http://services.samples&quot;&gt;<br />
           &lt;soapenv:Header/&gt;<br />
           &lt;soapenv:Body&gt;<br />
              &lt;ser:oneWayUploadUsingMTOM&gt;cid:chilcano.jpg&lt;/ser:oneWayUploadUsingMTOM&gt;<br />
           &lt;/soapenv:Body&gt;<br />
        &lt;/soapenv:Envelope&gt;<br />
        */</p>
<p>        OMText binaryNode = (OMText) element.getFirstOMChild();<br />
        System.out.println(&quot;contentID   : &quot; + binaryNode.getContentID() );<br />
        System.out.println(&quot;isBinary    :&quot; + binaryNode.isBinary() );<br />
        System.out.println(&quot;isOptimized :&quot; + binaryNode.isOptimized() );<br />
        DataHandler dataHandler = (DataHandler) binaryNode.getDataHandler();<br />
        InputStream is = dataHandler.getInputStream();</p>
<p>        File tempFile = File.createTempFile(&quot;mtom-&quot;, &quot;.gif&quot;);<br />
        FileOutputStream fos = new FileOutputStream(tempFile);<br />
        BufferedOutputStream dest = new BufferedOutputStream(fos, BUFFER);</p>
<p>        byte data[] = new byte[BUFFER];<br />
        int count;<br />
        while ((count = is.read(data, 0, BUFFER)) != -1) {<br />
            dest.write(data, 0, count);<br />
        }</p>
<p>        dest.flush();<br />
        dest.close();<br />
        System.out.println(&quot;Wrote to file : &quot; + tempFile.getAbsolutePath());<br />
    }</p>
<p>    public void oneWayUploadUsingHTTP(OMElement element) throws Exception {</p>
<p>        /*<br />
        &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;<br />
        &lt;soapenv:Envelope xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;<br />
          &lt;soapenv:Body&gt;<br />
            &lt;mediate&gt;<br />
              &lt;myimagefile&gt;...content in base64...&lt;/myimagefile&gt;<br />
            &lt;/mediate&gt;<br />
          &lt;/soapenv:Body&gt;<br />
        &lt;/soapenv:Envelope&gt;<br />
        */</p>
<p>        String imageContentB64 = element.getFirstElement().getText();<br />
        File tempFile = File.createTempFile(&quot;1wayhttp-&quot;, &quot;.gif&quot;);<br />
        byte[] byteImageContent = Base64Utils.decode(imageContentB64);<br />
        try (OutputStream ostream = new FileOutputStream(tempFile)) {<br />
            ostream.write(byteImageContent);<br />
        }<br />
        System.out.println(&quot;Wrote 1WayHTTP attachment to temp file : &quot; + tempFile.getAbsolutePath());<br />
    }</p>
<p>}</p>
<p>[/sourcecode]</p>
<p>Veréis que he implementado una nueva operación al servicio (método java) llamada <code>oneWayUploadUsingHTTP</code> que recibe como un parámetro de tipo <code>OMElement</code>.</p>
<p>Si deseas añadir más código para efectuar acciones más complejas te recomiendo que crees un proyecto nuevo desde WSO2 Studio haciendo uso de Maven, luego importes esta clase.</p>
<p>&nbsp;</p>
<p>Una vez actualizado, debemos compilarlo y desplegarlo en Axis2 Server. El <code>WSDL</code> será actualizado automáticamente.<br />
Sólo seguir los siguientes pasos:</p>
<ol>
<li>Editar el fichero <code>%ESB_HOME%/samples/axis2Server/src/MTOMSwASampleService/src/samples/servicesMTOMSwASampleService.java</code>, dejarlo como se indica líneas arriba.</li>
<li>Grabar <code>servicesMTOMSwASampleService.java</code> para preservar los cambios.</li>
<li>Desde la línea de comandos, ejecutar ANT para compilar el servicio y desplegarlo en el Axis2 server.</li>
<li>Si todo ha ido bien, iniciemos Axis2 server.</li>
<li>Para verificar que hemos implementado una nueva operación, podemos consultar el actualizado <code>WSDL</code> en la siguiente dirección: <a href="http://localhost:9000/services/MTOMSwASampleService?wsdl">http://localhost:9000/services/MTOMSwASampleService?wsdl</a></li>
</ol>
<p>[sourcecode language="text" gutter="true" wraplines="false"]<br />
Chilcano@Pisc0 $ cd ~/0dev-env/2srv/wso2esb-4.8.1/samples/axis2Server/src/MTOMSwASampleService<br />
Chilcano@Pisc0 $ ant<br />
Buildfile: /Users/Chilcano/0dev-env/2srv/wso2esb-4.8.1/samples/axis2Server/src/MTOMSwASampleService/build.xml</p>
<p>clean:<br />
   [delete] Deleting directory /Users/Chilcano/0dev-env/2srv/wso2esb-4.8.1/samples/axis2Server/src/MTOMSwASampleService/temp</p>
<p>init:<br />
    [mkdir] Created dir: /Users/Chilcano/0dev-env/2srv/wso2esb-4.8.1/samples/axis2Server/src/MTOMSwASampleService/temp<br />
    [mkdir] Created dir: /Users/Chilcano/0dev-env/2srv/wso2esb-4.8.1/samples/axis2Server/src/MTOMSwASampleService/temp/classes</p>
<p>compile-all:<br />
    [javac] /Users/Chilcano/0dev-env/2srv/wso2esb-4.8.1/samples/axis2Server/src/MTOMSwASampleService/build.xml:47: warning: 'includeantruntime' was not set, defaulting to build.sysclasspath=last; set to false for repeatable builds<br />
    [javac] Compiling 1 source file to /Users/Chilcano/0dev-env/2srv/wso2esb-4.8.1/samples/axis2Server/src/MTOMSwASampleService/temp/classes</p>
<p>build-service:<br />
    [mkdir] Created dir: /Users/Chilcano/0dev-env/2srv/wso2esb-4.8.1/samples/axis2Server/src/MTOMSwASampleService/temp/MTOMSwASampleService<br />
    [mkdir] Created dir: /Users/Chilcano/0dev-env/2srv/wso2esb-4.8.1/samples/axis2Server/src/MTOMSwASampleService/temp/MTOMSwASampleService/META-INF<br />
     [copy] Copying 1 file to /Users/Chilcano/0dev-env/2srv/wso2esb-4.8.1/samples/axis2Server/src/MTOMSwASampleService/temp/MTOMSwASampleService/META-INF<br />
     [copy] Copying 1 file to /Users/Chilcano/0dev-env/2srv/wso2esb-4.8.1/samples/axis2Server/src/MTOMSwASampleService/temp/MTOMSwASampleService<br />
      [jar] Building jar: /Users/Chilcano/0dev-env/2srv/wso2esb-4.8.1/samples/axis2Server/repository/services/MTOMSwASampleService.aar</p>
<p>BUILD SUCCESSFUL<br />
Total time: 2 seconds<br />
[/sourcecode]</p>
<p>&nbsp;</p>
<h2>III. Ejecutando todo esto.</h2>
<hr />
<p>Finalmente, después de desplegar satisfactoriamente el servicio de backend, iniciar Axis2 server, iniciar WSO2 ESB, crear Proxy_01 y Proxy_02, estamos a punto de poder ejecutar el form HTML para hacer el upload de un fichero.</p>
<p><a href="http://holisticsecurity.files.wordpress.com/2014/05/wso2esb-mtom-part2-http2soap-02form.png"><img class="aligncenter wp-image-1226 size-large" src="{{ site.baseurl }}/assets/wso2esb-mtom-part2-http2soap-02form.png?w=800" alt="wso2esb-mtom-part2-http2soap-02form" width="800" height="221" /></a></p>
<p>Después del envío de un fichero a través del form HTML, tu verás que en el lado de Axis2 server se recuperará el fichero enviado para guardarlo en el disco del servidor.</p>
<p>[sourcecode language="text" gutter="true" wraplines="false"]<br />
[...]<br />
14/05/26 22:43:07 INFO nhttp.HttpCoreNIOSender: HTTPS Sender starting<br />
14/05/26 22:43:07 INFO nhttp.HttpCoreNIOSender: HTTP Sender starting<br />
14/05/26 22:43:07 INFO jms.JMSSender: JMS Sender started<br />
14/05/26 22:43:07 INFO jms.JMSSender: JMS Transport Sender initialized...<br />
14/05/26 22:43:07 INFO deployment.DeploymentEngine: Deploying Web service: FastStockQuoteService.aar - file:/Users/Chilcano/0dev-env/2srv/wso2esb-4.8.1/samples/axis2Server/repository/services/FastStockQuoteService.aar<br />
14/05/26 22:43:07 INFO deployment.DeploymentEngine: Deploying Web service: LBService1.aar - file:/Users/Chilcano/0dev-env/2srv/wso2esb-4.8.1/samples/axis2Server/repository/services/LBService1.aar<br />
14/05/26 22:43:07 INFO deployment.DeploymentEngine: Deploying Web service: LBService2.aar - file:/Users/Chilcano/0dev-env/2srv/wso2esb-4.8.1/samples/axis2Server/repository/services/LBService2.aar<br />
14/05/26 22:43:07 INFO deployment.DeploymentEngine: Deploying Web service: MTOMSwASampleService.aar - file:/Users/Chilcano/0dev-env/2srv/wso2esb-4.8.1/samples/axis2Server/repository/services/MTOMSwASampleService.aar<br />
14/05/26 22:43:07 INFO deployment.DeploymentEngine: Deploying Web service: ReliableStockQuoteService.aar - file:/Users/Chilcano/0dev-env/2srv/wso2esb-4.8.1/samples/axis2Server/repository/services/ReliableStockQuoteService.aar<br />
14/05/26 22:43:07 INFO deployment.DeploymentEngine: Deploying Web service: SecureStockQuoteService.aar - file:/Users/Chilcano/0dev-env/2srv/wso2esb-4.8.1/samples/axis2Server/repository/services/SecureStockQuoteService.aar<br />
14/05/26 22:43:07 INFO deployment.DeploymentEngine: Deploying Web service: SimpleStockQuoteService.aar - file:/Users/Chilcano/0dev-env/2srv/wso2esb-4.8.1/samples/axis2Server/repository/services/SimpleStockQuoteService.aar<br />
14/05/26 22:43:08 INFO nhttp.HttpCoreNIOListener: HTTPS Listener started on 0:0:0:0:0:0:0:0:9002<br />
14/05/26 22:43:08 INFO nhttp.HttpCoreNIOListener: HTTP Listener started on 0:0:0:0:0:0:0:0:9000<br />
14/05/26 22:43:08 INFO util.SampleAxis2ServerManager: [SimpleAxisServer] Started</p>
<p>Wrote 1WayHTTP attachment to temp file : /Users/Chilcano/0dev-env/2srv/wso2esb-4.8.1/samples/axis2Server/../../tmp/sampleServer/1wayhttp-1767851362396795349.gif<br />
[/sourcecode]</p>
<p>En el lado de WSO2 ESB verás las siguientes trazas:</p>
<p>sourcecode language="text" gutter="true" wraplines="false"]<br />
[...]<br />
[2014-05-25 11:48:59,110] INFO - PassThroughHttpSSLListener Pass-through HTTPS Listener started on 0:0:0:0:0:0:0:0:8246<br />
[2014-05-25 11:48:59,110] INFO - PassThroughHttpListener Starting Pass-through HTTP Listener...<br />
[2014-05-25 11:48:59,112] INFO - PassThroughHttpListener Pass-through HTTP Listener started on 0:0:0:0:0:0:0:0:8283<br />
[2014-05-25 11:48:59,114] INFO - NioSelectorPool Using a shared selector for servlet write/read<br />
[2014-05-25 11:48:59,328] INFO - NioSelectorPool Using a shared selector for servlet write/read<br />
[2014-05-25 11:48:59,343] INFO - RegistryEventingServiceComponent Successfully Initialized Eventing on Registry<br />
[2014-05-25 11:48:59,379] INFO - JMXServerManager JMX Service URL : service:jmx:rmi://localhost:11114/jndi/rmi://localhost:10002/jmxrmi<br />
[2014-05-25 11:48:59,379] INFO - StartupFinalizerServiceComponent Server : WSO2 Enterprise Service Bus-4.8.1<br />
[2014-05-25 11:48:59,380] INFO - StartupFinalizerServiceComponent WSO2 Carbon started in 22 sec<br />
[2014-05-25 11:48:59,599] INFO - CarbonUIServiceComponent Mgt Console URL : https://192.168.56.1:9446/carbon/<br />
[2014-05-25 11:49:06,594] INFO - CarbonAuthenticationUtil 'admin@carbon.super [-1234]' logged in at [2014-05-25 11:49:06,594+0200]<br />
[2014-05-25 11:51:28,952] INFO - ProxyService Building Axis service for Proxy service : MTOMSwASampleService_http<br />
[2014-05-25 11:51:28,952] INFO - ProxyService Adding service MTOMSwASampleService_http to the Axis2 configuration<br />
[2014-05-25 11:51:28,954] INFO - DeploymentInterceptor Deploying Axis2 service: MTOMSwASampleService_http {super-tenant}<br />
[2014-05-25 11:51:28,978] INFO - ProxyService Successfully created the Axis2 service for Proxy service : MTOMSwASampleService_http<br />
[2014-05-26 22:43:51,296] INFO - CarbonAuthenticationUtil 'admin@carbon.super [-1234]' logged in at [2014-05-26 22:43:51,296+0200]</p>
<p>[2014-05-26 22:47:15,938] INFO - LogMediator ****** MTOMSwASampleService - HTTP = ***** inSeq - ini<br />
[2014-05-26 22:47:15,945] INFO - LogMediator ======== Proxy-MTOMSwASampleService = ====== inSeq - ini<br />
[2014-05-26 22:47:15,945] INFO - LogMediator ...calling = oneWayUploadUsingHTTP<br />
[2014-05-26 22:47:15,946] INFO - LogMediator ======== Proxy MTOMSwASampleService = ====== inSeq - fin<br />
[2014-05-26 22:47:15,954] INFO - LogMediator ****** MTOMSwASampleService - HTTP = ***** inSeq - fin<br />
[/sourcecode]</p>
<h2>IV. Conclusiones.</h2>
<hr />
<ul>
<li>Hemos demostrado que WSO2 ESB nos permite transformar tanto la estructura del mensaje como el protocolo de transporte (de HTTP a SOAP) de manera fácil creando únicamente 2 Proxies.</li>
<li>Hemos implementado un patrón de integración llamado <a href="https://docs.wso2.org/display/IntegrationPatterns/Content-Based+Router">Content-Based Router (CBR)</a> todo ello gracias a la capacidades de <code>Mediation</code> de WSO2 ESB.</li>
<li>El uso de MTOM directamente desde un form HTML no es posible, es necesario usar otro proxy que transforme la petición <code>multipart/form-data</code> a MTOM.</li>
</ul>
<p>Espero que os haya servido!.</p>
