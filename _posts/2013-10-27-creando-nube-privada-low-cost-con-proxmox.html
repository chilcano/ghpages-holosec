---
layout: post
title: Creando un nube privada "low cost" con Proxmox VE 3.0
date: 2013-10-27 20:55:47.000000000 +01:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Cloud
- Linux
- PaaS
tags:
- cloud
- Debian Wheezy
- proxmox
- Security
- virtualization
- VM
meta:
  _edit_last: '578869'
  _publicize_pending: '1'
  publicize_google_plus_url: https://plus.google.com/113031469837757886298/posts/STRr7qdzfFd
  _wpas_skip_5053092: '1'
  _wpas_skip_13849: '1'
  _wpas_done_5053089: '1'
  _publicize_done_external: a:1:{s:11:"google_plus";a:1:{s:21:"113031469837757886298";b:1;}}
  publicize_twitter_user: Chilcano
  publicize_twitter_url: http://t.co/gNM6UMhPo6
  _wpas_done_13849: '1'
  publicize_linkedin_url: http://www.linkedin.com/updates?discuss=&scope=6985267&stype=M&topic=5800318765753192448&type=U&a=xuNv
  _wpas_done_5053092: '1'
  _oembed_ef037bba19fe20a213616947b2439f0a: "{{unknown}}"
  _wpas_skip_5053089: '1'
  _wpcom_is_markdown: '1'
  _oembed_661aa119c06dfbcc2822a40e4d5b7ee1: "{{unknown}}"
  _oembed_adf02b33cc4a6f780039410adcfe4b37: "{{unknown}}"
  _oembed_43c71f5a714c32f3a74a7bfa0e4e9e6d: "{{unknown}}"
  _oembed_1be47cc11c5c28fdcd117ffb1d7784ad: "{{unknown}}"
  _oembed_d9ead3663efd7bc8e7af9001d2058262: "{{unknown}}"
  _oembed_34c26e37efbbb401e1e4cae0ccbcbd69: "{{unknown}}"
  _oembed_21415b94957e2eba34f1f93538101ae4: "{{unknown}}"
  _oembed_44ee891678205d76c6072d90412044c8: "{{unknown}}"
  _oembed_c88e4cb33d775077c7bd39f9705c9add: "{{unknown}}"
  _oembed_e8b97e5cacb6c137b850a80889098822: "{{unknown}}"
  _oembed_a2772d98846786d2eacfdc3b273d0a7c: "{{unknown}}"
  _oembed_766bb18171147fea52ab389a0a808ca2: "{{unknown}}"
  _oembed_2ccb4a737c90a9fa5e1fec318869c1d5: "{{unknown}}"
  _oembed_ee2121e0f5f668cb62af0959c03efd2f: "{{unknown}}"
  _oembed_651bfba78a7164ee7151198a8373660a: "{{unknown}}"
  _oembed_c1b12943b080c508d5a2e9fc027a8c66: "{{unknown}}"
  _oembed_95db71f3055f4ebc638504af8bcce884: "{{unknown}}"
  _oembed_86738b66bddc3407c9df1823dcc719b8: "{{unknown}}"
  _oembed_f81cc3a3b0bfd46edcb69da1a674f2ec: "{{unknown}}"
  _oembed_a48a94840549962d300fd915b3566e75: "{{unknown}}"
  _oembed_f87393378fa9498aba79ac6e0692273b: "{{unknown}}"
author:
  login: rcarhuatocto
  email: roger@intix.info
  display_name: Roger CARHUATOCTO
  first_name: ''
  last_name: ''
permalink: "/2013/10/27/creando-nube-privada-low-cost-con-proxmox/"
---
<p>Actualmente existe una oferta muy rica de proveedores de infraestructura o hosting y proveedores de tecnología para sacar el máximo provecho de dicha infraestructura, aún más importante, a un coste razonablemente bajo usando tecnología free y open source.</p>
<p><a href="http://holisticsecurity.files.wordpress.com/2013/10/proxmox-logo.png"><img class=" wp-image-997 alignnone" alt="proxmox-logo" src="{{ site.baseurl }}/assets/proxmox-logo.png" width="175" height="21" /></a></p>
<p>En mi caso, esta infraestructura la usaré para construir una plataforma donde provea servicios alrededor de productos como WSO2 ESB, Liferay Portal, Alfresco ECM, Drupal, etc., para ello he contratado un hosting medianamente decente en Hetzner (repito experiencia) y he empleado Proxmox VE.</p>
<h1>I. Por qué Proxmox VE ?</h1>
<p>Principalmente, porque ya tenía experiencia previa con Proxmox con las versión 2.0 de años anteriores, aunque actualmente hay productos opensource y más sofisticados como Apache CloudStack, OpenStack y Eucalyptus, pero el conocimiento previo y su sencillez me hizo decidir su uso. Una cosa importante a destacar es el corto tiempo necesario para crear un nuevo servidor, por lo general me toma 10 minutos.</p>
<h1>II. Qué servicios ofreceremos desde nuestra nube privada?</h1>
<p>Los servicios ofrecidos estarán alrededor del desarrollo de aplicaciones usando el Stack de WSO2, Liferay Portal, Alfresco ECM, Gestión de Identidades con WSO2 IS, etc. En otras palabras, nuestra nube privada será nuestra plataforma base para desarrollar y explotar nuestras aplicaciones construidas con las anteriores tecnologías mencionadas.</p>
<h1>III. Por qué no usar WSO2 Stratos, RedHat OpenShift u otro PaaS</h1>
<p>Por la naturaleza del tipo de servicios a ofrecer, evidentemente lo mejor era usar algún PaaS stack y la más adecuada era WSO2 Stratos, aunque como indiqué en el punto anterior, el conocimiento previo de Proxmox me hizo decidir como primera opción.</p>
<p>Bueno, una vez puesto mis argumentos, paso a explicar todo el proceso que seguí para tener mi nube privada.</p>
<h1>IV. Defina una arquitectura de virtualización o mapa de VMs</h1>
<p>Sí, es muy importante planear cómo quedará tu nube privada, IPs, Redes Virtuales, DMZ, Storage vs. Partitions, RAM / VM, Security y Firewalling, etc.</p>
<p>Aquí os muestro mi mapa de VMs.</p>
<p>[caption id="" align="alignnone" width="665"]<a href="https://dl.dropboxusercontent.com/u/2961879/blog.sec/blog20131027_privatecloud_proxmox/blog20131027_privatecloud_proxmox_architecture.png"><img class="   " title="A example of Private Cloud Architecture with Proxmox" alt="A example of Private Cloud Architecture with Proxmox" src="{{ site.baseurl }}/assets/blog20131027_privatecloud_proxmox_architecture.png" width="665" height="399" /></a> A example of Private Cloud Architecture with Proxmox[/caption]</p>
<p>Después de planear la arquitectura de tu nube, los siguientes pasos están relacionados a la instalación y post-configuración de tu hosting.</p>
<h1>V. Preparando la infraestructura base</h1>
<p>Algunos requisitos previos:</p>
<ul>
<li>Debian 7.0 (wheezy) o CentOS 6.4</li>
<li>Proxmox VE 3.0</li>
<li>IP pública de tu hosting: 144.76.70.175</li>
<li>Nuevo SSH port: 4141 y 8181</li>
</ul>
<h2>1. Instalar el S.O.</h2>
<ul>
<li>Ir a Robot &gt; Linux y seleccionar Debian 7 - minimal, luego reboot desde ssh:</li>
</ul>
<p>[sourcecode language="html" gutter="true" wraplines="false"]</p>
<h1>shutdown -rf now</h1>
<p>[/sourcecode]</p>
<ul>
<li>Verificar la versión de S.O. por defecto instalada en el Hosting</li>
</ul>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chkry1 ~ # uname -a<br />
Linux chkry1 3.2.0-4-amd64 #1 SMP Debian 3.2.46-1 x86_64 GNU/Linux<br />
[/sourcecode]</p>
<h2>2. Preparación básica del S.O. (Debian Wheezy)</h2>
<p><strong>1) Cambiar password de root</strong></p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chkry1 ~ # passwd root<br />
[/sourcecode]</p>
<p><strong>2) Actualizar Debian</strong></p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chkry1 ~ # apt-get update<br />
[/sourcecode]</p>
<p><strong>3) Renombrar host</strong></p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]</p>
<h1>nano /etc/hostname</h1>
<h1>nano /etc/hosts</h1>
<p>[/sourcecode]</p>
<ul>
<li>Reinicie el servicio</li>
</ul>
<p>[sourcecode language="html" gutter="true" wraplines="false"]</p>
<h1>/etc/init.d/hostname.sh</h1>
<p>[/sourcecode]</p>
<ul>
<li>Verifique los cambios, salga y vuelva a entrar o:</li>
</ul>
<p>[sourcecode language="html" gutter="true" wraplines="false"]</p>
<h1>hostname --fqdn</h1>
<p>[/sourcecode]</p>
<p><strong>4) Cambiar puerto SSH</strong></p>
<ul>
<li>http://ubuntu-tutorials.com/2008/01/12/disabling-ssh-connections-on-ipv6/</li>
</ul>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chkry1 ~ # nano /etc/ssh/sshd_config<br />
[/sourcecode]</p>
<ul>
<li>Reemplazar las líneas 'Port 22' y 'Port 222' por 'Port 4141' y añadir 'AddressFamily inet' (ipv4)</li>
</ul>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chkry1 ~ # service ssh restart<br />
[/sourcecode]</p>
<p><strong>5) Desabilite IPV6</strong></p>
<ul>
<li>http://forums.debian.net/viewtopic.php?f=16&amp;t=85551</li>
<li>
<p>Verificar que realmente este funcionando ipv6</p>
</li>
</ul>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chkry1 ~ # netstat -tunlp |grep p6 |wc -l<br />
 5<br />
[/sourcecode]</p>
<ul>
<li>Actualizar el kernel y hosts para no cargar ipv6</li>
</ul>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chkry1 ~ # echo net.ipv6.conf.all.disable_ipv6=1 &gt; /etc/sysctl.d/disableipv6.conf<br />
root@chkry1 ~ # sed '/::/s/^/#/' /etc/hosts &gt;/etc/dipv6-tmp; cp -a /etc/hosts /etc/hosts-backup &amp;&amp; mv /etc/dipv6-tmp /etc/hosts<br />
[/sourcecode]</p>
<ul>
<li>Al no tener avahi (multi-cast) instalado, no ejecutar esto:</li>
</ul>
<p>[sourcecode language="html" gutter="true" wraplines="true"]<br />
root@chkry1 ~ # sed '/ipv6=yes/s/yes/no/' /etc/avahi/avahi-daemon.conf &gt; /etc/avahi/dipv6-tmp; cp -a /etc/avahi/avahi-daemon.conf /etc/avahi/avahi-daemon.conf-backup &amp;&amp; mv /etc/avahi/dipv6-tmp /etc/avahi/avahi-daemon.conf<br />
[/sourcecode]</p>
<ul>
<li>NTP</li>
</ul>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chkry1 ~ # nano /etc/default/ntp<br />
[/sourcecode]</p>
<p>.. debería quedar así "NTPD_OPTS='-4 -g'", luego reiniciar:</p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]</p>
<h1>service ntp restart</h1>
<p>[/sourcecode]</p>
<ul>
<li>RPCBIND (rpc.statd, rpc.mountd, verificar tambien HTTP)</li>
</ul>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chkry1 ~ # nano /etc/netconfig<br />
[/sourcecode]</p>
<p>dejarlo así:</p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
udp        tpi_clts      v     inet     udp     -       -<br />
tcp        tpi_cots_ord  v     inet     tcp     -       -<br />
#udp6       tpi_clts      v     inet6    udp     -       -<br />
#tcp6       tpi_cots_ord  v     inet6    tcp     -       -<br />
rawip      tpi_raw       -     inet      -      -       -<br />
local      tpi_cots_ord  -     loopback  -      -       -<br />
unix       tpi_cots_ord  -     loopback  -      -       -<br />
[/sourcecode]</p>
<ul>
<li>Quitar la interface eth0 de ipv6</li>
</ul>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chkry1 ~ # nano /etc/network/interfaces<br />
[/sourcecode]</p>
<ul>
<li>Rebootear y probar si ipv6 aún funciona</li>
</ul>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chkry1 ~ # shutdown -rf now</p>
<p>root@chkry1 ~ # netstat -tunlp</p>
<p>Active Internet connections (only servers)<br />
Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name<br />
tcp 0 0 0.0.0.0:4141 0.0.0.0:* LISTEN 2340/sshd<br />
tcp6 0 0 :::4141 :::* LISTEN 2340/sshd<br />
udp 0 0 144.76.70.175:123 0.0.0.0:* 2277/ntpd<br />
udp 0 0 127.0.0.1:123 0.0.0.0:* 2277/ntpd<br />
udp 0 0 0.0.0.0:123 0.0.0.0:* 2277/ntpd<br />
[/sourcecode]</p>
<ul>
<li>Si observa que SSH está en ipv6 corriendo en el puerto 4141 (mi nuevo puerto SSH), si no hay nada de ipv6, pues eso quiere decir que ipv6 ha sido desabilitado.</li>
</ul>
<h2>3. Preparación del S.O. para la instalación de Proxmox VE</h2>
<ul>
<li>http://www.wepoca.net/node/42</li>
</ul>
<li>
<p>Crear una carpeta destinada a alojar los backups (iso, config files, etc.) de PVE (lo haremos desde la Consola Web de Proxmox)</p>
</li>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chkry1 ~ # mkdir -p /datos_pve_backups (lo configuraremos desde PVE Web)<br />
[/sourcecode]</p>
<ul>
<li>Verificar que esté usando GUID Partition Table (no MS-DOS) ya que permite usar más de 2T de disco usando gdisk (fdisk es para otro tipo de FS como MS-DOS) o df -h</li>
</ul>
<li>
<p>http://wiki.hetzner.de/index.php/Partitionsgr%C3%B6%C3%9Fenlimit_bei_gro%C3%9Fen_Festplatten/en</p>
</li>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chkry1 ~ # gdisk -l /dev/sda<br />
GPT fdisk (gdisk) version 0.8.5</p>
<p>Partition table scan:<br />
  MBR: protective<br />
  BSD: not present<br />
  APM: not present<br />
  GPT: present</p>
<p>Found valid GPT with protective MBR; using GPT.<br />
Disk /dev/sda: 5860533168 sectors, 2.7 TiB<br />
Logical sector size: 512 bytes<br />
Disk identifier (GUID): B2B420AE-59BE-44E7-ADCE-EA6EB3EB3C63<br />
Partition table holds up to 128 entries<br />
First usable sector is 34, last usable sector is 5860533134<br />
Partitions will be aligned on 2048-sector boundaries<br />
Total free space is 2014 sectors (1007.0 KiB)</p>
<p>Number  Start (sector)    End (sector)  Size       Code  Name<br />
   1            4096        33558527   16.0 GiB    8200<br />
   2        33558528        34607103   512.0 MiB   8300<br />
   3        34607104      2182090751   1024.0 GiB  8300<br />
   4      2182090752      5860533134   1.7 TiB     8300<br />
   5            2048            4095   1024.0 KiB  EF02<br />
[/sourcecode]</p>
<p>y el otro disco:</p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chkry1 ~ # gdisk -l /dev/sdb<br />
GPT fdisk (gdisk) version 0.8.5</p>
<p>Partition table scan:<br />
  MBR: protective<br />
  BSD: not present<br />
  APM: not present<br />
  GPT: present</p>
<p>Found valid GPT with protective MBR; using GPT.<br />
Disk /dev/sdb: 5860533168 sectors, 2.7 TiB<br />
Logical sector size: 512 bytes<br />
Disk identifier (GUID): 4B205997-E657-433A-8DC7-28B356D3656C<br />
Partition table holds up to 128 entries<br />
First usable sector is 34, last usable sector is 5860533134<br />
Partitions will be aligned on 2048-sector boundaries<br />
Total free space is 2014 sectors (1007.0 KiB)</p>
<p>Number  Start (sector)    End (sector)  Size       Code  Name<br />
   1            4096        33558527   16.0 GiB    FD00<br />
   2        33558528        34607103   512.0 MiB   FD00<br />
   3        34607104      2182090751   1024.0 GiB  FD00<br />
   4      2182090752      5860533134   1.7 TiB     FD00<br />
   5            2048            4095   1024.0 KiB  EF02<br />
[/sourcecode]</p>
<p>y mostrando el disco principal:</p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
S.ficheros                                             Tamaño Usados  Disp Uso% Montado en<br />
rootfs                                                  1016G   260G  705G  27% /<br />
udev                                                      10M      0   10M   0% /dev<br />
tmpfs                                                    3,2G   316K  3,2G   1% /run<br />
/dev/disk/by-uuid/d85c9428-b39f-434c-8140-3e46f0ffe770  1016G   260G  705G  27% /<br />
tmpfs                                                    5,0M      0  5,0M   0% /run/lock<br />
tmpfs                                                    9,5G    22M  9,5G   1% /run/shm<br />
/dev/sda2                                                508M    87M  396M  18% /boot<br />
/dev/sda4                                                1,7T    25G  1,6T   2% /home<br />
/dev/fuse                                                 30M    16K   30M   1% /etc/pve<br />
[/sourcecode]</p>
<ul>
<li>Configurar el idioma:</li>
</ul>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chkry1 ~ # dpkg-reconfigure locales<br />
[/sourcecode]</p>
<ul>
<li>Configurar la zona horaria:</li>
</ul>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chkry1 ~ # dpkg-reconfigure tzdata<br />
[/sourcecode]</p>
<ul>
<li>Para evitar warnings como este:</li>
</ul>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
perl: warning: Setting locale failed.<br />
perl: warning: Please check that your locale settings:<br />
LANGUAGE = (unset),<br />
LC_ALL = (unset),<br />
LC_CTYPE = &quot;UTF-8&quot;,<br />
LANG = &quot;C&quot;<br />
are supported and installed on your system.<br />
[/sourcecode]</p>
<p>.. hay que regenerar los locales:</p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chkry1 ~ # locale-gen es_ES.UTF-8<br />
[/sourcecode]</p>
<p>... o comentar en '/etc/ssh/sshd_config' la siguiente línea 'AcceptEnv LANG LC_*'</p>
<h1>VI. Instalación del software de virtualización</h1>
<h2>4. Instalación de Promox VE</h2>
<ul>
<li>Añadir a la sourcelist de apt lo sgte:</li>
</ul>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chkry1 ~ # echo &quot;deb http://download.proxmox.com/debian wheezy pve&quot; &gt;&gt; /etc/apt/sources.list<br />
root@chkry1 ~ # wget -O- &quot;http://download.proxmox.com/debian/key.asc&quot; | apt-key add -<br />
root@chkry1 ~ # apt-get upgrade<br />
root@chkry1 ~ # aptitude upgrade<br />
root@chkry1 ~ # aptitude full-upgrade<br />
root@chkry1 ~ # aptitude install proxmox-ve-2.6.32</p>
<p>[...]<br />
The following packages have unmet dependencies:<br />
pve-firmware : Conflicts: firmware-linux-free but 3.2 is installed.<br />
Conflicts: firmware-realtek but 0.36+wheezy.1 is installed.<br />
The following actions will resolve these dependencies:</p>
<p>Remove the following packages:<br />
1) firmware-linux-free<br />
2) firmware-realtek</p>
<p>Leave the following dependencies unresolved:<br />
3) linux-image-3.2.0-4-amd64 recommends firmware-linux-free (&gt;= 3~)</p>
<p>Accept this solution? [Y/n/q/?] Y<br />
[/sourcecode]</p>
<p>==&gt;&gt; Postfix configuración =&gt; NO CONFIGURATION<br />
==&gt;&gt; Finalmente se instalará un Apache con PVE web: https://your-server.com:8006</p>
<ul>
<li>Verificar que no esten abiertos puertos de IPV6</li>
</ul>
<p>Basta con comentar los protocolos en /etc/netconfig</p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chkry1 ~ # nano /etc/netconfig<br />
[/sourcecode]</p>
<h1>VII. Post configuración</h1>
<h2>5. Configuración de Redes virtuales con Promox VE</h2>
<p><strong>1) Crear 2 redes virtuales de tipo Bridge desde la consola de Proxmox.</strong></p>
<ul>
<li>Name: vmbr0</li>
<li>IP address: 10.10.10.1</li>
<li>Subnet mask: 255.255.255.0</li>
<li>Autostart: checked</li>
</ul>
<li>
<p>Name: vmbr1</p>
</li>
<li>IP address: 192.168.0.1</li>
<li>Subnet mask: 255.255.255.0</li>
<li>Autostart: checked</li>
<p>Reiniciar para que los cambios sean aplicados.</p>
<ul>
<li>vmbr0, representará mi DMZ y estará NATeada. Publicaremos servidores web, balanceadores, proxies, etc.</li>
<li>vmbr1, representaráuna red privada y aislada de internet, aquí ubicaremos DB servers, LDAP servers, etc.</li>
<li>También es posible hacerlo editando /etc/network/interfaces.</li>
<li>Verificar la existencia de 3 interfaces de red después de reiniciar.</li>
</ul>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chkry1 ~ # ifconfig<br />
eth0 Link encap:Ethernet HWaddr 08:60:6e:68:14:cc<br />
inet addr:144.76.70.175 Bcast:144.76.70.191 Mask:255.255.255.255<br />
UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1<br />
RX packets:67937 errors:0 dropped:2098 overruns:0 frame:0<br />
TX packets:48468 errors:0 dropped:0 overruns:0 carrier:0<br />
collisions:0 txqueuelen:1000<br />
RX bytes:23352396 (22.2 MiB) TX bytes:37412958 (35.6 MiB)<br />
Interrupt:43 Base address:0x2000</p>
<p>lo Link encap:Local Loopback<br />
inet addr:127.0.0.1 Mask:255.0.0.0<br />
UP LOOPBACK RUNNING MTU:16436 Metric:1<br />
RX packets:9141 errors:0 dropped:0 overruns:0 frame:0<br />
TX packets:9141 errors:0 dropped:0 overruns:0 carrier:0<br />
collisions:0 txqueuelen:0<br />
RX bytes:6859893 (6.5 MiB) TX bytes:6859893 (6.5 MiB)</p>
<p>vmbr0 Link encap:Ethernet HWaddr da:ec:a5:7f:fa:59<br />
inet addr:10.10.10.1 Bcast:10.10.10.255 Mask:255.255.255.0<br />
UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1<br />
RX packets:6 errors:0 dropped:0 overruns:0 frame:0<br />
TX packets:0 errors:0 dropped:0 overruns:0 carrier:0<br />
collisions:0 txqueuelen:0<br />
RX bytes:384 (384.0 B) TX bytes:0 (0.0 B)</p>
<p>vmbr1 Link encap:Ethernet HWaddr 52:3d:18:b6:29:0a<br />
inet addr:192.168.0.1 Bcast:192.168.0.255 Mask:255.255.255.0<br />
UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1<br />
RX packets:0 errors:0 dropped:0 overruns:0 frame:0<br />
TX packets:0 errors:0 dropped:0 overruns:0 carrier:0<br />
collisions:0 txqueuelen:0<br />
RX bytes:0 (0.0 B) TX bytes:0 (0.0 B)<br />
[/sourcecode]</p>
<ul>
<li>Por cada VM creada en cualquier subred virtual, aparecerá una nueva interfaz de red virtual:</li>
</ul>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chkry1 ~ # ifconfig</p>
<p>tap100i0 Link encap:Ethernet HWaddr da:ec:a5:7f:fa:59<br />
UP BROADCAST RUNNING PROMISC MULTICAST MTU:1500 Metric:1<br />
RX packets:0 errors:0 dropped:0 overruns:0 frame:0<br />
TX packets:0 errors:0 dropped:0 overruns:0 carrier:0<br />
collisions:0 txqueuelen:500<br />
RX bytes:0 (0.0 B) TX bytes:0 (0.0 B)<br />
[/sourcecode]</p>
<p><strong>2) Verificar y configurar Kernel</strong></p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chkry1 ~ # nano /etc/sysctl.conf</p>
<h3>Hetzner Online AG installimage</h3>
<h1>sysctl config</h1>
<p>net.ipv4.ip_forward=1<br />
net.ipv4.conf.all.rp_filter=1<br />
net.ipv4.icmp_echo_ignore_broadcasts=1<br />
net.ipv4.conf.all.proxy_arp=1<br />
net.ipv4.conf.default.proxy_arp=1<br />
[/sourcecode]</p>
<p><strong>3) Configurar hostname, hosts y DNS</strong></p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
nano /etc/hostname<br />
nano /etc/hosts<br />
nano /etc/resolv.conf (también es posible modificarlos desde Proxmox)<br />
[/sourcecode]</p>
<h2>6.  Seguridad y Firewall</h2>
<p><strong>1) Instalar ShoreWall</strong></p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chkry1 ~ # apt-get install shorewall<br />
[/sourcecode]</p>
<p><strong>2) Configurar ShoreWall para auto-inicio</strong></p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chkry1 ~ # nano /etc/default/shorewall</p>
<p>Cambiar:<br />
    startup = 0<br />
a:<br />
    startup = 1</p>
<p>&lt;strong&gt;3) Continuar configurando ShoreWall&lt;/strong&gt;</p>
<p>[sourcecode language=&quot;html&quot; gutter=&quot;true&quot; wraplines=&quot;false&quot;]<br />
root@chkry1 ~ # nano /etc/shorewall/shorewall.conf<br />
[/sourcecode]</p>
<p>Cambiar:<br />
IP_FORWARDING=Keep<br />
DISABLE_IPV6=No<br />
a:<br />
IP_FORWARDING=On<br />
DISABLE_IPV6=Yes</p>
<p><strong>4) Configurar las Zones en ShoreWall</strong></p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chkry1 ~ # nano /etc/shorewall/zones</p>
<h1>http://linux.die.net/man/5/shorewall-zones</h1>
<p>#ZONE TYPE OPTIONS IN OUT</p>
<h1>OPTIONS OPTIONS</h1>
<p>fw firewall<br />
net ipv4<br />
loc ipv4<br />
dmz ipv4<br />
[/sourcecode]</p>
<p><strong>5) Configurar las Interfaces en ShoreWall</strong></p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chkry1 ~ # nano /etc/shorewall/interfaces</p>
<h1>http://linux.die.net/man/5/shorewall-interfaces</h1>
<p>#ZONE INTERFACE BROADCAST OPTIONS<br />
net eth0 detect logmartians,tcpflags,nosmurfs<br />
dmz vmbr0 detect logmartians,bridge,routefilter<br />
loc vmbr1 detect logmartians,bridge,routefilter<br />
[/sourcecode]</p>
<p><strong>6) Configurar Policy en ShoreWall</strong></p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chkry1 ~ # nano /etc/shorewall/policy</p>
<h1>http://linux.die.net/man/5/shorewall-policy</h1>
<p>#SOURCE   DEST   POLICY   LOG   LEVEL   LIMIT:BURST</p>
<h1>1. fw - loc</h1>
<p>fw        loc    ACCEPT<br />
loc       fw     ACCEPT</p>
<h1>2. fw - dmz</h1>
<p>fw        dmz    ACCEPT<br />
dmz       fw     DROP     info</p>
<h1>3. fw - net</h1>
<p>fw        net    ACCEPT<br />
net       fw     DROP     info</p>
<h1>4. dmz - net</h1>
<p>dmz       net    ACCEPT<br />
net       dmz    DROP     info</p>
<h1>5. loc - dmz</h1>
<p>loc       dmz    ACCEPT<br />
dmz       loc    DROP     info</p>
<h1>6. loc - net</h1>
<p>loc       net    ACCEPT<br />
net       loc    DROP     info</p>
<h1>THE FOLLOWING POLICY MUST BE LAST</h1>
<p>all       all    REJECT   info<br />
[/sourcecode]</p>
<p><strong>7) Configurar las Rules en ShoreWall</strong></p>
<ul>
<li>http://www.shorewall.net/three-interface.htm</li>
</ul>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chkry1 ~ # nano /etc/shorewall/rules</p>
<h1>http://linux.die.net/man/5/shorewall-rules</h1>
<p>#ACTION    SOURCE    DEST   PROTO     DEST     SOURCE    ORIGINAL    RATE</p>
<h1>PORT     PORT(S)   DEST        LIMIT</h1>
<p>#</p>
<h1>Accept particular connections from Internet</h1>
<p>#</p>
<h1>Permit access to SSH port 4646</h1>
<p>##ACCEPT     net       fw     tcp       22      -         -          6/min:5<br />
ACCEPT     net       fw     tcp       8080      -         -          6/min:5<br />
ACCEPT     net       fw     tcp       4646      -         -          6/min:5</p>
<p>#</p>
<h1>Permit access to Proxmox Manager and Console</h1>
<p>ACCEPT     net       fw     tcp       443,5900:5999,8006</p>
<p>#</p>
<h1>PING Rules</h1>
<p>Ping/ACCEPT all      all</p>
<p>#</p>
<h1>Permit traffic to - certain - VMs in DMZ (via DNAT)</h1>
<p>DNAT        net      dmz:$MY_PROXYWEB_IP   tcp    80<br />
DNAT        net      dmz:$MY_PROXYWEB_IP   tcp    443</p>
<p>#</p>
<h1>LAST LINE -- DO NOT REMOVE</h1>
<p>[/sourcecode]</p>
<p><strong>8) Configurar NAT en ShoreWall</strong></p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chkry1 ~ # nano /etc/shorewall/masq</p>
<h1>implements SNAT on vmbr0</h1>
<p>#INTERFACE SOURCE ADDRESS PROTO PORT(S) IPSEC MARK<br />
eth0 10.10.10.0/24<br />
[/sourcecode]</p>
<p><strong>9) Definir la variable o parámetro MY_PROXYWEB_IP</strong></p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chkry1 ~ # nano /etc/shorewall/params</p>
<p>MY_PROXYWEB_IP=10.10.10.11<br />
#LAST LINE -- DO NOT REMOVE<br />
[/sourcecode]</p>
<p><strong>10) Validar y habilitar la configuración de ShoreWall</strong></p>
<p>Es muy útil para probar antes de aplicarlo permanentemente.</p>
<ul>
<li>Verificar la configuración</li>
</ul>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chkry1 ~ # shorewall check<br />
[/sourcecode]</p>
<ul>
<li>Habilitar la configuración de ShoreWall por 120 segundos</li>
</ul>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chkry1 ~ # shorewall try /etc/shorewall 120s<br />
[/sourcecode]</p>
<p><strong>11) Si todo está OK, reiniciar el servidor o Shorewall</strong></p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chkry1 ~ # shorewall stop<br />
root@chkry1 ~ # shorewall start<br />
root@chkry1 ~ # shorewall restart<br />
[/sourcecode]</p>
<h1>VIII. Virtualizando con Proxmox VE</h1>
<h2>7. Crear una primera VM (Proxy Web)</h2>
<p>Previamente hay que descargar una ISO del S.O. de la VM que vamos a crear.</p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chkry1 ~ # cd /var/lib/vz/template/iso/<br />
root@chkry1 /var/lib/vz/template/iso # wget http://ftp.cica.es/CentOS/6.4/isos/x86_64/CentOS-6.4-x86_64-minimal.iso<br />
[/sourcecode]</p>
<p><strong>1) Configurar Red de la VM</strong></p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
[root@chky-apache1 ~]# vi /etc/sysconfig/network-scripts/ifcfg-eth0</p>
<p>DEVICE=&quot;eth0&quot;<br />
HWADDR=0a:98:a1:3b:9a:48<br />
TYPE=Ethernet<br />
ONBOOT=yes<br />
NM_CONTROLLED=&quot;yes&quot;<br />
BOOTPROTO=none<br />
IPADDR=10.10.10.11<br />
PREFIX=24<br />
GATEWAY=10.10.10.1<br />
DNS1=213.133.99.99<br />
IPV6INIT=no<br />
[/sourcecode]</p>
<p><strong>2) Configure default gateway y hostname</strong></p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
[root@soadev1 ~]# vi /etc/sysconfig/network</p>
<p>NETWORKING=yes<br />
HOSTNAME=chky-apache1<br />
GATEWAY=10.10.10.1<br />
[/sourcecode]</p>
<p><strong>3) En el GUEST verificar que la MACs esté asociada a la interface eth0</strong></p>
<p>por ejemplo:</p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
[root@chky-apache1 ~]# nano /etc/udev/rules.d/70-persistent-net.rules</p>
<h1>PCI device 0x8086:0x100e (e1000) (custom name provided by external tool)</h1>
<p>SUBSYSTEM==&quot;net&quot;, ACTION==&quot;add&quot;, DRIVERS==&quot;?<em>&quot;, ATTR{address}==&quot;0a:98:a1:3b:9a:48&quot;, ATTR{type}==&quot;1&quot;, KERNEL==&quot;eth</em>&quot;, NAME=&quot;eth0&quot;<br />
[/sourcecode]</p>
<p><strong>3) Reinicie las interfases de red o la VM</strong></p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
[root@chky-apache1 ~]# /etc/init.d/network restart<br />
[/sourcecode]</p>
<p><strong>4) Instalar Apache</strong></p>
<ul>
<li>http://dev.antoinesolutions.com/apache-server</li>
</ul>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chky-apache1 ~]# yum install httpd<br />
[/sourcecode]</p>
<p><strong>5) Set the apache service to start on boot</strong></p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chky-apache1 ~]# chkconfig --levels 235 httpd on<br />
[/sourcecode]</p>
<p><strong>6) Habilite name-based virtual hosting on port 80 </strong></p>
<p>No es necesario para proxy web:</p>
<p>"Open the httpd configuration file located at /etc/httpd/conf/httpd.conf<br />
Un-comment the line containing the text NameVirtualHost *:80<br />
Save the file"</p>
<p><strong>7) Restart the Apache HTTP Server daemon</strong></p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
root@chky-apache0 ~]# service httpd restart<br />
[/sourcecode]</p>
<ul>
<li>Ignore the "NameVirtualHost *:80 has no VirtualHosts" warning for now.</li>
</ul>
<p><strong>8) Añadir la regla a iptables para aceptar tráfico HTTP</strong></p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
[root@chk-apache1 ~]# nano /etc/sysconfig/iptables<br />
[/sourcecode]</p>
<p>...deberia quedar así:</p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]</p>
<h1>Firewall configuration written by system-config-firewall</h1>
<h1>Manual customization of this file is not recommended.</h1>
<p>*filter<br />
:INPUT ACCEPT [0:0]<br />
:FORWARD ACCEPT [0:0]<br />
:OUTPUT ACCEPT [0:0]<br />
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT<br />
-A INPUT -p icmp -j ACCEPT<br />
-A INPUT -i lo -j ACCEPT<br />
-A INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j ACCEPT<br />
-A INPUT -m state --state NEW -m tcp -p tcp --dport 80 -j ACCEPT<br />
-A INPUT -j REJECT --reject-with icmp-host-prohibited<br />
-A FORWARD -j REJECT --reject-with icmp-host-prohibited<br />
COMMIT<br />
[/sourcecode]</p>
<p><strong>9) Reiniciar iptables</strong></p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
[root@chk-apache1 ~]# /etc/init.d/iptables restart<br />
[/sourcecode]</p>
<p><strong>10) Ahora desde un navegador probar lo sgte:</strong></p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
http://your-server.com<br />
[/sourcecode]</p>
<p><strong>11) Configura Apache HTTP como Proxy Web</strong></p>
<p>Finalmente, deberías configurar este Apache HTTP para que haga de Proxy Web a las otras VM que expongan una interfase HTTP</p>
<h2>8. Crear una segunda VM (Liferay Portal)</h2>
<p>Esta segunda VM será un clone de la primera VM, es posible configurar la RAM, HD, NICs, etc.  fácilmente desde la Consola Web de Proxmox.</p>
<p><strong>1) Instalar Jdk</strong></p>
<ul>
<li>http://wiki.centos.org/HowTos/JavaOnCentOS</li>
</ul>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
[root@chk-lfry1 ~]# yum list &#042;java-1&#042; | grep open</p>
<p>java-1.6.0-openjdk.x86_64 1:1.6.0.0-1.62.1.11.11.90.el6_4 updates<br />
java-1.6.0-openjdk-demo.x86_64 1:1.6.0.0-1.62.1.11.11.90.el6_4 updates<br />
java-1.6.0-openjdk-devel.x86_64 1:1.6.0.0-1.62.1.11.11.90.el6_4 updates<br />
java-1.6.0-openjdk-javadoc.x86_64 1:1.6.0.0-1.62.1.11.11.90.el6_4 updates<br />
java-1.6.0-openjdk-src.x86_64 1:1.6.0.0-1.62.1.11.11.90.el6_4 updates<br />
java-1.7.0-openjdk.x86_64 1:1.7.0.25-2.3.10.4.el6_4 updates<br />
java-1.7.0-openjdk-demo.x86_64 1:1.7.0.25-2.3.10.4.el6_4 updates<br />
java-1.7.0-openjdk-devel.x86_64 1:1.7.0.25-2.3.10.4.el6_4 updates<br />
java-1.7.0-openjdk-javadoc.noarch 1:1.7.0.25-2.3.10.4.el6_4 updates<br />
java-1.7.0-openjdk-src.x86_64 1:1.7.0.25-2.3.10.4.el6_4 updates<br />
[root@chk-lfry1 ~]# yum install java-1.6.0-openjdk.x86_64<br />
[/sourcecode]</p>
<p><strong>2) Verificar instalación de JDK</strong></p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
[root@chky-apache0 ~]# java -version<br />
java version &quot;1.6.0_24&quot;<br />
OpenJDK Runtime Environment (IcedTea6 1.11.11.90) (rhel-1.62.1.11.11.90.el6_4-x86_64)<br />
OpenJDK 64-Bit Server VM (build 20.0-b12, mixed mode)<br />
[/sourcecode]</p>
<p><strong>3) Instalar liferay 6.1.1ga2</strong></p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
[root@chk-lfry1 tempo-files]# wget http://sourceforge.net/projects/lportal/files/Liferay%20Portal/6.1.1%20GA2/liferay-portal-tomcat-6.1.1-ce-ga2-20120731132656558.zip<br />
[/sourcecode]</p>
<p><strong>4) Añadir la regla a iptables para aceptar tráfico HTTP en el puerto 8080, 8009</strong></p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
[root@chk-lfry1 ~]# nano /etc/sysconfig/iptables<br />
[/sourcecode]</p>
<p>...deberia quedar así:</p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]</p>
<h1>Firewall configuration written by system-config-firewall</h1>
<h1>Manual customization of this file is not recommended.</h1>
<p>*filter<br />
:INPUT ACCEPT [0:0]<br />
:FORWARD ACCEPT [0:0]<br />
:OUTPUT ACCEPT [0:0]<br />
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT<br />
-A INPUT -p icmp -j ACCEPT<br />
-A INPUT -i lo -j ACCEPT<br />
-A INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j ACCEPT<br />
-A INPUT -m state --state NEW -m tcp -p tcp --dport 8080 -j ACCEPT<br />
-A INPUT -m state --state NEW -m tcp -p tcp --dport 8009 -j ACCEPT<br />
-A INPUT -j REJECT --reject-with icmp-host-prohibited<br />
-A FORWARD -j REJECT --reject-with icmp-host-prohibited<br />
COMMIT<br />
[/sourcecode]</p>
<p><strong>4) Reiniciar IPtables</strong></p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
[root@chk-lfry1 ~]# /etc/init.d/iptables restart<br />
[/sourcecode]</p>
<h2>9. Crear una tercera VM (MySQL Server)</h2>
<p>De igual forma que la segunda VM, esta tercera VM es, o podría ser, un clone de la primera VM, evidentemente con tamaño de HD diferente, RAM, CPUs/Cores, IP (privada y no en la DMZ), ... unas configuraciones fácilmente de hacerlas a través de la Consola Web de Proxmox.</p>
<ul>
<li>http://dev.antoinesolutions.com/mysql</li>
</ul>
<p><strong>1) Instalar MySQL</strong></p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
[root@chk-mysql1 ~]# yum install mysql-server mysql<br />
[/sourcecode]</p>
<p><strong>2) Hacer que inicie cuando bootee la VM</strong></p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
[root@chk-mysql1 ~]# chkconfig --levels 235 mysqld on<br />
[/sourcecode]</p>
<p><strong>3) Iniciar y acceder a MySQL</strong></p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
service mysqld start<br />
mysql -u root<br />
[/sourcecode]</p>
<ul>
<li>Defina un password para el usuario root para todos los dominios locales:</li>
</ul>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
SET PASSWORD FOR 'root'@'localhost' = PASSWORD('piscosour!!');<br />
SET PASSWORD FOR 'root'@'localhost.localdomain' = PASSWORD('piscosour!!');<br />
SET PASSWORD FOR 'root'@'127.0.0.1' = PASSWORD('piscosour!!');<br />
[/sourcecode]</p>
<ul>
<li>Borre el "any user":</li>
</ul>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
DROP USER ''@'localhost';<br />
DROP USER ''@'localhost.localdomain';<br />
[/sourcecode]</p>
<ul>
<li>Salga de MySQL:</li>
</ul>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
exit<br />
[/sourcecode]</p>
<p><strong>4) Añadir la regla a IPtables para aceptar tráfico MySQL desde chk-lfry1</strong></p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
[root@chk-mysql1 ~]# nano /etc/sysconfig/iptables<br />
[/sourcecode]</p>
<p>...deberia quedar así:</p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]</p>
<h1>Firewall configuration written by system-config-firewall</h1>
<h1>Manual customization of this file is not recommended.</h1>
<p>*filter<br />
:INPUT ACCEPT [0:0]<br />
:FORWARD ACCEPT [0:0]<br />
:OUTPUT ACCEPT [0:0]<br />
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT<br />
-A INPUT -p icmp -j ACCEPT<br />
-A INPUT -i lo -j ACCEPT<br />
-A INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j ACCEPT<br />
-A INPUT -m state --state NEW -m tcp -p tcp --dport 3306 -j ACCEPT<br />
-A INPUT -j REJECT --reject-with icmp-host-prohibited<br />
-A FORWARD -j REJECT --reject-with icmp-host-prohibited<br />
COMMIT<br />
[/sourcecode]</p>
<p><strong>4) Reiniciar iptables</strong></p>
<p>[sourcecode language="html" gutter="true" wraplines="false"]<br />
[root@chk-mysql1 ~]# /etc/init.d/iptables restart<br />
[/sourcecode]</p>
<h2>10. Referencias</h2>
<ul>
<li>
<p>Disabilitar IPV6:  http://forums.debian.net/viewtopic.php?f=16&amp;t=85551</p>
</li>
<li>
<p>Disabilitar SSH sobre IPV6: http://ubuntu-tutorials.com/2008/01/12/disabling-ssh-connections-on-ipv6/</p>
</li>
<li>
<p>Instalar Proxmox en Hetzner EX4 Server: http://www.wepoca.net/node/42</p>
</li>
<li>
<p>Instalar Apache HTTP: http://dev.antoinesolutions.com/apache-server</p>
</li>
<li>
<p>Instalar MySQL: http://dev.antoinesolutions.com/mysql</p>
</li>
</ul>
