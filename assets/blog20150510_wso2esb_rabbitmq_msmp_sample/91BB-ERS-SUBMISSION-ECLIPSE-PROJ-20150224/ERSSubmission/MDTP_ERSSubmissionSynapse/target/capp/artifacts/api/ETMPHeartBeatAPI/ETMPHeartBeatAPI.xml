<?xml version="1.0" encoding="UTF-8"?>
<api xmlns="http://ws.apache.org/ns/synapse" name="ETMPHeartBeatAPI" context="/etmp/status">
    <resource methods="GET" uri-template="/check">
        <inSequence>
            <property name="logmessage" expression="fn:concat('{&quot;label&quot;:&quot;ETMP_DATA_Service_status_request&quot;, ', '&quot;message&quot;:&quot;Data Tier ETMPHeartBeatAPI starts&quot;}')" scope="default" type="STRING" description="log"/>
            <DesLog level="custom">
				<SLTrace service="ETMP-ETMPHeartBeatAPI" expression="get-property('logmessage')"></SLTrace>
			</DesLog>
			<sequence key="ETMPReadPropertiesSequence"/>
			<sequence key="ETMPPrepareRequestSequence"/>
            <send description="send message to ETMP">
                <endpoint name="ETMP_HEART_BEAT_CHECK" template="gov:/templates/ETMP_HEART_BEAT_EP.xml" uri="{system.prop.uk.gov.hmrc.wso2.etmp.ETMP_HEART_BEAT_EP}"/>
            </send>
		</inSequence>
        <outSequence>
            <switch xmlns:m0="http://hmrc.gov.uk/etmp/digitalgateway/heartbeat" source="$body/m0:HeartBeat_response/Status/text()">
                <case regex="OK">
  		            <property name="HTTP_SC" value="200" scope="axis2" type="STRING"></property>
					<property name="logmessage" expression="fn:concat('{&quot;label&quot;:&quot;ETMP_DATA_Service_status_response&quot;, ', '&quot;message&quot;:&quot;Data Tier ETMPHeartBeatAPI outSequence&quot;, ', '&quot;httpStatus&quot;:&quot;200&quot;}')" scope="default" type="STRING" description="log"/>
					<DesLog level="custom">
						<SLTrace service="ETMP-ETMPHeartBeatAPI" expression="get-property('logmessage')"></SLTrace>
					</DesLog>
                </case>
                <default>
  		            <property name="HTTP_SC" value="503" scope="axis2" type="STRING"></property>
					<property name="logmessage" expression="fn:concat('{&quot;label&quot;:&quot;ETMP_DATA_Service_status_response&quot;, ', '&quot;message&quot;:&quot;Data Tier ETMPHeartBeatAPI outSequence&quot;, ', '&quot;httpStatus&quot;:&quot;503&quot;}')" scope="default" type="STRING" description="log"/>
					<DesLog level="custom">
						<SLTrace service="ETMP-ETMPHeartBeatAPI" expression="get-property('logmessage')"></SLTrace>
					</DesLog>
                </default>
            </switch>			
            <switch source="get-property('responseType')">
                <case regex=".*xml">
                    <property name="ContentType" value="application/xml" scope="axis2" type="STRING"/>
                </case>
                <default>
                    <property name="ContentType" value="application/json" scope="axis2" type="STRING"/>
                </default>
            </switch>
			<property name="RESPONSE" value="true" scope="default" type="STRING" description="send response"></property>
			<header name="To" scope="default" action="remove"/>
			<script language="js"><![CDATA[mc.getEnvelope().getBody().getFirstElement().detach();]]></script> 
            <send/>
        </outSequence>
        <faultSequence>
            <property name="logmessage" expression="fn:concat('{&quot;label&quot;:&quot;ETMP_DATA_Service_status_response&quot;, ', '&quot;message&quot;:&quot;Data Tier ETMPHeartBeatAPI faultSequence&quot;, ', '&quot;httpStatus&quot;:&quot;503&quot;}')" scope="default" type="STRING" description="log"/>
            <DesLog level="custom">
				<SLTrace service="ETMP-ETMPHeartBeatAPI" expression="get-property('logmessage')"></SLTrace>
			</DesLog>
            <property name="ERROR_HTTP_SC" value="503" scope="default" type="STRING"/>
			<property name="NO_ENTITY_BODY" value="true" scope="axis2" type="BOOLEAN"/>
            <sequence key="ESBAPIFaultHandler"/>
        </faultSequence>
    </resource>
</api>
